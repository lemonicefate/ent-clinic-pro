{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://astro-clinical-platform.com/schemas/calculator-config.json",
  "title": "醫療計算機配置 Schema",
  "description": "定義醫療計算機模組配置的 JSON Schema",
  "type": "object",
  "required": ["id", "name", "description", "category", "version", "status", "fields", "calculation", "medical", "metadata"],
  "properties": {
    "id": {
      "type": "string",
      "pattern": "^[a-z0-9-]+$",
      "description": "計算機的唯一識別符，只能包含小寫字母、數字和連字符"
    },
    "name": {
      "$ref": "#/$defs/LocalizedString",
      "description": "計算機的顯示名稱"
    },
    "description": {
      "$ref": "#/$defs/LocalizedString",
      "description": "計算機的詳細描述"
    },
    "category": {
      "type": "string",
      "enum": ["cardiology", "endocrinology", "nephrology", "general", "pediatrics", "obstetrics", "template"],
      "description": "計算機所屬的醫療專科分類"
    },
    "version": {
      "type": "string",
      "pattern": "^\\d+\\.\\d+\\.\\d+$",
      "description": "版本號，遵循語義化版本規範"
    },
    "status": {
      "type": "string",
      "enum": ["published", "draft", "deprecated"],
      "description": "計算機的發布狀態"
    },
    "fields": {
      "type": "array",
      "minItems": 1,
      "items": {
        "$ref": "#/$defs/CalculatorField"
      },
      "description": "計算機的輸入欄位定義"
    },
    "calculation": {
      "$ref": "#/$defs/CalculationConfig",
      "description": "計算配置"
    },
    "interpretation": {
      "type": "array",
      "items": {
        "$ref": "#/$defs/InterpretationRule"
      },
      "description": "結果解釋規則"
    },
    "visualization": {
      "$ref": "#/$defs/VisualizationConfig",
      "description": "視覺化配置"
    },
    "medical": {
      "$ref": "#/$defs/MedicalInfo",
      "description": "醫療相關資訊"
    },
    "metadata": {
      "$ref": "#/$defs/Metadata",
      "description": "元資料"
    }
  },
  "$defs": {
    "LocalizedString": {
      "type": "object",
      "required": ["zh-TW"],
      "properties": {
        "zh-TW": {
          "type": "string",
          "minLength": 1
        },
        "en": {
          "type": "string",
          "minLength": 1
        }
      },
      "additionalProperties": false
    },
    "CalculatorField": {
      "type": "object",
      "required": ["id", "type", "label", "required"],
      "properties": {
        "id": {
          "type": "string",
          "pattern": "^[a-zA-Z][a-zA-Z0-9_]*$"
        },
        "type": {
          "type": "string",
          "enum": ["number", "select", "checkbox", "radio", "range"]
        },
        "label": {
          "$ref": "#/$defs/LocalizedString"
        },
        "placeholder": {
          "$ref": "#/$defs/LocalizedString"
        },
        "helpText": {
          "$ref": "#/$defs/LocalizedString"
        },
        "required": {
          "type": "boolean"
        },
        "min": {
          "type": "number"
        },
        "max": {
          "type": "number"
        },
        "step": {
          "type": "number"
        },
        "unit": {
          "type": "string"
        },
        "options": {
          "type": "array",
          "items": {
            "$ref": "#/$defs/FieldOption"
          }
        },
        "conditional": {
          "$ref": "#/$defs/ConditionalRule"
        },
        "validation": {
          "$ref": "#/$defs/ValidationRule"
        }
      },
      "allOf": [
        {
          "if": {
            "properties": {
              "type": {
                "const": "number"
              }
            }
          },
          "then": {
            "properties": {
              "min": true,
              "max": true,
              "step": true,
              "unit": true
            }
          }
        },
        {
          "if": {
            "properties": {
              "type": {
                "enum": ["select", "radio"]
              }
            }
          },
          "then": {
            "required": ["options"],
            "properties": {
              "options": {
                "minItems": 1
              }
            }
          }
        }
      ]
    },
    "FieldOption": {
      "type": "object",
      "required": ["value", "label"],
      "properties": {
        "value": {
          "type": ["string", "number", "boolean"]
        },
        "label": {
          "$ref": "#/$defs/LocalizedString"
        }
      }
    },
    "ConditionalRule": {
      "type": "object",
      "required": ["field", "operator", "value"],
      "properties": {
        "field": {
          "type": "string"
        },
        "operator": {
          "type": "string",
          "enum": ["eq", "ne", "gt", "lt", "gte", "lte"]
        },
        "value": true
      }
    },
    "ValidationRule": {
      "type": "object",
      "properties": {
        "pattern": {
          "type": "string"
        },
        "customValidator": {
          "type": "string"
        },
        "errorMessage": {
          "$ref": "#/$defs/LocalizedString"
        }
      }
    },
    "CalculationConfig": {
      "type": "object",
      "required": ["functionName"],
      "properties": {
        "functionName": {
          "type": "string",
          "pattern": "^[a-zA-Z][a-zA-Z0-9_]*$"
        },
        "validationRules": {
          "type": "object",
          "properties": {
            "required": {
              "type": "array",
              "items": {
                "type": "string"
              }
            },
            "dependencies": {
              "type": "array",
              "items": {
                "type": "object"
              }
            }
          }
        }
      }
    },
    "InterpretationRule": {
      "type": "object",
      "required": ["condition", "level", "message"],
      "properties": {
        "condition": {
          "type": "string"
        },
        "level": {
          "type": "string",
          "enum": ["low", "moderate", "high", "critical"]
        },
        "message": {
          "$ref": "#/$defs/LocalizedString"
        },
        "recommendations": {
          "type": "array",
          "items": {
            "$ref": "#/$defs/LocalizedString"
          }
        }
      }
    },
    "VisualizationConfig": {
      "type": "object",
      "required": ["resultDisplay"],
      "properties": {
        "resultDisplay": {
          "$ref": "#/$defs/ResultDisplay"
        },
        "charts": {
          "type": "array",
          "items": {
            "$ref": "#/$defs/ChartConfig"
          }
        },
        "riskIndicators": {
          "type": "array",
          "items": {
            "$ref": "#/$defs/RiskIndicatorConfig"
          }
        }
      }
    },
    "ResultDisplay": {
      "type": "object",
      "required": ["type", "layout", "components"],
      "properties": {
        "type": {
          "type": "string",
          "enum": ["card", "dashboard", "chart", "gauge"]
        },
        "layout": {
          "type": "string",
          "enum": ["single", "grid", "tabs"]
        },
        "components": {
          "type": "array",
          "items": {
            "$ref": "#/$defs/VisualizationComponent"
          }
        }
      }
    },
    "VisualizationComponent": {
      "type": "object",
      "required": ["id", "type", "position", "config"],
      "properties": {
        "id": {
          "type": "string"
        },
        "type": {
          "type": "string",
          "enum": ["result-card", "risk-indicator", "chart", "gauge", "progress-bar", "comparison-table"]
        },
        "title": {
          "$ref": "#/$defs/LocalizedString"
        },
        "position": {
          "$ref": "#/$defs/ComponentPosition"
        },
        "config": {
          "type": "object"
        }
      }
    },
    "ComponentPosition": {
      "type": "object",
      "required": ["row", "col"],
      "properties": {
        "row": {
          "type": "integer",
          "minimum": 1
        },
        "col": {
          "type": "integer",
          "minimum": 1
        },
        "span": {
          "type": "integer",
          "minimum": 1
        }
      }
    },
    "ChartConfig": {
      "type": "object",
      "required": ["chartType", "dataKey"],
      "properties": {
        "chartType": {
          "type": "string",
          "enum": ["line", "bar", "pie", "doughnut", "radar", "scatter"]
        },
        "dataKey": {
          "type": "string"
        },
        "options": {
          "type": "object"
        },
        "responsive": {
          "type": "boolean",
          "default": true
        },
        "height": {
          "type": "number",
          "minimum": 100
        }
      }
    },
    "RiskIndicatorConfig": {
      "type": "object",
      "required": ["riskKey", "style", "thresholds"],
      "properties": {
        "riskKey": {
          "type": "string"
        },
        "style": {
          "type": "string",
          "enum": ["badge", "progress", "gauge", "traffic-light"]
        },
        "thresholds": {
          "type": "array",
          "items": {
            "$ref": "#/$defs/RiskThreshold"
          }
        }
      }
    },
    "RiskThreshold": {
      "type": "object",
      "required": ["min", "max", "level", "color", "label"],
      "properties": {
        "min": {
          "type": "number"
        },
        "max": {
          "type": "number"
        },
        "level": {
          "type": "string",
          "enum": ["low", "moderate", "high", "critical"]
        },
        "color": {
          "type": "string",
          "pattern": "^#[0-9a-fA-F]{6}$"
        },
        "label": {
          "$ref": "#/$defs/LocalizedString"
        }
      }
    },
    "MedicalInfo": {
      "type": "object",
      "required": ["specialty", "evidenceLevel"],
      "properties": {
        "specialty": {
          "type": "array",
          "items": {
            "type": "string"
          }
        },
        "evidenceLevel": {
          "type": "string",
          "enum": ["A", "B", "C", "D"]
        },
        "references": {
          "type": "array",
          "items": {
            "$ref": "#/$defs/Reference"
          }
        },
        "clinicalGuidelines": {
          "$ref": "#/$defs/LocalizedString"
        }
      }
    },
    "Reference": {
      "type": "object",
      "required": ["title", "authors", "year"],
      "properties": {
        "title": {
          "type": "string"
        },
        "authors": {
          "type": "array",
          "items": {
            "type": "string"
          }
        },
        "journal": {
          "type": "string"
        },
        "year": {
          "type": "integer",
          "minimum": 1900,
          "maximum": 2100
        },
        "url": {
          "type": "string",
          "format": "uri"
        },
        "doi": {
          "type": "string"
        }
      }
    },
    "Metadata": {
      "type": "object",
      "required": ["tags", "difficulty", "lastUpdated", "author"],
      "properties": {
        "tags": {
          "type": "array",
          "items": {
            "type": "string"
          }
        },
        "difficulty": {
          "type": "string",
          "enum": ["basic", "intermediate", "advanced"]
        },
        "lastUpdated": {
          "type": "string",
          "format": "date"
        },
        "author": {
          "type": "string"
        },
        "reviewedBy": {
          "type": "string"
        }
      }
    }
  }
}