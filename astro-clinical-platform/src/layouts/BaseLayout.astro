---
/**
 * 基礎版面配置
 * 提供醫療平台的標準頁面結構
 */

import { ViewTransitions } from 'astro:transitions';
import Header from '../components/layout/Header.astro';
import Footer from '../components/layout/Footer.astro';
import AnalyticsInit from '../components/analytics/AnalyticsInit.astro';
import '../styles/global.css';

export interface Props {
  title?: string;
  description?: string;
  keywords?: string[];
  canonicalUrl?: string;
  ogImage?: string;
  noIndex?: boolean;
  locale?: 'zh-TW' | 'en' | 'ja';
  medicalContent?: boolean;
  pageType?: 'home' | 'calculator' | 'education' | 'search' | 'category';
  contentId?: string;
  specialty?: string;
  breadcrumbs?: Array<{
    label: string;
    href?: string;
  }>;
}

const {
  title = 'Astro Clinical Platform',
  description = '專為醫療專業人員設計的整合式數位平台，結合臨床決策工具和病患衛教功能。',
  keywords = ['醫療平台', '臨床工具', '病患衛教', '醫療計算機'],
  canonicalUrl,
  ogImage = '/images/og-default.jpg',
  noIndex = false,
  locale = 'zh-TW',
  medicalContent = false,
  pageType = 'home',
  contentId,
  specialty,
  breadcrumbs = []
} = Astro.props;

// 生成完整的頁面標題
const fullTitle = title === 'Astro Clinical Platform' 
  ? title 
  : `${title} | Astro Clinical Platform`;

// 獲取當前 URL
const currentUrl = new URL(Astro.request.url);
const canonical = canonicalUrl || currentUrl.href;

// 語言設定
const langMap = {
  'zh-TW': 'zh-TW',
  'en': 'en',
  'ja': 'ja'
};

// 結構化資料
const structuredData = {
  "@context": "https://schema.org",
  "@type": "WebSite",
  "name": "Astro Clinical Platform",
  "description": description,
  "url": canonical,
  "potentialAction": {
    "@type": "SearchAction",
    "target": {
      "@type": "EntryPoint",
      "urlTemplate": `${currentUrl.origin}/search?q={search_term_string}`
    },
    "query-input": "required name=search_term_string"
  }
};

// 醫療內容結構化資料
const medicalStructuredData = medicalContent ? {
  "@context": "https://schema.org",
  "@type": "MedicalWebPage",
  "name": title,
  "description": description,
  "url": canonical,
  "medicalAudience": {
    "@type": "MedicalAudience",
    "audienceType": "HealthcareProfessional"
  },
  "about": {
    "@type": "MedicalCondition",
    "name": title
  }
} : null;
---

<!DOCTYPE html>
<html lang={langMap[locale]} dir="ltr">
  <head>
    <!-- 基本 Meta 標籤 -->
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="generator" content={Astro.generator} />
    
    <!-- SEO Meta 標籤 -->
    <title>{fullTitle}</title>
    <meta name="description" content={description} />
    <meta name="keywords" content={keywords.join(', ')} />
    <link rel="canonical" href={canonical} />
    
    <!-- Robots Meta -->
    {noIndex && <meta name="robots" content="noindex, nofollow" />}
    
    <!-- Open Graph -->
    <meta property="og:type" content="website" />
    <meta property="og:title" content={fullTitle} />
    <meta property="og:description" content={description} />
    <meta property="og:url" content={canonical} />
    <meta property="og:image" content={new URL(ogImage, currentUrl.origin).href} />
    <meta property="og:locale" content={langMap[locale]} />
    <meta property="og:site_name" content="Astro Clinical Platform" />
    
    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content={fullTitle} />
    <meta name="twitter:description" content={description} />
    <meta name="twitter:image" content={new URL(ogImage, currentUrl.origin).href} />
    
    <!-- 醫療內容標記 -->
    {medicalContent && (
      <>
        <meta name="medical-content" content="true" />
        <meta name="health-topics" content={keywords.join(', ')} />
      </>
    )}
    
    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <link rel="manifest" href="/site.webmanifest" />
    
    <!-- 預載入關鍵資源 -->
    <!-- 暫時移除字體預載入，使用系統字體 -->
    
    <!-- DNS 預取 -->
    <link rel="dns-prefetch" href="//plausible.io" />
    
    <!-- Netlify Identity Widget -->
    <script is:inline src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
    
    <!-- 結構化資料 -->
    <script is:inline type="application/ld+json" set:html={JSON.stringify(structuredData)} />
    {medicalStructuredData && (
      <script is:inline type="application/ld+json" set:html={JSON.stringify(medicalStructuredData)} />
    )}
    
    <!-- View Transitions -->
    <ViewTransitions />
    
    <!-- 醫療免責聲明 -->
    {medicalContent && (
      <meta name="medical-disclaimer" content="本內容僅供教育參考，不能取代專業醫療建議。" />
    )}
  </head>
  
  <body class="min-h-screen bg-gray-50 text-gray-900 antialiased">
    <!-- Skip to content link for accessibility -->
    <a 
      href="#main-content" 
      class="sr-only focus:not-sr-only focus:absolute focus:top-4 focus:left-4 focus:z-50 focus:px-4 focus:py-2 focus:bg-medical-primary-600 focus:text-white focus:rounded-lg focus:shadow-lg focus:outline-none focus:ring-2 focus:ring-medical-primary-500 focus:ring-offset-2"
    >
      跳至主要內容
    </a>
    
    <!-- 頁面標頭 -->
    <Header locale={locale} breadcrumbs={breadcrumbs} />
    
    <!-- 主要內容區域 -->
    <main id="main-content" class="flex-1">
      <slot />
    </main>
    
    <!-- 頁面頁尾 -->
    <Footer locale={locale} />
    
    <!-- 醫療免責聲明彈窗 (僅醫療內容) -->
    {medicalContent && (
      <div id="medical-disclaimer" class="hidden fixed inset-0 z-50 bg-black bg-opacity-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-xl max-w-md w-full p-6">
          <div class="flex items-start space-x-3">
            <div class="flex-shrink-0">
              <svg class="h-6 w-6 text-medical-warning-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z" />
              </svg>
            </div>
            <div class="flex-1">
              <h3 class="text-lg font-medium text-gray-900 mb-2">醫療免責聲明</h3>
              <p class="text-sm text-gray-600 mb-4">
                本平台提供的醫療資訊僅供教育和參考用途，不能取代專業醫療建議、診斷或治療。如有健康問題，請諮詢合格的醫療專業人員。
              </p>
              <div class="flex justify-end space-x-3">
                <button 
                  id="disclaimer-accept" 
                  class="btn-primary text-sm"
                  onclick="document.getElementById('medical-disclaimer').classList.add('hidden'); localStorage.setItem('medical-disclaimer-accepted', 'true');"
                >
                  我了解
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    )}
    
    <!-- 分析腳本初始化 -->
    <AnalyticsInit 
      locale={locale}
      medicalContent={medicalContent}
      pageType={pageType}
      contentId={contentId}
      specialty={specialty}
      domain={import.meta.env.PUBLIC_ANALYTICS_DOMAIN}
    />
    
    <!-- 效能監控初始化 -->
    <script type="module" src="/src/scripts/performance-init.js"></script>
    
    <!-- 醫療免責聲明腳本 -->
    {medicalContent && (
      <script is:inline>
        // 檢查是否已接受免責聲明
        if (!localStorage.getItem('medical-disclaimer-accepted')) {
          const disclaimer = document.getElementById('medical-disclaimer');
          if (disclaimer) {
            disclaimer.classList.remove('hidden');
          }
        }
      </script>
    )}
    
    <!-- 無障礙增強腳本 -->
    <script is:inline>
      // 鍵盤導覽增強
      document.addEventListener('keydown', function(e) {
        // Alt + M: 跳至主選單
        if (e.altKey && e.key === 'm') {
          e.preventDefault();
          const nav = document.querySelector('[role="navigation"]');
          if (nav && nav.focus) nav.focus();
        }
        
        // Alt + S: 跳至搜尋
        if (e.altKey && e.key === 's') {
          e.preventDefault();
          const search = document.querySelector('input[type="search"]');
          if (search && search.focus) search.focus();
        }
        
        // Alt + C: 跳至主要內容
        if (e.altKey && e.key === 'c') {
          e.preventDefault();
          const main = document.getElementById('main-content');
          if (main && main.focus) main.focus();
        }
      });
      
      // 焦點管理
      var focusableElements = 'button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])';
      
      // Trap focus in modals
      document.addEventListener('keydown', function(e) {
        if (e.key === 'Tab') {
          var modal = document.querySelector('.modal:not(.hidden)');
          if (modal) {
            var focusable = modal.querySelectorAll(focusableElements);
            var firstFocusable = focusable[0];
            var lastFocusable = focusable[focusable.length - 1];
            
            if (e.shiftKey) {
              if (document.activeElement === firstFocusable) {
                if (lastFocusable && lastFocusable.focus) {
                  lastFocusable.focus();
                  e.preventDefault();
                }
              }
            } else {
              if (document.activeElement === lastFocusable) {
                if (firstFocusable && firstFocusable.focus) {
                  firstFocusable.focus();
                  e.preventDefault();
                }
              }
            }
          }
        }
      });
    </script>
    
    <!-- Mermaid 流程圖初始化 -->
    <script type="module" src="/src/scripts/mermaid-init.js"></script>
  </body>
</html>

<style>
  /* 確保頁面最小高度 */
  html, body {
    height: 100%;
  }
  
  body {
    display: flex;
    flex-direction: column;
  }
  
  main {
    flex: 1;
  }
  
  /* 平滑滾動 */
  html {
    scroll-behavior: smooth;
  }
  
  /* 焦點樣式增強 */
  *:focus {
    outline: 2px solid #3b82f6;
    outline-offset: 2px;
  }
  
  /* 高對比模式支援 */
  @media (prefers-contrast: high) {
    body {
      --tw-bg-opacity: 1;
      background-color: rgb(255 255 255 / var(--tw-bg-opacity));
      --tw-text-opacity: 1;
      color: rgb(0 0 0 / var(--tw-text-opacity));
    }
  }
  
  /* 減少動畫偏好 */
  @media (prefers-reduced-motion: reduce) {
    *,
    *::before,
    *::after {
      animation-duration: 0.01ms !important;
      animation-iteration-count: 1 !important;
      transition-duration: 0.01ms !important;
    }
    
    html {
      scroll-behavior: auto;
    }
  }
  
  /* 列印樣式 */
  @media print {
    .no-print {
      display: none !important;
    }
    
    body {
      background: white !important;
      color: black !important;
    }
    
    a[href]:after {
      content: " (" attr(href) ")";
      font-size: 0.8em;
      color: #666;
    }
    
    .medical-card {
      break-inside: avoid;
    }
  }
</style>