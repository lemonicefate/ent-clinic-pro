---
/**
 * 動態計算機頁面 - 簡化版本
 * 使用新的插件系統展示計算機
 */

import BaseLayout from '../../layouts/BaseLayout.astro';
import PluginCalculator from '../../components/islands/PluginCalculator.tsx';
import type { SupportedLocale } from '../../types/calculator.js';

// 獲取路由參數
const { calculator: calculatorId } = Astro.params;

if (!calculatorId) {
  Astro.response.status = 404;
  return Astro.rewrite('/404');
}

const locale: SupportedLocale = 'zh-TW';

// Define available calculators with their plugin IDs
const availableCalculators = {
  'bmi': 'general.bmi',
  'egfr': 'nephrology.egfr',
  'cha2ds2-vasc': 'cardiology.cha2ds2-vasc'
};

// For SSR mode, we need to add getStaticPaths for dynamic routes
export function getStaticPaths() {
  return [
    { params: { calculator: 'bmi' } },
    { params: { calculator: 'egfr' } },
    { params: { calculator: 'cha2ds2-vasc' } }
  ];
}

// Validate calculator parameter
if (!calculatorId || !availableCalculators[calculatorId]) {
  Astro.response.status = 404;
  return Astro.rewrite('/404');
}

const pluginId = availableCalculators[calculatorId];

// Static plugin metadata for SSG compatibility
const staticPluginData = {
  'general.bmi': {
    name: 'BMI 計算器',
    description: '身體質量指數計算器，用於評估體重狀況和健康風險',
    category: '一般醫學',
    icon: '📋'
  },
  'nephrology.egfr': {
    name: 'eGFR 計算器',
    description: '估算腎絲球過濾率計算器，用於評估腎功能',
    category: '腎臟科',
    icon: '🫘'
  },
  'cardiology.cha2ds2-vasc': {
    name: 'CHA2DS2-VASc 評分',
    description: '評估心房顫動患者中風風險的臨床評分工具',
    category: '心臟科',
    icon: '❤️'
  }
};

const pluginData = staticPluginData[pluginId];

const breadcrumbs = [
  { label: '首頁', href: '/' },
  { label: '醫療工具', href: '/tools' },
  { label: pluginData?.name || '計算器' }
];
---

<BaseLayout 
  title={`${pluginData?.name || '計算器'} | Astro Clinical Platform`}
  description={pluginData?.description || '醫療計算器工具'}
  locale={locale}
  medicalContent={true}
  pageType="calculator"
  breadcrumbs={breadcrumbs}
>
  <style>
    /* 基本的 CSS 樣式 */
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background-color: #f9fafb; color: #111827; line-height: 1.6; }
    .container { max-width: 1200px; margin: 0 auto; padding: 0 1rem; }
    .text-3xl { font-size: 1.875rem; }
    .text-2xl { font-size: 1.5rem; }
    .text-lg { font-size: 1.125rem; }
    .text-sm { font-size: 0.875rem; }
    .text-xs { font-size: 0.75rem; }
    .font-bold { font-weight: 700; }
    .font-semibold { font-weight: 600; }
    .font-medium { font-weight: 500; }
    .text-gray-900 { color: #111827; }
    .text-gray-600 { color: #4b5563; }
    .text-gray-800 { color: #1f2937; }
    .text-blue-600 { color: #2563eb; }
    .text-blue-700 { color: #1d4ed8; }
    .text-blue-800 { color: #1e40af; }
    .text-yellow-600 { color: #ca8a04; }
    .text-yellow-700 { color: #a16207; }
    .text-yellow-800 { color: #92400e; }
    .bg-white { background-color: #ffffff; }
    .bg-gray-50 { background-color: #f9fafb; }
    .bg-gray-100 { background-color: #f3f4f6; }
    .bg-blue-50 { background-color: #eff6ff; }
    .bg-blue-100 { background-color: #dbeafe; }
    .bg-yellow-50 { background-color: #fffbeb; }
    .bg-yellow-200 { background-color: #fde047; }
    .border { border-width: 1px; }
    .border-gray-200 { border-color: #e5e7eb; }
    .border-yellow-200 { border-color: #fde047; }
    .rounded-lg { border-radius: 0.5rem; }
    .rounded-full { border-radius: 9999px; }
    .p-4 { padding: 1rem; }
    .p-6 { padding: 1.5rem; }
    .px-2 { padding-left: 0.5rem; padding-right: 0.5rem; }
    .px-4 { padding-left: 1rem; padding-right: 1rem; }
    .py-1 { padding-top: 0.25rem; padding-bottom: 0.25rem; }
    .py-8 { padding-top: 2rem; padding-bottom: 2rem; }
    .mb-1 { margin-bottom: 0.25rem; }
    .mb-4 { margin-bottom: 1rem; }
    .mb-6 { margin-bottom: 1.5rem; }
    .mb-8 { margin-bottom: 2rem; }
    .mt-1 { margin-top: 0.25rem; }
    .mt-12 { margin-top: 3rem; }
    .mr-2 { margin-right: 0.5rem; }
    .mr-3 { margin-right: 0.75rem; }
    .max-w-2xl { max-width: 42rem; }
    .mx-auto { margin-left: auto; margin-right: auto; }
    .flex { display: flex; }
    .inline-flex { display: inline-flex; }
    .items-center { align-items: center; }
    .space-x-2 > * + * { margin-left: 0.5rem; }
    .space-x-3 > * + * { margin-left: 0.75rem; }
    .w-12 { width: 3rem; }
    .h-12 { height: 3rem; }
    .w-4 { width: 1rem; }
    .h-4 { height: 1rem; }
    .transition-colors { transition-property: color, background-color, border-color; transition-duration: 150ms; }
    .hover\:text-blue-700:hover { color: #1d4ed8; }
    .hover\:bg-blue-700:hover { background-color: #1d4ed8; }
    .hover\:bg-gray-700:hover { background-color: #374151; }
    /* PluginCalculator 需要的額外樣式 */
    .w-full { width: 100%; }
    .w-5 { width: 1.25rem; }
    .h-5 { height: 1.25rem; }
    .block { display: block; }
    .bg-gray-600 { background-color: #4b5563; }
    .bg-blue-600 { background-color: #2563eb; }
    .bg-red-50 { background-color: #fef2f2; }
    .border-gray-300 { border-color: #d1d5db; }
    .border-red-200 { border-color: #fecaca; }
    .border-red-500 { border-color: #ef4444; }
    .rounded-md { border-radius: 0.375rem; }
    .p-3 { padding: 0.75rem; }
    .px-3 { padding-left: 0.75rem; padding-right: 0.75rem; }
    .px-6 { padding-left: 1.5rem; padding-right: 1.5rem; }
    .py-2 { padding-top: 0.5rem; padding-bottom: 0.5rem; }
    .mb-2 { margin-bottom: 0.5rem; }
    .mt-2 { margin-top: 0.5rem; }
    .space-x-4 > * + * { margin-left: 1rem; }
    .space-y-2 > * + * { margin-top: 0.5rem; }
    .space-y-4 > * + * { margin-top: 1rem; }
    .text-white { color: #ffffff; }
    .text-gray-700 { color: #374151; }
    .text-gray-500 { color: #6b7280; }
    .text-green-600 { color: #16a34a; }
    .text-orange-600 { color: #ea580c; }
    .text-red-600 { color: #dc2626; }
    .text-red-700 { color: #b91c1c; }
    .text-red-800 { color: #991b1b; }
    .focus\:outline-none:focus { outline: none; }
    .focus\:ring-2:focus { box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.5); }
    .focus\:ring-blue-500:focus { box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.5); }
    .focus\:ring-gray-500:focus { box-shadow: 0 0 0 2px rgba(107, 114, 128, 0.5); }
    .disabled\:opacity-50:disabled { opacity: 0.5; }
    .disabled\:cursor-not-allowed:disabled { cursor: not-allowed; }
    /* 表單元素樣式 */
    input[type="number"], input[type="text"], select, textarea {
      appearance: none;
      background-color: white;
      border: 1px solid #d1d5db;
      border-radius: 0.375rem;
      padding: 0.5rem 0.75rem;
      font-size: 0.875rem;
      line-height: 1.25rem;
      color: #111827;
      width: 100%;
    }
    input[type="number"]:focus, input[type="text"]:focus, select:focus, textarea:focus {
      outline: none;
      border-color: #3b82f6;
      box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.5);
    }
    input[type="checkbox"] {
      width: 1rem;
      height: 1rem;
      color: #3b82f6;
      background-color: white;
      border: 1px solid #d1d5db;
      border-radius: 0.25rem;
    }
    button {
      cursor: pointer;
      border: none;
      font-weight: 500;
      text-align: center;
      transition: all 0.15s ease-in-out;
    }
    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    a { color: inherit; text-decoration: none; }
    a:hover { text-decoration: underline; }
  </style>
  
  <div class="container mx-auto px-4 py-8">
    <!-- 返回按鈕 -->
    <div class="mb-6">
      <a 
        href="/tools" 
        class="inline-flex items-center text-blue-600 hover:text-blue-700 transition-colors"
      >
        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
        </svg>
        返回工具列表
      </a>
    </div>

    <!-- 頁面標題 -->
    <div class="mb-8">
      <div class="flex items-center space-x-3 mb-4">
        <div class="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center text-2xl">
          {pluginData?.icon || '🧮'}
        </div>
        <div>
          <h1 class="text-3xl font-bold text-gray-900">
            {pluginData?.name || '計算器'}
          </h1>
          <p class="text-gray-600 mt-1">
            {pluginData?.description || '醫療計算器工具'}
          </p>
        </div>
      </div>
      
      <div class="flex items-center space-x-2">
        <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
          {pluginData?.category || '醫療工具'}
        </span>
        <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-gray-100 text-gray-800">
          Plugin ID: {pluginId}
        </span>
      </div>
    </div>

    <!-- 計算器組件 -->
    <div class="max-w-2xl mx-auto">
      <PluginCalculator 
        key={pluginId}
        pluginId={pluginId}
        locale={locale}
        theme="light"
        client:load
      />
    </div>

    <!-- 使用說明 -->
    <div class="mt-12 max-w-2xl mx-auto">
      <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-6">
        <div class="flex">
          <span class="text-yellow-600 mr-3">⚠️</span>
          <div>
            <h3 class="text-sm font-medium text-yellow-800 mb-1">
              重要提醒
            </h3>
            <p class="text-sm text-yellow-700">
              所有計算結果僅供臨床參考，不能取代專業醫師的臨床判斷。請結合患者具體情況和臨床經驗進行綜合評估。
            </p>
          </div>
        </div>
      </div>
    </div>
  </div>
</BaseLayout>