---
// å¯©æ ¸è€…å„€è¡¨æ¿é é¢
// æä¾›å¯©æ ¸è€…å°ˆç”¨çš„å…§å®¹å¯©æ ¸ä»‹é¢

import Layout from '../layouts/Layout.astro';
import PreviewBanner from '../components/PreviewBanner.astro';

const title = 'å¯©æ ¸è€…å„€è¡¨æ¿';
const description = 'é†«ç™‚è¡›æ•™å…§å®¹å¯©æ ¸è€…å°ˆç”¨ä»‹é¢';

// æª¢æŸ¥æ˜¯å¦ç‚ºé è¦½æ¨¡å¼
const isPreview = import.meta.env.PUBLIC_PREVIEW_MODE === 'true';
const prNumber = import.meta.env.PUBLIC_PR_NUMBER;
const branchName = import.meta.env.PUBLIC_BRANCH_NAME;

// æ¨¡æ“¬å¯©æ ¸è³‡æ–™ï¼ˆå¯¦éš›æ‡‰ç”¨ä¸­æœƒå¾ API ç²å–ï¼‰
const mockReviewData = {
  pr: {
    number: prNumber || '123',
    title: 'æ–°å¢å¿ƒæˆ¿é¡«å‹•æ²»ç™‚æŒ‡å—',
    author: 'content-author',
    branch: branchName || 'feature/af-guide',
    status: 'pending_review',
    created_at: '2024-01-30T10:00:00Z',
    updated_at: '2024-01-30T14:30:00Z'
  },
  quality: {
    overall_score: 85,
    level: 'è‰¯å¥½',
    checks: {
      terminology: { status: 'passed', score: 90, issues: 2 },
      accessibility: { status: 'passed', score: 88, issues: 3 },
      readability: { status: 'warning', score: 75, issues: 8 },
      references: { status: 'passed', score: 92, issues: 1 }
    }
  },
  changes: [
    {
      file: 'src/content/education/atrial-fibrillation-guide.md',
      type: 'modified',
      additions: 45,
      deletions: 12,
      specialty: 'cardiology'
    }
  ]
};
---

<Layout title={title} description={description}>
  <PreviewBanner />
  
  <main class="reviewer-dashboard">
    <div class="container">
      <!-- é é¢æ¨™é¡Œ -->
      <header class="dashboard-header">
        <h1>ğŸ‘¥ å¯©æ ¸è€…å„€è¡¨æ¿</h1>
        {isPreview && (
          <div class="preview-indicator">
            <span class="preview-badge">ğŸ” é è¦½æ¨¡å¼</span>
            <span class="pr-info">PR #{mockReviewData.pr.number}</span>
          </div>
        )}
      </header>

      <!-- PR è³‡è¨Šå¡ç‰‡ -->
      <section class="pr-info-card">
        <div class="card-header">
          <h2>ğŸ“‹ PR è³‡è¨Š</h2>
          <div class="status-badge pending">å¾…å¯©æ ¸</div>
        </div>
        
        <div class="pr-details">
          <div class="detail-grid">
            <div class="detail-item">
              <label>PR æ¨™é¡Œ</label>
              <span>{mockReviewData.pr.title}</span>
            </div>
            <div class="detail-item">
              <label>ä½œè€…</label>
              <span>{mockReviewData.pr.author}</span>
            </div>
            <div class="detail-item">
              <label>åˆ†æ”¯</label>
              <span class="branch-name">{mockReviewData.pr.branch}</span>
            </div>
            <div class="detail-item">
              <label>å»ºç«‹æ™‚é–“</label>
              <span id="created-time">{mockReviewData.pr.created_at}</span>
            </div>
          </div>
        </div>
      </section>

      <!-- å“è³ªæª¢æŸ¥æ‘˜è¦ -->
      <section class="quality-summary">
        <div class="card-header">
          <h2>ğŸ“Š å“è³ªæª¢æŸ¥æ‘˜è¦</h2>
          <div class="overall-score">
            <span class="score-value">{mockReviewData.quality.overall_score}</span>
            <span class="score-label">/ 100</span>
          </div>
        </div>
        
        <div class="quality-grid">
          {Object.entries(mockReviewData.quality.checks).map(([key, check]) => (
            <div class={`quality-item ${check.status}`}>
              <div class="quality-icon">
                {key === 'terminology' && 'ğŸ¥'}
                {key === 'accessibility' && 'â™¿'}
                {key === 'readability' && 'ğŸ“–'}
                {key === 'references' && 'ğŸ“š'}
              </div>
              <div class="quality-details">
                <h3>
                  {key === 'terminology' && 'é†«ç™‚è¡“èªæª¢æŸ¥'}
                  {key === 'accessibility' && 'ç„¡éšœç¤™æ€§é©—è­‰'}
                  {key === 'readability' && 'å¯è®€æ€§åˆ†æ'}
                  {key === 'references' && 'åƒè€ƒæ–‡ç»æª¢æŸ¥'}
                </h3>
                <div class="quality-stats">
                  <span class="score">{check.score}/100</span>
                  <span class="issues">{check.issues} å€‹å•é¡Œ</span>
                </div>
              </div>
              <div class={`status-indicator ${check.status}`}>
                {check.status === 'passed' && 'âœ…'}
                {check.status === 'warning' && 'âš ï¸'}
                {check.status === 'failed' && 'âŒ'}
              </div>
            </div>
          ))}
        </div>
      </section>

      <!-- å…§å®¹è®Šæ›´ -->
      <section class="content-changes">
        <div class="card-header">
          <h2>ğŸ“ å…§å®¹è®Šæ›´</h2>
          <button class="view-diff-btn" onclick="toggleDiffView()">
            ğŸ” æŸ¥çœ‹å·®ç•°
          </button>
        </div>
        
        <div class="changes-list">
          {mockReviewData.changes.map((change) => (
            <div class="change-item">
              <div class="file-info">
                <span class="file-icon">ğŸ“„</span>
                <span class="file-path">{change.file}</span>
                <span class={`specialty-tag ${change.specialty}`}>
                  {change.specialty === 'cardiology' && 'å¿ƒè‡Ÿç§‘'}
                </span>
              </div>
              <div class="change-stats">
                <span class="additions">+{change.additions}</span>
                <span class="deletions">-{change.deletions}</span>
              </div>
            </div>
          ))}
        </div>
        
        <div id="diff-view" class="diff-view" style="display: none;">
          <div class="diff-placeholder">
            <p>ğŸ“Š å…§å®¹å·®ç•°æ¯”è¼ƒå°‡åœ¨æ­¤é¡¯ç¤º</p>
            <button onclick="loadDiffContent()">è¼‰å…¥å·®ç•°å…§å®¹</button>
          </div>
        </div>
      </section>

      <!-- é†«ç™‚å¯©æ ¸æ¸…å–® -->
      <section class="medical-review-checklist">
        <div class="card-header">
          <h2>ğŸ¥ é†«ç™‚å…§å®¹å¯©æ ¸æ¸…å–®</h2>
          <div class="progress-indicator">
            <span id="checklist-progress">0/12</span> å®Œæˆ
          </div>
        </div>
        
        <div class="checklist-categories">
          <!-- é†«ç™‚æº–ç¢ºæ€§ -->
          <div class="checklist-category">
            <h3>ğŸ¯ é†«ç™‚æº–ç¢ºæ€§</h3>
            <div class="checklist-items">
              <label class="checklist-item">
                <input type="checkbox" onchange="updateProgress()">
                <span class="checkmark"></span>
                é†«ç™‚è³‡è¨Šç¬¦åˆæœ€æ–°è‡¨åºŠæŒ‡å¼•
              </label>
              <label class="checklist-item">
                <input type="checkbox" onchange="updateProgress()">
                <span class="checkmark"></span>
                è¨ºæ–·å’Œæ²»ç™‚å»ºè­°é©ç•¶ä¸”å®‰å…¨
              </label>
              <label class="checklist-item">
                <input type="checkbox" onchange="updateProgress()">
                <span class="checkmark"></span>
                è—¥ç‰©è³‡è¨Šæº–ç¢ºï¼ˆåŠ‘é‡ã€ç”¨æ³•ã€å‰¯ä½œç”¨ï¼‰
              </label>
              <label class="checklist-item">
                <input type="checkbox" onchange="updateProgress()">
                <span class="checkmark"></span>
                æ²’æœ‰å¯èƒ½é€ æˆèª¤è§£çš„å…§å®¹
              </label>
            </div>
          </div>

          <!-- å…§å®¹å“è³ª -->
          <div class="checklist-category">
            <h3>ğŸ“š å…§å®¹å“è³ª</h3>
            <div class="checklist-items">
              <label class="checklist-item">
                <input type="checkbox" onchange="updateProgress()">
                <span class="checkmark"></span>
                å…§å®¹å®Œæ•´ä¸”é‚è¼¯æ¸…æ™°
              </label>
              <label class="checklist-item">
                <input type="checkbox" onchange="updateProgress()">
                <span class="checkmark"></span>
                èªè¨€è¡¨é”å°ˆæ¥­ä¸”æ˜“æ‡‚
              </label>
              <label class="checklist-item">
                <input type="checkbox" onchange="updateProgress()">
                <span class="checkmark"></span>
                åœ–è¡¨å’Œæ’åœ–é©ç•¶ä¸”æ¸…æ™°
              </label>
              <label class="checklist-item">
                <input type="checkbox" onchange="updateProgress()">
                <span class="checkmark"></span>
                åƒè€ƒæ–‡ç»å……åˆ†ä¸”å¯é 
              </label>
            </div>
          </div>

          <!-- å®‰å…¨æ€§å’Œåˆè¦æ€§ -->
          <div class="checklist-category">
            <h3>ğŸ›¡ï¸ å®‰å…¨æ€§å’Œåˆè¦æ€§</h3>
            <div class="checklist-items">
              <label class="checklist-item">
                <input type="checkbox" onchange="updateProgress()">
                <span class="checkmark"></span>
                åŒ…å«é©ç•¶çš„é†«ç™‚å…è²¬è²æ˜
              </label>
              <label class="checklist-item">
                <input type="checkbox" onchange="updateProgress()">
                <span class="checkmark"></span>
                å¼·èª¿å€‹äººåŒ–é†«ç™‚å»ºè­°çš„é‡è¦æ€§
              </label>
              <label class="checklist-item">
                <input type="checkbox" onchange="updateProgress()">
                <span class="checkmark"></span>
                æé†’è®€è€…è«®è©¢å°ˆæ¥­é†«å¸«
              </label>
              <label class="checklist-item">
                <input type="checkbox" onchange="updateProgress()">
                <span class="checkmark"></span>
                ç¬¦åˆé†«ç™‚å»£å‘Šç›¸é—œæ³•è¦
              </label>
            </div>
          </div>
        </div>
      </section>

      <!-- å¯©æ ¸æ„è¦‹ -->
      <section class="review-comments">
        <div class="card-header">
          <h2>ğŸ’¬ å¯©æ ¸æ„è¦‹</h2>
        </div>
        
        <div class="comment-form">
          <textarea 
            id="review-textarea" 
            placeholder="è«‹è¼¸å…¥æ‚¨çš„å¯©æ ¸æ„è¦‹å’Œå»ºè­°..."
            rows="6"
          ></textarea>
          
          <div class="comment-actions">
            <div class="review-type">
              <label>
                <input type="radio" name="review-type" value="approve" checked>
                âœ… æ‰¹å‡†è®Šæ›´
              </label>
              <label>
                <input type="radio" name="review-type" value="request-changes">
                ğŸ“ è¦æ±‚ä¿®æ”¹
              </label>
              <label>
                <input type="radio" name="review-type" value="comment">
                ğŸ’¬ åƒ…è©•è«–
              </label>
            </div>
            
            <div class="action-buttons">
              <button class="btn secondary" onclick="saveDraft()">
                ğŸ’¾ å„²å­˜è‰ç¨¿
              </button>
              <button class="btn primary" onclick="submitReview()">
                ğŸš€ æäº¤å¯©æ ¸
              </button>
            </div>
          </div>
        </div>
      </section>

      <!-- å¿«é€Ÿæ“ä½œ -->
      <section class="quick-actions">
        <div class="action-grid">
          <a href="/preview-info" class="action-card">
            <div class="action-icon">ğŸ“Š</div>
            <div class="action-content">
              <h3>é è¦½è³‡è¨Š</h3>
              <p>æŸ¥çœ‹è©³ç´°çš„é è¦½ç’°å¢ƒè³‡è¨Š</p>
            </div>
          </a>
          
          <a href="/admin" class="action-card">
            <div class="action-icon">âš™ï¸</div>
            <div class="action-content">
              <h3>CMS ç®¡ç†</h3>
              <p>é€²å…¥å…§å®¹ç®¡ç†ç³»çµ±</p>
            </div>
          </a>
          
          <a href="/education" class="action-card">
            <div class="action-icon">ğŸ“š</div>
            <div class="action-content">
              <h3>è¡›æ•™å…§å®¹</h3>
              <p>ç€è¦½æ‰€æœ‰è¡›æ•™æ–‡ç« </p>
            </div>
          </a>
          
          <a href={`https://github.com/your-org/astro-clinical-platform/pull/${prNumber}`} 
             class="action-card" target="_blank" rel="noopener">
            <div class="action-icon">ğŸ”—</div>
            <div class="action-content">
              <h3>GitHub PR</h3>
              <p>åœ¨ GitHub ä¸ŠæŸ¥çœ‹ PR</p>
            </div>
          </a>
        </div>
      </section>
    </div>
  </main>
</Layout>

<style>
  .reviewer-dashboard {
    min-height: 100vh;
    background: #f8f9fa;
    padding: 20px 0;
  }
  
  .container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 0 20px;
  }
  
  .dashboard-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 30px;
    padding-bottom: 20px;
    border-bottom: 2px solid #e9ecef;
  }
  
  .dashboard-header h1 {
    margin: 0;
    color: #212529;
    font-size: 2.5rem;
  }
  
  .preview-indicator {
    display: flex;
    align-items: center;
    gap: 10px;
  }
  
  .preview-badge {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 6px 12px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: bold;
  }
  
  .pr-info {
    font-family: monospace;
    background: #f8f9fa;
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 12px;
  }
  
  /* å¡ç‰‡æ¨£å¼ */
  .pr-info-card,
  .quality-summary,
  .content-changes,
  .medical-review-checklist,
  .review-comments,
  .quick-actions {
    background: white;
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    margin-bottom: 24px;
    overflow: hidden;
  }
  
  .card-header {
    background: #f8f9fa;
    padding: 20px 24px;
    border-bottom: 1px solid #e9ecef;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  
  .card-header h2 {
    margin: 0;
    color: #495057;
    font-size: 1.25rem;
  }
  
  /* PR è³‡è¨Š */
  .status-badge {
    padding: 4px 12px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: bold;
  }
  
  .status-badge.pending {
    background: #fff3cd;
    color: #856404;
  }
  
  .pr-details {
    padding: 24px;
  }
  
  .detail-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 20px;
  }
  
  .detail-item {
    display: flex;
    flex-direction: column;
    gap: 4px;
  }
  
  .detail-item label {
    font-size: 12px;
    color: #6c757d;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }
  
  .detail-item span {
    font-size: 14px;
    color: #212529;
  }
  
  .branch-name {
    font-family: monospace;
    background: #f8f9fa;
    padding: 2px 6px;
    border-radius: 4px;
  }
  
  /* å“è³ªæª¢æŸ¥ */
  .overall-score {
    display: flex;
    align-items: baseline;
    gap: 4px;
  }
  
  .score-value {
    font-size: 2rem;
    font-weight: bold;
    color: #28a745;
  }
  
  .score-label {
    color: #6c757d;
    font-size: 1rem;
  }
  
  .quality-grid {
    padding: 24px;
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 16px;
  }
  
  .quality-item {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 16px;
    border-radius: 8px;
    border: 1px solid #e9ecef;
    transition: all 0.2s ease;
  }
  
  .quality-item:hover {
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
  }
  
  .quality-item.passed {
    border-left: 4px solid #28a745;
  }
  
  .quality-item.warning {
    border-left: 4px solid #ffc107;
  }
  
  .quality-item.failed {
    border-left: 4px solid #dc3545;
  }
  
  .quality-icon {
    font-size: 1.5rem;
  }
  
  .quality-details {
    flex: 1;
  }
  
  .quality-details h3 {
    margin: 0 0 4px 0;
    font-size: 14px;
    color: #212529;
  }
  
  .quality-stats {
    display: flex;
    gap: 12px;
    font-size: 12px;
    color: #6c757d;
  }
  
  .status-indicator {
    font-size: 1.2rem;
  }
  
  /* å…§å®¹è®Šæ›´ */
  .view-diff-btn {
    background: #007bff;
    color: white;
    border: none;
    padding: 6px 12px;
    border-radius: 6px;
    font-size: 12px;
    cursor: pointer;
    transition: background 0.2s ease;
  }
  
  .view-diff-btn:hover {
    background: #0056b3;
  }
  
  .changes-list {
    padding: 24px;
  }
  
  .change-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px 0;
    border-bottom: 1px solid #f1f3f4;
  }
  
  .change-item:last-child {
    border-bottom: none;
  }
  
  .file-info {
    display: flex;
    align-items: center;
    gap: 8px;
  }
  
  .file-path {
    font-family: monospace;
    font-size: 13px;
    color: #495057;
  }
  
  .specialty-tag {
    background: #e3f2fd;
    color: #1976d2;
    padding: 2px 8px;
    border-radius: 12px;
    font-size: 11px;
    font-weight: 500;
  }
  
  .change-stats {
    display: flex;
    gap: 8px;
    font-family: monospace;
    font-size: 12px;
  }
  
  .additions {
    color: #28a745;
  }
  
  .deletions {
    color: #dc3545;
  }
  
  .diff-view {
    border-top: 1px solid #e9ecef;
    padding: 24px;
    background: #f8f9fa;
  }
  
  .diff-placeholder {
    text-align: center;
    padding: 40px;
    color: #6c757d;
  }
  
  /* å¯©æ ¸æ¸…å–® */
  .progress-indicator {
    font-size: 14px;
    color: #6c757d;
  }
  
  .checklist-categories {
    padding: 24px;
  }
  
  .checklist-category {
    margin-bottom: 24px;
  }
  
  .checklist-category h3 {
    margin: 0 0 12px 0;
    color: #495057;
    font-size: 1.1rem;
  }
  
  .checklist-items {
    display: flex;
    flex-direction: column;
    gap: 8px;
  }
  
  .checklist-item {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 8px 0;
    cursor: pointer;
    transition: background 0.2s ease;
  }
  
  .checklist-item:hover {
    background: #f8f9fa;
    border-radius: 4px;
    padding-left: 8px;
  }
  
  .checklist-item input[type="checkbox"] {
    width: 18px;
    height: 18px;
    accent-color: #28a745;
  }
  
  .checkmark {
    font-size: 14px;
    color: #495057;
  }
  
  /* å¯©æ ¸æ„è¦‹ */
  .comment-form {
    padding: 24px;
  }
  
  #review-textarea {
    width: 100%;
    padding: 12px;
    border: 1px solid #ced4da;
    border-radius: 6px;
    font-family: inherit;
    font-size: 14px;
    line-height: 1.5;
    resize: vertical;
    margin-bottom: 16px;
  }
  
  #review-textarea:focus {
    outline: none;
    border-color: #007bff;
    box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.25);
  }
  
  .comment-actions {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 20px;
  }
  
  .review-type {
    display: flex;
    gap: 16px;
  }
  
  .review-type label {
    display: flex;
    align-items: center;
    gap: 6px;
    font-size: 14px;
    cursor: pointer;
  }
  
  .action-buttons {
    display: flex;
    gap: 12px;
  }
  
  .btn {
    padding: 8px 16px;
    border: none;
    border-radius: 6px;
    font-size: 14px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s ease;
  }
  
  .btn.primary {
    background: #007bff;
    color: white;
  }
  
  .btn.primary:hover {
    background: #0056b3;
  }
  
  .btn.secondary {
    background: #6c757d;
    color: white;
  }
  
  .btn.secondary:hover {
    background: #545b62;
  }
  
  /* å¿«é€Ÿæ“ä½œ */
  .action-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 16px;
    padding: 24px;
  }
  
  .action-card {
    display: flex;
    align-items: center;
    gap: 16px;
    padding: 20px;
    border: 1px solid #e9ecef;
    border-radius: 8px;
    text-decoration: none;
    color: inherit;
    transition: all 0.2s ease;
  }
  
  .action-card:hover {
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    transform: translateY(-2px);
    text-decoration: none;
    color: inherit;
  }
  
  .action-icon {
    font-size: 2rem;
  }
  
  .action-content h3 {
    margin: 0 0 4px 0;
    font-size: 1rem;
    color: #212529;
  }
  
  .action-content p {
    margin: 0;
    font-size: 14px;
    color: #6c757d;
  }
  
  /* éŸ¿æ‡‰å¼è¨­è¨ˆ */
  @media (max-width: 768px) {
    .dashboard-header {
      flex-direction: column;
      gap: 16px;
      align-items: flex-start;
    }
    
    .dashboard-header h1 {
      font-size: 2rem;
    }
    
    .detail-grid {
      grid-template-columns: 1fr;
    }
    
    .quality-grid {
      grid-template-columns: 1fr;
    }
    
    .comment-actions {
      flex-direction: column;
      align-items: stretch;
    }
    
    .review-type {
      justify-content: space-between;
    }
    
    .action-buttons {
      justify-content: stretch;
    }
    
    .btn {
      flex: 1;
    }
  }
</style>

<script>
  // æ›´æ–°é€²åº¦æŒ‡ç¤ºå™¨
  function updateProgress() {
    const checkboxes = document.querySelectorAll('.checklist-item input[type="checkbox"]');
    const checked = document.querySelectorAll('.checklist-item input[type="checkbox"]:checked');
    const progress = document.getElementById('checklist-progress');
    
    if (progress) {
      progress.textContent = `${checked.length}/${checkboxes.length}`;
    }
  }
  
  // åˆ‡æ›å·®ç•°è¦–åœ–
  function toggleDiffView() {
    const diffView = document.getElementById('diff-view');
    const button = document.querySelector('.view-diff-btn');
    
    if (diffView.style.display === 'none') {
      diffView.style.display = 'block';
      button.textContent = 'ğŸ”¼ éš±è—å·®ç•°';
    } else {
      diffView.style.display = 'none';
      button.textContent = 'ğŸ” æŸ¥çœ‹å·®ç•°';
    }
  }
  
  // è¼‰å…¥å·®ç•°å…§å®¹
  function loadDiffContent() {
    const placeholder = document.querySelector('.diff-placeholder');
    placeholder.innerHTML = '<p>ğŸ“Š è¼‰å…¥ä¸­...</p>';
    
    // æ¨¡æ“¬è¼‰å…¥å·®ç•°å…§å®¹
    setTimeout(() => {
      placeholder.innerHTML = `
        <div class="diff-content">
          <h4>ğŸ“„ src/content/education/atrial-fibrillation-guide.md</h4>
          <div class="diff-lines">
            <div class="diff-line added">+ ## æ–°å¢ç« ç¯€ï¼šé é˜²æªæ–½</div>
            <div class="diff-line added">+ é é˜²å¿ƒæˆ¿é¡«å‹•çš„æ–¹æ³•åŒ…æ‹¬...</div>
            <div class="diff-line removed">- èˆŠçš„å…§å®¹å·²è¢«ç§»é™¤</div>
            <div class="diff-line unchanged">  ä¿æŒä¸è®Šçš„å…§å®¹</div>
          </div>
        </div>
      `;
    }, 1000);
  }
  
  // å„²å­˜è‰ç¨¿
  function saveDraft() {
    const textarea = document.getElementById('review-textarea');
    const reviewType = document.querySelector('input[name="review-type"]:checked').value;
    
    const draft = {
      content: textarea.value,
      type: reviewType,
      timestamp: new Date().toISOString()
    };
    
    localStorage.setItem('review-draft', JSON.stringify(draft));
    
    // é¡¯ç¤ºå„²å­˜æˆåŠŸè¨Šæ¯
    const button = event.target;
    const originalText = button.textContent;
    button.textContent = 'âœ… å·²å„²å­˜';
    button.style.background = '#28a745';
    
    setTimeout(() => {
      button.textContent = originalText;
      button.style.background = '';
    }, 2000);
  }
  
  // æäº¤å¯©æ ¸
  function submitReview() {
    const textarea = document.getElementById('review-textarea');
    const reviewType = document.querySelector('input[name="review-type"]:checked').value;
    const checkedItems = document.querySelectorAll('.checklist-item input[type="checkbox"]:checked');
    
    if (!textarea.value.trim()) {
      alert('è«‹è¼¸å…¥å¯©æ ¸æ„è¦‹');
      return;
    }
    
    if (checkedItems.length === 0) {
      if (!confirm('æ‚¨å°šæœªå®Œæˆä»»ä½•æª¢æŸ¥é …ç›®ï¼Œç¢ºå®šè¦æäº¤å¯©æ ¸å—ï¼Ÿ')) {
        return;
      }
    }
    
    // æ¨¡æ“¬æäº¤å¯©æ ¸
    const button = event.target;
    button.textContent = 'ğŸš€ æäº¤ä¸­...';
    button.disabled = true;
    
    setTimeout(() => {
      alert(`å¯©æ ¸å·²æäº¤ï¼\né¡å‹: ${reviewType}\næ„è¦‹: ${textarea.value}\nå®Œæˆé …ç›®: ${checkedItems.length}`);
      
      // æ¸…é™¤è‰ç¨¿
      localStorage.removeItem('review-draft');
      
      button.textContent = 'âœ… å·²æäº¤';
      button.style.background = '#28a745';
    }, 2000);
  }
  
  // è¼‰å…¥å„²å­˜çš„è‰ç¨¿
  function loadDraft() {
    const draft = localStorage.getItem('review-draft');
    if (draft) {
      const data = JSON.parse(draft);
      const textarea = document.getElementById('review-textarea');
      const reviewTypeRadio = document.querySelector(`input[name="review-type"][value="${data.type}"]`);
      
      if (textarea) textarea.value = data.content;
      if (reviewTypeRadio) reviewTypeRadio.checked = true;
    }
  }
  
  // æ ¼å¼åŒ–æ™‚é–“é¡¯ç¤º
  function formatTime() {
    const timeElement = document.getElementById('created-time');
    if (timeElement) {
      const time = new Date(timeElement.textContent);
      timeElement.textContent = time.toLocaleString('zh-TW');
    }
  }
  
  // åˆå§‹åŒ–
  document.addEventListener('DOMContentLoaded', function() {
    updateProgress();
    loadDraft();
    formatTime();
    
    // è‡ªå‹•å„²å­˜è‰ç¨¿
    const textarea = document.getElementById('review-textarea');
    if (textarea) {
      textarea.addEventListener('input', function() {
        clearTimeout(this.saveTimeout);
        this.saveTimeout = setTimeout(() => {
          const reviewType = document.querySelector('input[name="review-type"]:checked').value;
          const draft = {
            content: this.value,
            type: reviewType,
            timestamp: new Date().toISOString()
          };
          localStorage.setItem('review-draft', JSON.stringify(draft));
        }, 2000);
      });
    }
  });
</script>