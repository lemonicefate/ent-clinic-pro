---
import BaseLayout from '../../layouts/BaseLayout.astro';

const title = "效能監控儀表板 | Astro Clinical Platform";
const description = "監控網站效能指標、Web Vitals 和使用者體驗";
---

<BaseLayout title={title} description={description}>
  <main class="min-h-screen bg-gray-50">
    <!-- 頁面標題 -->
    <div class="bg-white border-b border-gray-200">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
        <div class="flex items-center justify-between">
          <div>
            <h1 class="text-2xl font-bold text-gray-900">效能監控儀表板</h1>
            <p class="text-gray-600 mt-1">監控網站效能指標和使用者體驗</p>
          </div>
          <div class="flex space-x-3">
            <select id="time-range" class="px-3 py-2 border border-gray-300 rounded-md text-sm">
              <option value="1h">過去 1 小時</option>
              <option value="24h" selected>過去 24 小時</option>
              <option value="7d">過去 7 天</option>
              <option value="30d">過去 30 天</option>
            </select>
            <button id="refresh-btn" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 text-sm">
              重新整理
            </button>
          </div>
        </div>
      </div>
    </div>

    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
      <!-- 載入狀態 -->
      <div id="loading" class="text-center py-12">
        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto"></div>
        <p class="text-gray-600 mt-4">載入效能資料中...</p>
      </div>

      <!-- 主要內容 -->
      <div id="dashboard-content" class="hidden space-y-8">
        <!-- 總覽卡片 -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
          <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
            <div class="flex items-center">
              <div class="flex-shrink-0">
                <div class="w-8 h-8 bg-green-100 rounded-full flex items-center justify-center">
                  <svg class="w-5 h-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                  </svg>
                </div>
              </div>
              <div class="ml-4">
                <p class="text-sm font-medium text-gray-600">效能分數</p>
                <p id="performance-score" class="text-2xl font-semibold text-gray-900">--</p>
              </div>
            </div>
          </div>

          <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
            <div class="flex items-center">
              <div class="flex-shrink-0">
                <div class="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center">
                  <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                  </svg>
                </div>
              </div>
              <div class="ml-4">
                <p class="text-sm font-medium text-gray-600">平均載入時間</p>
                <p id="avg-load-time" class="text-2xl font-semibold text-gray-900">--</p>
              </div>
            </div>
          </div>

          <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
            <div class="flex items-center">
              <div class="flex-shrink-0">
                <div class="w-8 h-8 bg-purple-100 rounded-full flex items-center justify-center">
                  <svg class="w-5 h-5 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                  </svg>
                </div>
              </div>
              <div class="ml-4">
                <p class="text-sm font-medium text-gray-600">資料點數</p>
                <p id="data-points" class="text-2xl font-semibold text-gray-900">--</p>
              </div>
            </div>
          </div>

          <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
            <div class="flex items-center">
              <div class="flex-shrink-0">
                <div class="w-8 h-8 bg-red-100 rounded-full flex items-center justify-center">
                  <svg class="w-5 h-5 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
                  </svg>
                </div>
              </div>
              <div class="ml-4">
                <p class="text-sm font-medium text-gray-600">效能問題</p>
                <p id="issues-count" class="text-2xl font-semibold text-gray-900">--</p>
              </div>
            </div>
          </div>
        </div>

        <!-- Web Vitals -->
        <div class="bg-white rounded-lg shadow-sm border border-gray-200">
          <div class="px-6 py-4 border-b border-gray-200">
            <h2 class="text-lg font-semibold text-gray-900">Core Web Vitals</h2>
            <p class="text-sm text-gray-600">Google 核心網頁指標</p>
          </div>
          <div class="p-6">
            <div class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-5 gap-6">
              <div id="lcp-metric" class="text-center">
                <div class="w-16 h-16 mx-auto mb-3 rounded-full flex items-center justify-center bg-gray-100">
                  <span class="text-2xl font-bold text-gray-400">--</span>
                </div>
                <h3 class="text-sm font-medium text-gray-900">LCP</h3>
                <p class="text-xs text-gray-500">最大內容繪製</p>
              </div>

              <div id="fid-metric" class="text-center">
                <div class="w-16 h-16 mx-auto mb-3 rounded-full flex items-center justify-center bg-gray-100">
                  <span class="text-2xl font-bold text-gray-400">--</span>
                </div>
                <h3 class="text-sm font-medium text-gray-900">FID</h3>
                <p class="text-xs text-gray-500">首次輸入延遲</p>
              </div>

              <div id="cls-metric" class="text-center">
                <div class="w-16 h-16 mx-auto mb-3 rounded-full flex items-center justify-center bg-gray-100">
                  <span class="text-2xl font-bold text-gray-400">--</span>
                </div>
                <h3 class="text-sm font-medium text-gray-900">CLS</h3>
                <p class="text-xs text-gray-500">累積版面配置位移</p>
              </div>

              <div id="fcp-metric" class="text-center">
                <div class="w-16 h-16 mx-auto mb-3 rounded-full flex items-center justify-center bg-gray-100">
                  <span class="text-2xl font-bold text-gray-400">--</span>
                </div>
                <h3 class="text-sm font-medium text-gray-900">FCP</h3>
                <p class="text-xs text-gray-500">首次內容繪製</p>
              </div>

              <div id="ttfb-metric" class="text-center">
                <div class="w-16 h-16 mx-auto mb-3 rounded-full flex items-center justify-center bg-gray-100">
                  <span class="text-2xl font-bold text-gray-400">--</span>
                </div>
                <h3 class="text-sm font-medium text-gray-900">TTFB</h3>
                <p class="text-xs text-gray-500">首位元組時間</p>
              </div>
            </div>
          </div>
        </div>

        <!-- 效能趨勢圖表 -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
          <div class="bg-white rounded-lg shadow-sm border border-gray-200">
            <div class="px-6 py-4 border-b border-gray-200">
              <h2 class="text-lg font-semibold text-gray-900">載入時間趨勢</h2>
            </div>
            <div class="p-6">
              <canvas id="load-time-chart" width="400" height="200"></canvas>
            </div>
          </div>

          <div class="bg-white rounded-lg shadow-sm border border-gray-200">
            <div class="px-6 py-4 border-b border-gray-200">
              <h2 class="text-lg font-semibold text-gray-900">計算機響應時間</h2>
            </div>
            <div class="p-6">
              <canvas id="calculator-response-chart" width="400" height="200"></canvas>
            </div>
          </div>
        </div>

        <!-- 詳細指標表格 -->
        <div class="bg-white rounded-lg shadow-sm border border-gray-200">
          <div class="px-6 py-4 border-b border-gray-200">
            <h2 class="text-lg font-semibold text-gray-900">詳細指標</h2>
          </div>
          <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
              <thead class="bg-gray-50">
                <tr>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">指標名稱</th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">平均值</th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">P50</th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">P95</th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">P99</th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">樣本數</th>
                </tr>
              </thead>
              <tbody id="metrics-table" class="bg-white divide-y divide-gray-200">
                <!-- 動態載入 -->
              </tbody>
            </table>
          </div>
        </div>

        <!-- 效能問題 -->
        <div id="issues-section" class="bg-white rounded-lg shadow-sm border border-gray-200">
          <div class="px-6 py-4 border-b border-gray-200">
            <h2 class="text-lg font-semibold text-gray-900">效能問題</h2>
          </div>
          <div id="issues-list" class="p-6">
            <!-- 動態載入 -->
          </div>
        </div>
      </div>
    </div>
  </main>

  <script>
    let currentTimeRange = '24h';
    let performanceData = null;

    // 初始化
    document.addEventListener('DOMContentLoaded', () => {
      loadPerformanceData();
      bindEventListeners();
    });

    function bindEventListeners() {
      const timeRangeSelect = document.getElementById('time-range');
      const refreshBtn = document.getElementById('refresh-btn');

      timeRangeSelect?.addEventListener('change', (e) => {
        currentTimeRange = e.target.value;
        loadPerformanceData();
      });

      refreshBtn?.addEventListener('click', () => {
        loadPerformanceData();
      });
    }

    async function loadPerformanceData() {
      const loading = document.getElementById('loading');
      const content = document.getElementById('dashboard-content');
      
      loading?.classList.remove('hidden');
      content?.classList.add('hidden');

      try {
        const response = await fetch(`/api/analytics/performance?timeRange=${currentTimeRange}`);
        const data = await response.json();
        
        performanceData = data;
        updateDashboard(data);
        
        loading?.classList.add('hidden');
        content?.classList.remove('hidden');
      } catch (error) {
        console.error('Failed to load performance data:', error);
        loading?.classList.add('hidden');
        
        // 顯示錯誤訊息
        const errorDiv = document.createElement('div');
        errorDiv.className = 'text-center py-12';
        errorDiv.innerHTML = `
          <div class="text-red-600 mb-4">
            <svg class="w-12 h-12 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
          </div>
          <p class="text-gray-600">載入效能資料失敗</p>
          <button onclick="loadPerformanceData()" class="mt-4 px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">
            重試
          </button>
        `;
        
        document.querySelector('main')?.appendChild(errorDiv);
      }
    }

    function updateDashboard(data) {
      // 更新總覽卡片
      updateOverviewCards(data);
      
      // 更新 Web Vitals
      updateWebVitals(data.summary?.webVitals || {});
      
      // 更新詳細指標表格
      updateMetricsTable(data.metrics || {});
      
      // 更新效能問題
      updateIssues(data.summary?.issues || []);
      
      // 更新圖表 (如果有 Chart.js)
      updateCharts(data);
    }

    function updateOverviewCards(data) {
      const performanceScore = calculateOverallScore(data.summary);
      const avgLoadTime = data.summary?.performance?.loadTime?.avg || 0;
      const dataPoints = data.dataPoints || 0;
      const issuesCount = data.summary?.issues?.length || 0;

      document.getElementById('performance-score').textContent = performanceScore;
      document.getElementById('avg-load-time').textContent = avgLoadTime ? `${avgLoadTime}ms` : '--';
      document.getElementById('data-points').textContent = dataPoints.toLocaleString();
      document.getElementById('issues-count').textContent = issuesCount;
    }

    function updateWebVitals(webVitals) {
      const vitals = ['LCP', 'FID', 'CLS', 'FCP', 'TTFB'];
      
      vitals.forEach(vital => {
        const element = document.getElementById(`${vital.toLowerCase()}-metric`);
        const data = webVitals[vital];
        
        if (element && data) {
          const circle = element.querySelector('.rounded-full');
          const value = element.querySelector('.font-bold');
          
          // 更新數值
          if (vital === 'CLS') {
            value.textContent = data.p95.toFixed(3);
          } else {
            value.textContent = Math.round(data.p95);
          }
          
          // 更新顏色
          const colorClass = getRatingColor(data.rating);
          circle.className = `w-16 h-16 mx-auto mb-3 rounded-full flex items-center justify-center ${colorClass}`;
        }
      });
    }

    function updateMetricsTable(metrics) {
      const tbody = document.getElementById('metrics-table');
      if (!tbody) return;

      tbody.innerHTML = '';
      
      Object.entries(metrics).forEach(([name, data]) => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${name}</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${formatValue(data.avg)}</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${formatValue(data.p50)}</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${formatValue(data.p95)}</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${formatValue(data.p99)}</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${data.count.toLocaleString()}</td>
        `;
        tbody.appendChild(row);
      });
    }

    function updateIssues(issues) {
      const issuesList = document.getElementById('issues-list');
      const issuesSection = document.getElementById('issues-section');
      
      if (!issuesList || !issuesSection) return;

      if (issues.length === 0) {
        issuesSection.classList.add('hidden');
        return;
      }

      issuesSection.classList.remove('hidden');
      issuesList.innerHTML = issues.map(issue => `
        <div class="flex items-start p-4 bg-red-50 border border-red-200 rounded-lg mb-4">
          <svg class="w-5 h-5 text-red-400 mt-0.5 mr-3 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
          </svg>
          <div>
            <p class="text-sm text-red-800">${issue}</p>
          </div>
        </div>
      `).join('');
    }

    function updateCharts(data) {
      // 這裡可以使用 Chart.js 或其他圖表庫來繪製趨勢圖
      // 暫時顯示佔位符
      const charts = ['load-time-chart', 'calculator-response-chart'];
      charts.forEach(chartId => {
        const canvas = document.getElementById(chartId);
        if (canvas) {
          const ctx = canvas.getContext('2d');
          ctx.fillStyle = '#f3f4f6';
          ctx.fillRect(0, 0, canvas.width, canvas.height);
          ctx.fillStyle = '#6b7280';
          ctx.font = '16px Arial';
          ctx.textAlign = 'center';
          ctx.fillText('圖表資料載入中...', canvas.width / 2, canvas.height / 2);
        }
      });
    }

    function calculateOverallScore(summary) {
      if (!summary?.webVitals) return '--';
      
      const vitals = Object.values(summary.webVitals);
      if (vitals.length === 0) return '--';
      
      const scores = vitals.map(vital => {
        switch (vital.rating) {
          case 'good': return 100;
          case 'needs-improvement': return 70;
          case 'poor': return 30;
          default: return 50;
        }
      });
      
      const avgScore = scores.reduce((a, b) => a + b, 0) / scores.length;
      return Math.round(avgScore);
    }

    function getRatingColor(rating) {
      switch (rating) {
        case 'good': return 'bg-green-100 text-green-800';
        case 'needs-improvement': return 'bg-yellow-100 text-yellow-800';
        case 'poor': return 'bg-red-100 text-red-800';
        default: return 'bg-gray-100 text-gray-800';
      }
    }

    function formatValue(value) {
      if (typeof value !== 'number') return '--';
      if (value < 1) return value.toFixed(3);
      return Math.round(value).toLocaleString();
    }
  </script>
</BaseLayout>