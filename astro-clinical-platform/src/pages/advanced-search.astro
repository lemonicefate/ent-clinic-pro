---
/**
 * Advanced Search Page
 * Demonstrates the enhanced search capabilities with autocomplete and recommendations
 */

import BaseLayout from '../layouts/BaseLayout.astro';
import ProtectedRoute from '../components/ProtectedRoute.astro';
---

<BaseLayout title="é€²éšæœå°‹ - é†«ç™‚å¹³å°">
  <div class="advanced-search-page">
    <div class="container mx-auto px-4 py-8">
      <!-- Page Header -->
      <div class="search-page-header">
        <h1 class="search-page-title">é€²éšæœå°‹</h1>
        <p class="search-page-description">
          ä½¿ç”¨æ™ºèƒ½æœå°‹åŠŸèƒ½å¿«é€Ÿæ‰¾åˆ°é†«ç™‚å·¥å…·ã€è¡›æ•™æ–‡ç« ã€é†«ç™‚ç¨‹åºå’Œè—¥ç‰©è³‡è¨Š
        </p>
      </div>

      <!-- Main Search Interface -->
      <div class="search-main-section">
        <div id="advanced-search-container"></div>
      </div>

      <!-- Search Features Info -->
      <div class="search-features">
        <div class="features-grid">
          <div class="feature-card">
            <div class="feature-icon">
              <svg fill="currentColor" viewBox="0 0 20 20">
                <path fillRule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clipRule="evenodd" />
              </svg>
            </div>
            <h3 class="feature-title">æ™ºèƒ½æœå°‹</h3>
            <p class="feature-description">
              ä½¿ç”¨æ¨¡ç³Šæœå°‹æŠ€è¡“ï¼Œå³ä½¿è¼¸å…¥ä¸å®Œæ•´æˆ–æœ‰éŒ¯å­—ä¹Ÿèƒ½æ‰¾åˆ°ç›¸é—œå…§å®¹
            </p>
          </div>

          <div class="feature-card">
            <div class="feature-icon">
              <svg fill="currentColor" viewBox="0 0 20 20">
                <path fillRule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-8.293l-3-3a1 1 0 00-1.414 0l-3 3a1 1 0 001.414 1.414L9 9.414V13a1 1 0 102 0V9.414l1.293 1.293a1 1 0 001.414-1.414z" clipRule="evenodd" />
              </svg>
            </div>
            <h3 class="feature-title">è‡ªå‹•å®Œæˆ</h3>
            <p class="feature-description">
              æ ¹æ“šæ‚¨çš„è¼¸å…¥æä¾›å³æ™‚æœå°‹å»ºè­°ï¼ŒåŒ…å«ç†±é–€æœå°‹å’Œæ­·å²è¨˜éŒ„
            </p>
          </div>

          <div class="feature-card">
            <div class="feature-icon">
              <svg fill="currentColor" viewBox="0 0 20 20">
                <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" />
              </svg>
            </div>
            <h3 class="feature-title">å€‹äººåŒ–æ¨è–¦</h3>
            <p class="feature-description">
              åŸºæ–¼æ‚¨çš„ä½¿ç”¨ç¿’æ…£å’Œåå¥½ï¼Œæ¨è–¦ç›¸é—œçš„é†«ç™‚å…§å®¹å’Œå·¥å…·
            </p>
          </div>

          <div class="feature-card">
            <div class="feature-icon">
              <svg fill="currentColor" viewBox="0 0 20 20">
                <path fillRule="evenodd" d="M3 3a1 1 0 000 2v8a2 2 0 002 2h2.586l-1.293 1.293a1 1 0 101.414 1.414L10 15.414l2.293 2.293a1 1 0 001.414-1.414L12.414 15H15a2 2 0 002-2V5a1 1 0 100-2H3zm11.707 4.707a1 1 0 00-1.414-1.414L10 9.586 8.707 8.293a1 1 0 00-1.414 1.414L9.586 12l-2.293 2.293a1 1 0 101.414 1.414L10 13.414l2.293 2.293a1 1 0 001.414-1.414L11.414 12l2.293-2.293z" clipRule="evenodd" />
              </svg>
            </div>
            <h3 class="feature-title">é€²éšç¯©é¸</h3>
            <p class="feature-description">
              æŒ‰å…§å®¹é¡å‹ã€é†«å­¸å°ˆç§‘ã€é›£åº¦ç­‰ç´šç­‰æ¢ä»¶ç¯©é¸æœå°‹çµæœ
            </p>
          </div>
        </div>
      </div>

      <!-- Content Recommendations Section -->
      <div class="recommendations-section">
        <div class="section-header">
          <h2 class="section-title">æ¨è–¦å…§å®¹</h2>
          <p class="section-description">
            æ ¹æ“šç†±é–€åº¦å’Œæ‚¨çš„ä½¿ç”¨ç¿’æ…£ç‚ºæ‚¨æ¨è–¦ç›¸é—œå…§å®¹
          </p>
        </div>
        <div id="content-recommendations-container"></div>
      </div>

      <!-- Search Analytics (for authenticated users) -->
      <div class="analytics-section" id="search-analytics-section" style="display: none;">
        <div class="section-header">
          <h2 class="section-title">æœå°‹åˆ†æ</h2>
          <p class="section-description">
            æŸ¥çœ‹æ‚¨çš„æœå°‹æ­·å²å’Œç†±é–€æŸ¥è©¢
          </p>
        </div>
        <div id="search-analytics-container"></div>
      </div>

      <!-- Help Section -->
      <div class="help-section">
        <div class="help-card">
          <h3 class="help-title">æœå°‹æŠ€å·§</h3>
          <ul class="help-list">
            <li>ä½¿ç”¨é—œéµå­—æœå°‹ï¼Œæ”¯æ´ä¸­æ–‡å’Œè‹±æ–‡</li>
            <li>å¯ä»¥æœå°‹ç–¾ç—…åç¨±ã€è—¥ç‰©åç¨±ã€é†«ç™‚ç¨‹åºç­‰</li>
            <li>ä½¿ç”¨ç¯©é¸åŠŸèƒ½ç¸®å°æœå°‹ç¯„åœ</li>
            <li>é»æ“Šæœå°‹å»ºè­°å¿«é€Ÿå®Œæˆè¼¸å…¥</li>
            <li>æŸ¥çœ‹æ¨è–¦å…§å®¹ç™¼ç¾ç›¸é—œè³‡è¨Š</li>
          </ul>
        </div>

        <div class="help-card">
          <h3 class="help-title">å…§å®¹é¡å‹</h3>
          <div class="content-types">
            <div class="content-type">
              <span class="type-icon calculator">ğŸ“Š</span>
              <div class="type-info">
                <h4>è¨ˆç®—å·¥å…·</h4>
                <p>é†«ç™‚è¨ˆç®—å™¨å’Œè©•ä¼°å·¥å…·</p>
              </div>
            </div>
            <div class="content-type">
              <span class="type-icon education">ğŸ“š</span>
              <div class="type-info">
                <h4>è¡›æ•™æ–‡ç« </h4>
                <p>ç–¾ç—…ä»‹ç´¹å’Œå¥åº·æ•™è‚²</p>
              </div>
            </div>
            <div class="content-type">
              <span class="type-icon procedure">ğŸ¥</span>
              <div class="type-info">
                <h4>é†«ç™‚ç¨‹åº</h4>
                <p>æ“ä½œæµç¨‹å’ŒæŠ€è¡“æŒ‡å¼•</p>
              </div>
            </div>
            <div class="content-type">
              <span class="type-icon medication">ğŸ’Š</span>
              <div class="type-info">
                <h4>è—¥ç‰©è³‡è¨Š</h4>
                <p>ç”¨è—¥æŒ‡å¼•å’Œå®‰å…¨è³‡è¨Š</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Import styles -->
  <link rel="stylesheet" href="/src/styles/advanced-search.css">
  <link rel="stylesheet" href="/src/styles/content-recommendations.css">

  <style>
    .advanced-search-page {
      min-height: 100vh;
      background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
    }

    .search-page-header {
      text-align: center;
      margin-bottom: 3rem;
    }

    .search-page-title {
      font-size: 2.5rem;
      font-weight: 700;
      color: #1f2937;
      margin-bottom: 1rem;
    }

    .search-page-description {
      font-size: 1.125rem;
      color: #6b7280;
      max-width: 600px;
      margin: 0 auto;
      line-height: 1.6;
    }

    .search-main-section {
      margin-bottom: 4rem;
    }

    .search-features {
      margin-bottom: 4rem;
    }

    .features-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 2rem;
      margin-top: 2rem;
    }

    .feature-card {
      background: white;
      padding: 2rem;
      border-radius: 12px;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
      text-align: center;
      transition: transform 0.2s ease-in-out;
    }

    .feature-card:hover {
      transform: translateY(-2px);
    }

    .feature-icon {
      width: 48px;
      height: 48px;
      margin: 0 auto 1rem;
      color: #3b82f6;
    }

    .feature-icon svg {
      width: 100%;
      height: 100%;
    }

    .feature-title {
      font-size: 1.25rem;
      font-weight: 600;
      color: #1f2937;
      margin-bottom: 0.5rem;
    }

    .feature-description {
      color: #6b7280;
      line-height: 1.5;
    }

    .recommendations-section,
    .analytics-section {
      margin-bottom: 4rem;
    }

    .section-header {
      text-align: center;
      margin-bottom: 2rem;
    }

    .section-title {
      font-size: 2rem;
      font-weight: 600;
      color: #1f2937;
      margin-bottom: 0.5rem;
    }

    .section-description {
      color: #6b7280;
      font-size: 1.125rem;
    }

    .help-section {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 2rem;
    }

    .help-card {
      background: white;
      padding: 2rem;
      border-radius: 12px;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    }

    .help-title {
      font-size: 1.25rem;
      font-weight: 600;
      color: #1f2937;
      margin-bottom: 1rem;
    }

    .help-list {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    .help-list li {
      padding: 0.5rem 0;
      color: #6b7280;
      position: relative;
      padding-left: 1.5rem;
    }

    .help-list li::before {
      content: 'â€¢';
      color: #3b82f6;
      font-weight: bold;
      position: absolute;
      left: 0;
    }

    .content-types {
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }

    .content-type {
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .type-icon {
      font-size: 1.5rem;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 8px;
      background: #f3f4f6;
    }

    .type-info h4 {
      font-weight: 600;
      color: #1f2937;
      margin: 0 0 0.25rem 0;
    }

    .type-info p {
      color: #6b7280;
      margin: 0;
      font-size: 0.875rem;
    }

    @media (max-width: 768px) {
      .search-page-title {
        font-size: 2rem;
      }

      .features-grid {
        grid-template-columns: 1fr;
      }

      .help-section {
        grid-template-columns: 1fr;
      }

      .content-types {
        gap: 0.75rem;
      }
    }
  </style>

  <script>
    import { getSearchEngine, getRecommendationEngine, initializeSearchEngine } from '../utils/advanced-search';
    import { loadSearchData } from '../utils/search-data-loader';
    import AdvancedSearch from '../components/islands/AdvancedSearch';
    import ContentRecommendations from '../components/islands/ContentRecommendations';

    // Initialize search functionality
    async function initializeAdvancedSearch() {
      try {
        // Load search data
        const searchData = await loadSearchData();
        await initializeSearchEngine(searchData);

        // Mount Advanced Search component
        const searchContainer = document.getElementById('advanced-search-container');
        if (searchContainer) {
          const searchComponent = React.createElement(AdvancedSearch, {
            placeholder: "æœå°‹é†«ç™‚å·¥å…·ã€è¡›æ•™æ–‡ç« ã€é†«ç™‚ç¨‹åº...",
            showRecommendations: true,
            showFilters: true,
            className: "main-search",
            onResultClick: (item) => {
              // Track click and navigate
              console.log('Search result clicked:', item);
              window.location.href = item.url;
            }
          });
          
          ReactDOM.render(searchComponent, searchContainer);
        }

        // Mount Content Recommendations component
        const recommendationsContainer = document.getElementById('content-recommendations-container');
        if (recommendationsContainer) {
          const recommendationsComponent = React.createElement(ContentRecommendations, {
            title: "ç†±é–€æ¨è–¦å…§å®¹",
            limit: 8,
            showReason: true,
            className: "main-recommendations",
            onItemClick: (item) => {
              console.log('Recommendation clicked:', item);
              window.location.href = item.url;
            }
          });
          
          ReactDOM.render(recommendationsComponent, recommendationsContainer);
        }

        // Show analytics section for authenticated users
        // This would check authentication status
        const analyticsSection = document.getElementById('search-analytics-section');
        if (analyticsSection && checkUserAuthentication()) {
          analyticsSection.style.display = 'block';
          loadSearchAnalytics();
        }

      } catch (error) {
        console.error('Failed to initialize advanced search:', error);
      }
    }

    function checkUserAuthentication() {
      // This would check if user is authenticated
      // For now, return false
      return false;
    }

    function loadSearchAnalytics() {
      const searchEngine = getSearchEngine();
      const analytics = searchEngine.getSearchAnalytics();
      
      const analyticsContainer = document.getElementById('search-analytics-container');
      if (analyticsContainer) {
        analyticsContainer.innerHTML = `
          <div class="analytics-grid">
            <div class="analytics-card">
              <h3>ç†±é–€æœå°‹</h3>
              <ul>
                ${analytics.popularQueries.slice(0, 5).map(query => 
                  `<li>${query.query} (${query.count} æ¬¡)</li>`
                ).join('')}
              </ul>
            </div>
            <div class="analytics-card">
              <h3>æœ€è¿‘æœå°‹</h3>
              <ul>
                ${analytics.recentSearches.slice(0, 5).map(query => 
                  `<li>${query}</li>`
                ).join('')}
              </ul>
            </div>
          </div>
        `;
      }
    }

    // Initialize when DOM is loaded
    document.addEventListener('DOMContentLoaded', initializeAdvancedSearch);
  </script>
</BaseLayout>