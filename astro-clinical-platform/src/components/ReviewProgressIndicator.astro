---
/**
 * å¯©æ ¸é€²åº¦æŒ‡ç¤ºå™¨çµ„ä»¶
 * é¡¯ç¤ºæ–‡ç« å¯©æ ¸æµç¨‹çš„é€²åº¦å’Œç‹€æ…‹
 * 
 * æ›´æ–°æ—¥æœŸï¼š2025-01-30
 * æ›´æ–°å…§å®¹ï¼šæ–°å¢å¯©æ ¸é€²åº¦æŒ‡ç¤ºå™¨åŠŸèƒ½
 * 
 * éœ€æ±‚å°æ‡‰ï¼š
 * - éœ€æ±‚ 6.1: ç‰ˆæœ¬æ§åˆ¶å’Œè¿½è¹¤ç³»çµ± âœ“
 * - éœ€æ±‚ 6.2: å¯©æ ¸é€²åº¦æŒ‡ç¤ºå™¨ âœ“
 */

import { formatDate } from '../utils/i18n';
import type { SupportedLocale, ArticleStatus, ReviewDecision } from '../env.d';

interface ReviewHistoryEntry {
  reviewer: string;
  reviewDate: string;
  decision: ReviewDecision;
  comments?: string;
  checklist?: {
    medicalAccuracy: boolean;
    contentStructure: boolean;
    languageClarity: boolean;
    referencesValid: boolean;
    seoOptimized: boolean;
    accessibilityCompliant: boolean;
  };
}

interface Props {
  status: ArticleStatus;
  reviewHistory: ReviewHistoryEntry[];
  currentReviewers?: string[];
  requiredApprovals?: number;
  reviewTimeLimit?: number;
  submittedForReview?: string;
  locale?: SupportedLocale;
  showDetails?: boolean;
}

const {
  status,
  reviewHistory = [],
  currentReviewers = [],
  requiredApprovals = 2,
  reviewTimeLimit = 7,
  submittedForReview,
  locale = 'zh-TW',
  showDetails = true
} = Astro.props;

// è¨ˆç®—å¯©æ ¸çµ±è¨ˆ
const approvedReviews = reviewHistory.filter(r => r.decision === 'approved');
const rejectedReviews = reviewHistory.filter(r => r.decision === 'rejected');
const revisionRequests = reviewHistory.filter(r => r.decision === 'needs-revision');

const approvalCount = approvedReviews.length;
const approvalProgress = Math.min((approvalCount / requiredApprovals) * 100, 100);

// è¨ˆç®—å¯©æ ¸æ™‚é–“
const submittedDate = submittedForReview ? new Date(submittedForReview) : null;
const now = new Date();
const daysSinceSubmission = submittedDate 
  ? Math.floor((now.getTime() - submittedDate.getTime()) / (1000 * 60 * 60 * 24))
  : 0;

const daysRemaining = reviewTimeLimit - daysSinceSubmission;
const isOverdue = daysRemaining < 0;
const isUrgent = daysRemaining <= 2 && daysRemaining >= 0;

// å¯©æ ¸ç‹€æ…‹é…ç½®
const getReviewStatus = () => {
  if (status !== 'in-review') {
    return {
      label: 'éå¯©æ ¸ç‹€æ…‹',
      color: 'text-gray-600',
      bgColor: 'bg-gray-50',
      borderColor: 'border-gray-200',
      icon: 'â¸ï¸'
    };
  }
  
  if (approvalCount >= requiredApprovals) {
    return {
      label: 'å¯©æ ¸å®Œæˆ',
      color: 'text-green-600',
      bgColor: 'bg-green-50',
      borderColor: 'border-green-200',
      icon: 'âœ…'
    };
  }
  
  if (isOverdue) {
    return {
      label: 'å¯©æ ¸é€¾æœŸ',
      color: 'text-red-600',
      bgColor: 'bg-red-50',
      borderColor: 'border-red-200',
      icon: 'âš ï¸'
    };
  }
  
  if (isUrgent) {
    return {
      label: 'å¯©æ ¸ç·Šæ€¥',
      color: 'text-orange-600',
      bgColor: 'bg-orange-50',
      borderColor: 'border-orange-200',
      icon: 'ğŸ”¥'
    };
  }
  
  return {
    label: 'å¯©æ ¸é€²è¡Œä¸­',
    color: 'text-blue-600',
    bgColor: 'bg-blue-50',
    borderColor: 'border-blue-200',
    icon: 'ğŸ‘€'
  };
};

const reviewStatus = getReviewStatus();

// ç²å–å¯©æ ¸è€…ç‹€æ…‹
const getReviewerStatus = (reviewerId: string) => {
  const review = reviewHistory.find(r => r.reviewer === reviewerId);
  if (!review) return { status: 'pending', label: 'å¾…å¯©æ ¸', color: 'text-gray-500' };
  
  switch (review.decision) {
    case 'approved':
      return { status: 'approved', label: 'å·²é€šé', color: 'text-green-600' };
    case 'rejected':
      return { status: 'rejected', label: 'å·²æ‹’çµ•', color: 'text-red-600' };
    case 'needs-revision':
      return { status: 'revision', label: 'éœ€ä¿®æ”¹', color: 'text-yellow-600' };
    default:
      return { status: 'pending', label: 'å¾…å¯©æ ¸', color: 'text-gray-500' };
  }
};

// è¨ˆç®—æª¢æŸ¥æ¸…å–®å®Œæˆåº¦
const getChecklistCompletion = (checklist?: ReviewHistoryEntry['checklist']) => {
  if (!checklist) return 0;
  const items = Object.values(checklist);
  const completed = items.filter(Boolean).length;
  return Math.round((completed / items.length) * 100);
};
---

<div class={`rounded-lg border p-6 ${reviewStatus.bgColor} ${reviewStatus.borderColor}`}>
  <!-- å¯©æ ¸ç‹€æ…‹æ¨™é ­ -->
  <div class="flex items-center justify-between mb-4">
    <div class="flex items-center space-x-3">
      <span class="text-xl">{reviewStatus.icon}</span>
      <div>
        <h3 class={`text-lg font-semibold ${reviewStatus.color}`}>
          {reviewStatus.label}
        </h3>
        <p class="text-sm text-gray-600">
          {approvalCount}/{requiredApprovals} å¯©æ ¸é€šé
        </p>
      </div>
    </div>
    
    {submittedDate && (
      <div class="text-right">
        <div class="text-sm text-gray-500">æäº¤æ™‚é–“</div>
        <div class="font-medium">{formatDate(submittedForReview!, locale, 'short')}</div>
        <div class={`text-xs ${isOverdue ? 'text-red-600' : isUrgent ? 'text-orange-600' : 'text-gray-500'}`}>
          {daysSinceSubmission} å¤©å‰
        </div>
      </div>
    )}
  </div>

  <!-- é€²åº¦æ¢ -->
  <div class="mb-6">
    <div class="flex justify-between text-sm text-gray-600 mb-2">
      <span>å¯©æ ¸é€²åº¦</span>
      <span>{Math.round(approvalProgress)}%</span>
    </div>
    <div class="w-full bg-gray-200 rounded-full h-3">
      <div 
        class={`h-3 rounded-full transition-all duration-500 ${
          approvalCount >= requiredApprovals ? 'bg-green-500' :
          isOverdue ? 'bg-red-500' :
          isUrgent ? 'bg-orange-500' : 'bg-blue-500'
        }`}
        style={`width: ${approvalProgress}%`}
      ></div>
    </div>
  </div>

  <!-- æ™‚é–“è³‡è¨Š -->
  {status === 'in-review' && (
    <div class="grid grid-cols-2 gap-4 mb-6">
      <div class="text-center">
        <div class={`text-2xl font-bold ${isOverdue ? 'text-red-600' : isUrgent ? 'text-orange-600' : 'text-blue-600'}`}>
          {Math.abs(daysRemaining)}
        </div>
        <div class="text-sm text-gray-600">
          {isOverdue ? 'é€¾æœŸå¤©æ•¸' : 'å‰©é¤˜å¤©æ•¸'}
        </div>
      </div>
      <div class="text-center">
        <div class="text-2xl font-bold text-gray-900">
          {daysSinceSubmission}
        </div>
        <div class="text-sm text-gray-600">å·²ç­‰å¾…å¤©æ•¸</div>
      </div>
    </div>
  )}

  <!-- å¯©æ ¸è€…ç‹€æ…‹ -->
  {currentReviewers.length > 0 && (
    <div class="mb-6">
      <h4 class="text-sm font-medium text-gray-700 mb-3">å¯©æ ¸è€…ç‹€æ…‹</h4>
      <div class="space-y-2">
        {currentReviewers.map(reviewerId => {
          const reviewerStatus = getReviewerStatus(reviewerId);
          const review = reviewHistory.find(r => r.reviewer === reviewerId);
          
          return (
            <div key={reviewerId} class="flex items-center justify-between p-3 bg-white bg-opacity-50 rounded border border-white border-opacity-30">
              <div class="flex items-center space-x-3">
                <div class={`w-3 h-3 rounded-full ${
                  reviewerStatus.status === 'approved' ? 'bg-green-500' :
                  reviewerStatus.status === 'rejected' ? 'bg-red-500' :
                  reviewerStatus.status === 'revision' ? 'bg-yellow-500' :
                  'bg-gray-300'
                }`}></div>
                <span class="font-medium text-gray-900">{reviewerId}</span>
                <span class={`text-sm ${reviewerStatus.color}`}>
                  {reviewerStatus.label}
                </span>
              </div>
              
              {review && (
                <div class="text-right">
                  <div class="text-xs text-gray-500">
                    {formatDate(review.reviewDate, locale, 'short')}
                  </div>
                  {review.checklist && (
                    <div class="text-xs text-gray-400">
                      æª¢æŸ¥æ¸…å–®: {getChecklistCompletion(review.checklist)}%
                    </div>
                  )}
                </div>
              )}
            </div>
          );
        })}
      </div>
    </div>
  )}

  <!-- å¯©æ ¸æ­·å²æ‘˜è¦ -->
  {showDetails && reviewHistory.length > 0 && (
    <div>
      <h4 class="text-sm font-medium text-gray-700 mb-3">æœ€è¿‘å¯©æ ¸</h4>
      <div class="space-y-3">
        {reviewHistory.slice(0, 3).map((review, index) => (
          <div key={index} class="p-3 bg-white bg-opacity-50 rounded border border-white border-opacity-30">
            <div class="flex items-center justify-between mb-2">
              <div class="flex items-center space-x-2">
                <span class="font-medium text-gray-900">{review.reviewer}</span>
                <span class={`inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium ${
                  review.decision === 'approved' ? 'bg-green-100 text-green-800' :
                  review.decision === 'rejected' ? 'bg-red-100 text-red-800' :
                  'bg-yellow-100 text-yellow-800'
                }`}>
                  {review.decision === 'approved' ? 'é€šé' :
                   review.decision === 'rejected' ? 'æ‹’çµ•' : 'éœ€ä¿®æ”¹'}
                </span>
              </div>
              <span class="text-xs text-gray-500">
                {formatDate(review.reviewDate, locale, 'short')}
              </span>
            </div>
            
            {review.comments && (
              <p class="text-sm text-gray-600 mb-2 line-clamp-2">
                {review.comments}
              </p>
            )}
            
            {review.checklist && (
              <div class="flex items-center space-x-4 text-xs">
                <span class="text-gray-500">æª¢æŸ¥é …ç›®:</span>
                <div class="flex space-x-2">
                  {Object.entries(review.checklist).map(([key, value]) => (
                    <span key={key} class={`inline-flex items-center ${value ? 'text-green-600' : 'text-red-600'}`}>
                      {value ? 'âœ“' : 'âœ—'}
                    </span>
                  ))}
                </div>
                <span class="text-gray-400">
                  {getChecklistCompletion(review.checklist)}% å®Œæˆ
                </span>
              </div>
            )}
          </div>
        ))}
      </div>
    </div>
  )}

  <!-- çµ±è¨ˆæ‘˜è¦ -->
  {reviewHistory.length > 0 && (
    <div class="mt-6 pt-4 border-t border-white border-opacity-30">
      <div class="grid grid-cols-3 gap-4 text-center text-sm">
        <div>
          <div class="font-semibold text-green-600">{approvedReviews.length}</div>
          <div class="text-gray-600">é€šé</div>
        </div>
        <div>
          <div class="font-semibold text-yellow-600">{revisionRequests.length}</div>
          <div class="text-gray-600">éœ€ä¿®æ”¹</div>
        </div>
        <div>
          <div class="font-semibold text-red-600">{rejectedReviews.length}</div>
          <div class="text-gray-600">æ‹’çµ•</div>
        </div>
      </div>
    </div>
  )}

  <!-- è¡Œå‹•å»ºè­° -->
  {status === 'in-review' && (
    <div class="mt-4 p-3 bg-white bg-opacity-50 rounded border border-white border-opacity-30">
      <div class="flex items-start space-x-2">
        <svg class="h-4 w-4 text-gray-500 mt-0.5 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
        </svg>
        <div>
          <p class="text-xs font-medium text-gray-700">å»ºè­°è¡Œå‹•</p>
          <p class="text-xs text-gray-600 mt-1">
            {approvalCount >= requiredApprovals 
              ? 'å·²é”åˆ°æ‰€éœ€å¯©æ ¸æ•¸é‡ï¼Œå¯ä»¥é€²å…¥ä¸‹ä¸€éšæ®µ'
              : isOverdue 
                ? 'å¯©æ ¸å·²é€¾æœŸï¼Œå»ºè­°è¯ç¹«å¯©æ ¸è€…æˆ–é‡æ–°åˆ†é…'
                : isUrgent
                  ? 'å¯©æ ¸å³å°‡åˆ°æœŸï¼Œå»ºè­°æé†’å¯©æ ¸è€…'
                  : `é‚„éœ€è¦ ${requiredApprovals - approvalCount} å€‹å¯©æ ¸é€šé`
            }
          </p>
        </div>
      </div>
    </div>
  )}
</div>

<style>
  .line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
</style>