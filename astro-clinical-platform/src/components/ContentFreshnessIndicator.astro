---
/**
 * å…§å®¹æ–°é®®åº¦æŒ‡ç¤ºå™¨çµ„ä»¶
 * é¡¯ç¤ºå…§å®¹çš„æ–°é®®åº¦å’Œæ›´æ–°æé†’
 * 
 * æ›´æ–°æ—¥æœŸï¼š2025-01-30
 * æ›´æ–°å…§å®¹ï¼šæ–°å¢å…§å®¹æ–°é®®åº¦å’Œæ›´æ–°æé†’åŠŸèƒ½
 * 
 * éœ€æ±‚å°æ‡‰ï¼š
 * - éœ€æ±‚ 6.1: ç‰ˆæœ¬æ§åˆ¶å’Œè¿½è¹¤ç³»çµ± âœ“
 * - éœ€æ±‚ 6.2: å…§å®¹æ–°é®®åº¦å’Œæ›´æ–°æé†’ âœ“
 */

import { formatDate } from '../utils/i18n';
import type { SupportedLocale } from '../env.d';

interface Props {
  lastUpdated: string;
  nextReviewDate?: string;
  publishedAt?: string;
  category?: string;
  medicalSpecialties?: string[];
  locale?: SupportedLocale;
  showInline?: boolean;
}

const {
  lastUpdated,
  nextReviewDate,
  publishedAt,
  category,
  medicalSpecialties = [],
  locale = 'zh-TW',
  showInline = false
} = Astro.props;

// è¨ˆç®—å…§å®¹å¹´é½¡ï¼ˆå¤©æ•¸ï¼‰
const now = new Date();
const lastUpdateDate = new Date(lastUpdated);
const publishDate = publishedAt ? new Date(publishedAt) : lastUpdateDate;
const nextReviewDateObj = nextReviewDate ? new Date(nextReviewDate) : null;

const daysSinceUpdate = Math.floor((now.getTime() - lastUpdateDate.getTime()) / (1000 * 60 * 60 * 24));
const daysSincePublish = Math.floor((now.getTime() - publishDate.getTime()) / (1000 * 60 * 60 * 24));
const daysUntilReview = nextReviewDateObj ? Math.floor((nextReviewDateObj.getTime() - now.getTime()) / (1000 * 60 * 60 * 24)) : null;

// æ ¹æ“šé†«ç™‚å…§å®¹é¡å‹è¨­å®šæ–°é®®åº¦æ¨™æº–
const getFreshnessStandards = (category: string, specialties: string[]) => {
  // é«˜é¢¨éšªå°ˆç§‘éœ€è¦æ›´é »ç¹æ›´æ–°
  const highRiskSpecialties = ['emergency', 'cardiology', 'neurology'];
  const isHighRisk = specialties.some(s => highRiskSpecialties.includes(s));
  
  // æ ¹æ“šå…§å®¹é¡å‹è¨­å®šæ¨™æº–
  const standards = {
    'disease': { fresh: isHighRisk ? 90 : 180, stale: isHighRisk ? 180 : 365, critical: isHighRisk ? 365 : 730 },
    'medication': { fresh: 60, stale: 120, critical: 365 },
    'procedure': { fresh: isHighRisk ? 120 : 180, stale: isHighRisk ? 240 : 365, critical: isHighRisk ? 365 : 730 },
    'treatment': { fresh: isHighRisk ? 90 : 120, stale: isHighRisk ? 180 : 240, critical: isHighRisk ? 365 : 540 },
    'prevention': { fresh: 180, stale: 365, critical: 730 },
    'lifestyle': { fresh: 365, stale: 730, critical: 1095 },
    'symptoms': { fresh: 180, stale: 365, critical: 730 },
    'diagnosis': { fresh: isHighRisk ? 120 : 180, stale: isHighRisk ? 240 : 365, critical: isHighRisk ? 365 : 730 }
  };
  
  return standards[category] || standards['disease'];
};

const standards = getFreshnessStandards(category || 'disease', medicalSpecialties);

// åˆ¤æ–·æ–°é®®åº¦ç­‰ç´š
const getFreshnessLevel = (days: number) => {
  if (days <= standards.fresh) return 'fresh';
  if (days <= standards.stale) return 'aging';
  if (days <= standards.critical) return 'stale';
  return 'critical';
};

const freshnessLevel = getFreshnessLevel(daysSinceUpdate);

// æ–°é®®åº¦é…ç½®
const freshnessConfig = {
  fresh: {
    label: 'å…§å®¹æ–°é®®',
    color: 'text-green-600',
    bgColor: 'bg-green-50',
    borderColor: 'border-green-200',
    icon: 'ğŸŸ¢',
    description: 'å…§å®¹æ˜¯æœ€æ–°çš„'
  },
  aging: {
    label: 'å…§å®¹è€åŒ–',
    color: 'text-yellow-600',
    bgColor: 'bg-yellow-50',
    borderColor: 'border-yellow-200',
    icon: 'ğŸŸ¡',
    description: 'å»ºè­°æª¢æŸ¥æ›´æ–°'
  },
  stale: {
    label: 'å…§å®¹éæ™‚',
    color: 'text-orange-600',
    bgColor: 'bg-orange-50',
    borderColor: 'border-orange-200',
    icon: 'ğŸŸ ',
    description: 'éœ€è¦æ›´æ–°å…§å®¹'
  },
  critical: {
    label: 'æ€¥éœ€æ›´æ–°',
    color: 'text-red-600',
    bgColor: 'bg-red-50',
    borderColor: 'border-red-200',
    icon: 'ğŸ”´',
    description: 'å…§å®¹å¯èƒ½å·²éæ™‚'
  }
};

const currentFreshness = freshnessConfig[freshnessLevel];

// è¨ˆç®—æ›´æ–°å»ºè­°
const getUpdateSuggestion = () => {
  if (freshnessLevel === 'fresh') return null;
  
  const suggestions = {
    aging: 'å»ºè­°åœ¨æœªä¾† 30 å¤©å…§æª¢æŸ¥å…§å®¹æ˜¯å¦éœ€è¦æ›´æ–°',
    stale: 'å»ºè­°ç›¡å¿«æª¢æŸ¥ä¸¦æ›´æ–°å…§å®¹ï¼Œç¢ºä¿è³‡è¨Šæº–ç¢ºæ€§',
    critical: 'å…§å®¹å¯èƒ½åŒ…å«éæ™‚è³‡è¨Šï¼Œè«‹ç«‹å³æª¢æŸ¥ä¸¦æ›´æ–°'
  };
  
  return suggestions[freshnessLevel];
};

const updateSuggestion = getUpdateSuggestion();

// æª¢æŸ¥æ˜¯å¦éœ€è¦é¡¯ç¤ºå¯©æ ¸æé†’
const showReviewReminder = daysUntilReview !== null && daysUntilReview <= 30;
const isOverdue = daysUntilReview !== null && daysUntilReview < 0;
---

{showInline ? (
  <!-- å…§è¯é¡¯ç¤ºæ¨¡å¼ -->
  <div class={`inline-flex items-center space-x-2 px-3 py-1 rounded-full text-sm ${currentFreshness.bgColor} ${currentFreshness.borderColor} border`}>
    <span class="text-xs">{currentFreshness.icon}</span>
    <span class={`font-medium ${currentFreshness.color}`}>
      {currentFreshness.label}
    </span>
    <span class="text-xs text-gray-500">
      {daysSinceUpdate} å¤©å‰æ›´æ–°
    </span>
  </div>
) : (
  <!-- å®Œæ•´é¡¯ç¤ºæ¨¡å¼ -->
  <div class={`rounded-lg border p-4 ${currentFreshness.bgColor} ${currentFreshness.borderColor}`}>
    <!-- æ–°é®®åº¦æ¨™é ­ -->
    <div class="flex items-center justify-between mb-3">
      <div class="flex items-center space-x-2">
        <span class="text-lg">{currentFreshness.icon}</span>
        <span class={`font-semibold ${currentFreshness.color}`}>
          {currentFreshness.label}
        </span>
      </div>
      <span class="text-xs text-gray-500">
        {daysSinceUpdate} å¤©å‰æ›´æ–°
      </span>
    </div>
    
    <!-- æ–°é®®åº¦æè¿° -->
    <p class="text-sm text-gray-600 mb-3">
      {currentFreshness.description}
    </p>
    
    <!-- æ™‚é–“è»¸è³‡è¨Š -->
    <div class="space-y-2 text-sm">
      <div class="flex justify-between">
        <span class="text-gray-500">æœ€å¾Œæ›´æ–°:</span>
        <span class="font-medium">{formatDate(lastUpdated, locale)}</span>
      </div>
      
      {publishedAt && (
        <div class="flex justify-between">
          <span class="text-gray-500">ç™¼å¸ƒæ™‚é–“:</span>
          <span>{formatDate(publishedAt, locale)}</span>
        </div>
      )}
      
      {nextReviewDate && (
        <div class="flex justify-between">
          <span class="text-gray-500">ä¸‹æ¬¡å¯©æ ¸:</span>
          <span class={isOverdue ? 'text-red-600 font-medium' : daysUntilReview && daysUntilReview <= 7 ? 'text-orange-600 font-medium' : ''}>
            {formatDate(nextReviewDate, locale)}
            {daysUntilReview !== null && (
              <span class="ml-1 text-xs">
                ({daysUntilReview > 0 ? `${daysUntilReview} å¤©å¾Œ` : `é€¾æœŸ ${Math.abs(daysUntilReview)} å¤©`})
              </span>
            )}
          </span>
        </div>
      )}
    </div>
    
    <!-- æ›´æ–°å»ºè­° -->
    {updateSuggestion && (
      <div class="mt-3 p-3 bg-white bg-opacity-50 rounded border border-white border-opacity-30">
        <div class="flex items-start space-x-2">
          <svg class="h-4 w-4 text-gray-500 mt-0.5 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
          </svg>
          <p class="text-xs text-gray-600">
            {updateSuggestion}
          </p>
        </div>
      </div>
    )}
    
    <!-- å¯©æ ¸æé†’ -->
    {showReviewReminder && (
      <div class={`mt-3 p-3 rounded border ${isOverdue ? 'bg-red-50 border-red-200' : 'bg-yellow-50 border-yellow-200'}`}>
        <div class="flex items-start space-x-2">
          <svg class={`h-4 w-4 mt-0.5 flex-shrink-0 ${isOverdue ? 'text-red-500' : 'text-yellow-500'}`} fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L4.082 16.5c-.77.833.192 2.5 1.732 2.5z" />
          </svg>
          <div>
            <p class={`text-xs font-medium ${isOverdue ? 'text-red-700' : 'text-yellow-700'}`}>
              {isOverdue ? 'å¯©æ ¸å·²é€¾æœŸ' : 'å³å°‡åˆ°æœŸå¯©æ ¸'}
            </p>
            <p class="text-xs text-gray-600 mt-1">
              {isOverdue 
                ? `å¯©æ ¸å·²é€¾æœŸ ${Math.abs(daysUntilReview)} å¤©ï¼Œè«‹ç«‹å³å®‰æ’å¯©æ ¸`
                : `é‚„æœ‰ ${daysUntilReview} å¤©éœ€è¦é€²è¡Œå®šæœŸå¯©æ ¸`
              }
            </p>
          </div>
        </div>
      </div>
    )}
    
    <!-- æ–°é®®åº¦æ¨™æº–èªªæ˜ï¼ˆåƒ…é–‹ç™¼ç’°å¢ƒï¼‰ -->
    {import.meta.env.DEV && (
      <details class="mt-3">
        <summary class="text-xs cursor-pointer text-gray-500 hover:text-gray-700 select-none">
          æ–°é®®åº¦æ¨™æº– â–¼
        </summary>
        <div class="mt-2 text-xs text-gray-500 space-y-1">
          <div>ğŸŸ¢ æ–°é®®: â‰¤ {standards.fresh} å¤©</div>
          <div>ğŸŸ¡ è€åŒ–: â‰¤ {standards.stale} å¤©</div>
          <div>ğŸŸ  éæ™‚: â‰¤ {standards.critical} å¤©</div>
          <div>ğŸ”´ æ€¥éœ€: > {standards.critical} å¤©</div>
          <div class="text-xs text-gray-400 mt-2">
            æ¨™æº–æ ¹æ“šå…§å®¹é¡å‹ ({category}) å’Œå°ˆç§‘ ({medicalSpecialties.join(', ')}) èª¿æ•´
          </div>
        </div>
      </details>
    )}
  </div>
)}

<style>
  details[open] summary {
    margin-bottom: 0.5rem;
  }
  
  details summary::-webkit-details-marker {
    display: none;
  }
</style>