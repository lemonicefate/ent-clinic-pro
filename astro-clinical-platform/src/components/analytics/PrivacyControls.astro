---
/**
 * 分析隱私控制組件
 * 提供用戶選擇退出分析追蹤的選項
 */

export interface Props {
  locale?: 'zh-TW' | 'en' | 'ja';
  className?: string;
}

const {
  locale = 'zh-TW',
  className = ''
} = Astro.props;

const labels = {
  'zh-TW': {
    title: '隱私設定',
    description: '我們使用隱私友善的分析工具來改善網站體驗，不會收集個人識別資訊。',
    optOut: '停用分析追蹤',
    optIn: '啟用分析追蹤',
    currentStatus: '目前狀態：',
    enabled: '已啟用',
    disabled: '已停用',
    clearData: '清除本地分析資料'
  },
  'en': {
    title: 'Privacy Settings',
    description: 'We use privacy-friendly analytics to improve website experience without collecting personal information.',
    optOut: 'Disable Analytics',
    optIn: 'Enable Analytics',
    currentStatus: 'Current Status: ',
    enabled: 'Enabled',
    disabled: 'Disabled',
    clearData: 'Clear Local Analytics Data'
  },
  'ja': {
    title: 'プライバシー設定',
    description: '個人情報を収集せずにウェブサイト体験を改善するため、プライバシー重視の分析ツールを使用しています。',
    optOut: '分析追跡を無効にする',
    optIn: '分析追跡を有効にする',
    currentStatus: '現在の状態：',
    enabled: '有効',
    disabled: '無効',
    clearData: 'ローカル分析データをクリア'
  }
};

const t = labels[locale];
---

<div class={`privacy-controls bg-white rounded-lg border border-gray-200 p-6 ${className}`}>
  <div class="flex items-start space-x-3">
    <div class="flex-shrink-0">
      <svg class="h-6 w-6 text-blue-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
      </svg>
    </div>
    
    <div class="flex-1">
      <h3 class="text-lg font-medium text-gray-900 mb-2">
        {t.title}
      </h3>
      
      <p class="text-sm text-gray-600 mb-4">
        {t.description}
      </p>
      
      <div class="space-y-4">
        <!-- 狀態顯示 -->
        <div class="flex items-center space-x-2">
          <span class="text-sm font-medium text-gray-700">{t.currentStatus}</span>
          <span id="analytics-status" class="text-sm font-medium text-green-600">
            {t.enabled}
          </span>
        </div>
        
        <!-- 控制按鈕 -->
        <div class="flex flex-wrap gap-3">
          <button
            id="analytics-toggle"
            class="inline-flex items-center px-4 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500"
          >
            <svg class="h-4 w-4 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728L5.636 5.636m12.728 12.728L5.636 5.636" />
            </svg>
            {t.optOut}
          </button>
          
          <button
            id="clear-analytics-data"
            class="inline-flex items-center px-4 py-2 border border-red-300 rounded-md shadow-sm text-sm font-medium text-red-700 bg-white hover:bg-red-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500"
          >
            <svg class="h-4 w-4 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
            </svg>
            {t.clearData}
          </button>
        </div>
        
        <!-- 統計資訊 -->
        <div id="analytics-stats" class="hidden">
          <div class="bg-gray-50 rounded-md p-4">
            <h4 class="text-sm font-medium text-gray-900 mb-2">本地分析統計</h4>
            <div class="grid grid-cols-2 gap-4 text-sm">
              <div>
                <span class="text-gray-600">總事件數：</span>
                <span id="total-events" class="font-medium">0</span>
              </div>
              <div>
                <span class="text-gray-600">會話數：</span>
                <span id="session-count" class="font-medium">0</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script is:inline define:vars={{ t }}>
  document.addEventListener('DOMContentLoaded', function() {
    const toggleButton = document.getElementById('analytics-toggle');
    const clearButton = document.getElementById('clear-analytics-data');
    const statusElement = document.getElementById('analytics-status');
    const statsElement = document.getElementById('analytics-stats');
    
    // 更新 UI 狀態
    function updateUI() {
      const isOptedOut = localStorage.getItem('analytics_opt_out') === 'true';
      
      if (isOptedOut) {
        statusElement.textContent = t.disabled;
        statusElement.className = 'text-sm font-medium text-red-600';
        toggleButton.innerHTML = `
          <svg class="h-4 w-4 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
          </svg>
          ${t.optIn}
        `;
      } else {
        statusElement.textContent = t.enabled;
        statusElement.className = 'text-sm font-medium text-green-600';
        toggleButton.innerHTML = `
          <svg class="h-4 w-4 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728L5.636 5.636m12.728 12.728L5.636 5.636" />
          </svg>
          ${t.optOut}
        `;
      }
      
      // 顯示統計資訊
      updateStats();
    }
    
    // 更新統計資訊
    function updateStats() {
      if (window.medicalAnalytics && window.medicalAnalytics.getLocalStats) {
        const stats = window.medicalAnalytics.getLocalStats();
        document.getElementById('total-events').textContent = stats.totalEvents;
        document.getElementById('session-count').textContent = stats.sessionCount;
        statsElement.classList.remove('hidden');
      }
    }
    
    // 切換分析狀態
    toggleButton.addEventListener('click', function() {
      if (window.medicalAnalytics) {
        const isOptedOut = localStorage.getItem('analytics_opt_out') === 'true';
        
        if (isOptedOut) {
          window.medicalAnalytics.optIn();
        } else {
          window.medicalAnalytics.optOut();
        }
        
        updateUI();
      }
    });
    
    // 清除本地資料
    clearButton.addEventListener('click', function() {
      if (confirm('確定要清除所有本地分析資料嗎？')) {
        if (window.medicalAnalytics) {
          window.medicalAnalytics.clearLocalData();
        }
        updateUI();
      }
    });
    
    // 等待分析初始化
    window.addEventListener('analytics:initialized', function() {
      updateUI();
    });
    
    // 初始化 UI
    updateUI();
  });
</script>

<style>
  .privacy-controls {
    transition: all 0.2s ease-in-out;
  }
  
  .privacy-controls:hover {
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
  }
  
  button {
    transition: all 0.2s ease-in-out;
  }
  
  button:hover {
    transform: translateY(-1px);
  }
  
  button:active {
    transform: translateY(0);
  }
</style>