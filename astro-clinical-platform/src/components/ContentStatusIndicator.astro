---
/**
 * å…§å®¹ç‹€æ…‹æŒ‡ç¤ºå™¨çµ„ä»¶
 * åœ¨é–‹ç™¼ç’°å¢ƒé¡¯ç¤ºæ–‡ç« ç‹€æ…‹ã€å¯©æ ¸é€²åº¦ç­‰è³‡è¨Š
 * 
 * æ›´æ–°æ—¥æœŸï¼š2025-01-30
 * æ›´æ–°å…§å®¹ï¼šæ–°å¢ SOP å·¥ä½œæµç¨‹ç‹€æ…‹é¡¯ç¤º
 * 
 * éœ€æ±‚å°æ‡‰ï¼š
 * - éœ€æ±‚ 6.1: ç‰ˆæœ¬æ§åˆ¶å’Œè¿½è¹¤ç³»çµ± âœ“
 * - éœ€æ±‚ 6.2: ç‰ˆæœ¬æ­·å²å±•ç¤ºä»‹é¢ âœ“
 */

import { formatDate } from '../utils/i18n';
import type { SupportedLocale, ArticleStatus, ReviewDecision } from '../env.d';

interface Props {
  status: ArticleStatus;
  version?: string;
  lastUpdated?: string;
  reviewHistory?: Array<{
    reviewer: string;
    reviewDate: string;
    decision: ReviewDecision;
    comments?: string;
  }>;
  qualityChecks?: {
    structureCheck: boolean;
    contentCheck: boolean;
    medicalAccuracyCheck: boolean;
    seoCheck: boolean;
    accessibilityCheck: boolean;
    referencesCheck: boolean;
    lastCheckedDate?: string;
    checkedBy?: string;
  };
  workflowTimestamps?: {
    createdAt?: string;
    submittedForReview?: string;
    reviewStarted?: string;
    reviewCompleted?: string;
    qualityCheckStarted?: string;
    qualityCheckCompleted?: string;
    publishedAt?: string;
    lastModified?: string;
  };
  locale?: SupportedLocale;
  showDetails?: boolean;
}

const {
  status,
  version,
  lastUpdated,
  reviewHistory = [],
  qualityChecks,
  workflowTimestamps,
  locale = 'zh-TW',
  showDetails = false
} = Astro.props;

const isDevelopment = import.meta.env.DEV;

// å¦‚æœä¸æ˜¯é–‹ç™¼ç’°å¢ƒï¼Œä¸é¡¯ç¤ºä»»ä½•å…§å®¹
if (!isDevelopment) {
  return null;
}

// ç‹€æ…‹é…ç½®
const statusConfig = {
  'draft': { 
    label: 'è‰ç¨¿', 
    color: 'bg-gray-100 text-gray-800 border-gray-300',
    icon: 'ğŸ“',
    description: 'å…§å®¹æ­£åœ¨ç·¨è¼¯ä¸­'
  },
  'in-review': { 
    label: 'å¯©æ ¸ä¸­', 
    color: 'bg-blue-100 text-blue-800 border-blue-300',
    icon: 'ğŸ‘€',
    description: 'ç­‰å¾…å¯©æ ¸è€…æª¢è¦–'
  },
  'needs-revision': { 
    label: 'éœ€ä¿®æ”¹', 
    color: 'bg-yellow-100 text-yellow-800 border-yellow-300',
    icon: 'âœï¸',
    description: 'éœ€è¦æ ¹æ“šå¯©æ ¸æ„è¦‹ä¿®æ”¹'
  },
  'quality-check': { 
    label: 'å“è³ªæª¢æŸ¥', 
    color: 'bg-purple-100 text-purple-800 border-purple-300',
    icon: 'ğŸ”',
    description: 'æ­£åœ¨é€²è¡Œå“è³ªæª¢æŸ¥'
  },
  'ready-to-publish': { 
    label: 'æº–å‚™ç™¼å¸ƒ', 
    color: 'bg-orange-100 text-orange-800 border-orange-300',
    icon: 'ğŸš€',
    description: 'å·²é€šéæ‰€æœ‰æª¢æŸ¥ï¼Œæº–å‚™ç™¼å¸ƒ'
  },
  'published': { 
    label: 'å·²ç™¼å¸ƒ', 
    color: 'bg-green-100 text-green-800 border-green-300',
    icon: 'âœ…',
    description: 'å…§å®¹å·²å…¬é–‹ç™¼å¸ƒ'
  }
};

const currentStatus = statusConfig[status] || statusConfig['draft'];

// è¨ˆç®—å“è³ªæª¢æŸ¥å®Œæˆåº¦
const qualityScore = qualityChecks ? 
  Object.values(qualityChecks).filter((check, index) => 
    index < 6 && check === true // åªè¨ˆç®—å‰6å€‹æª¢æŸ¥é …ç›®
  ).length : 0;

const totalQualityChecks = 6;
const qualityPercentage = qualityChecks ? Math.round((qualityScore / totalQualityChecks) * 100) : 0;

// å¯©æ ¸é€²åº¦
const approvedReviews = reviewHistory.filter(r => r.decision === 'approved').length;
const totalReviews = reviewHistory.length;
---

<!-- é–‹ç™¼ç’°å¢ƒç‹€æ…‹æŒ‡ç¤ºå™¨ -->
<div class="fixed top-4 right-4 z-50 max-w-sm">
  <div class={`border-2 rounded-lg p-4 bg-white shadow-lg ${currentStatus.color}`}>
    <!-- ç‹€æ…‹æ¨™é ­ -->
    <div class="flex items-center justify-between mb-3">
      <div class="flex items-center space-x-2">
        <span class="text-lg">{currentStatus.icon}</span>
        <span class="font-semibold text-sm">{currentStatus.label}</span>
      </div>
      {version && (
        <span class="text-xs bg-white bg-opacity-50 px-2 py-1 rounded">
          v{version}
        </span>
      )}
    </div>
    
    <!-- ç‹€æ…‹æè¿° -->
    <p class="text-xs mb-3 opacity-80">
      {currentStatus.description}
    </p>
    
    <!-- é€²åº¦æŒ‡æ¨™ -->
    {(status === 'in-review' || status === 'quality-check') && (
      <div class="space-y-2 mb-3">
        {/* å¯©æ ¸é€²åº¦ */}
        {status === 'in-review' && totalReviews > 0 && (
          <div>
            <div class="flex justify-between text-xs mb-1">
              <span>å¯©æ ¸é€²åº¦</span>
              <span>{approvedReviews}/{totalReviews}</span>
            </div>
            <div class="w-full bg-white bg-opacity-30 rounded-full h-2">
              <div 
                class="bg-current h-2 rounded-full transition-all duration-300"
                style={`width: ${totalReviews > 0 ? (approvedReviews / totalReviews) * 100 : 0}%`}
              ></div>
            </div>
          </div>
        )}
        
        {/* å“è³ªæª¢æŸ¥é€²åº¦ */}
        {status === 'quality-check' && qualityChecks && (
          <div>
            <div class="flex justify-between text-xs mb-1">
              <span>å“è³ªæª¢æŸ¥</span>
              <span>{qualityScore}/{totalQualityChecks}</span>
            </div>
            <div class="w-full bg-white bg-opacity-30 rounded-full h-2">
              <div 
                class="bg-current h-2 rounded-full transition-all duration-300"
                style={`width: ${qualityPercentage}%`}
              ></div>
            </div>
          </div>
        )}
      </div>
    )}
    
    <!-- æ™‚é–“è³‡è¨Š -->
    <div class="text-xs space-y-1">
      {lastUpdated && (
        <div class="flex justify-between">
          <span class="opacity-70">æœ€å¾Œæ›´æ–°:</span>
          <span>{formatDate(lastUpdated, locale, 'short')}</span>
        </div>
      )}
      
      {workflowTimestamps?.publishedAt && (
        <div class="flex justify-between">
          <span class="opacity-70">ç™¼å¸ƒæ™‚é–“:</span>
          <span>{formatDate(workflowTimestamps.publishedAt, locale, 'short')}</span>
        </div>
      )}
      
      {workflowTimestamps?.submittedForReview && status !== 'published' && (
        <div class="flex justify-between">
          <span class="opacity-70">æäº¤å¯©æ ¸:</span>
          <span>{formatDate(workflowTimestamps.submittedForReview, locale, 'short')}</span>
        </div>
      )}
    </div>
    
    <!-- è©³ç´°è³‡è¨Šåˆ‡æ› -->
    {showDetails && (reviewHistory.length > 0 || qualityChecks) && (
      <details class="mt-3">
        <summary class="text-xs cursor-pointer hover:opacity-80 select-none">
          è©³ç´°è³‡è¨Š â–¼
        </summary>
        
        <div class="mt-2 space-y-2 text-xs">
          {/* æœ€è¿‘å¯©æ ¸ */}
          {reviewHistory.length > 0 && (
            <div>
              <div class="font-medium mb-1">æœ€è¿‘å¯©æ ¸:</div>
              {reviewHistory.slice(0, 2).map((review, index) => (
                <div key={index} class="bg-white bg-opacity-30 rounded p-2 mb-1">
                  <div class="flex justify-between items-center mb-1">
                    <span class="font-medium">{review.reviewer}</span>
                    <span class={`px-1 py-0.5 rounded text-xs ${
                      review.decision === 'approved' ? 'bg-green-200 text-green-800' :
                      review.decision === 'rejected' ? 'bg-red-200 text-red-800' :
                      'bg-yellow-200 text-yellow-800'
                    }`}>
                      {review.decision === 'approved' ? 'é€šé' :
                       review.decision === 'rejected' ? 'æ‹’çµ•' : 'éœ€ä¿®æ”¹'}
                    </span>
                  </div>
                  <div class="text-xs opacity-70">
                    {formatDate(review.reviewDate, locale, 'short')}
                  </div>
                  {review.comments && (
                    <div class="text-xs mt-1 opacity-80 line-clamp-2">
                      {review.comments}
                    </div>
                  )}
                </div>
              ))}
            </div>
          )}
          
          {/* å“è³ªæª¢æŸ¥è©³æƒ… */}
          {qualityChecks && (
            <div>
              <div class="font-medium mb-1">å“è³ªæª¢æŸ¥:</div>
              <div class="grid grid-cols-2 gap-1 text-xs">
                <div class={`flex items-center ${qualityChecks.structureCheck ? 'text-green-700' : 'text-red-700'}`}>
                  <span class="mr-1">{qualityChecks.structureCheck ? 'âœ“' : 'âœ—'}</span>
                  çµæ§‹
                </div>
                <div class={`flex items-center ${qualityChecks.contentCheck ? 'text-green-700' : 'text-red-700'}`}>
                  <span class="mr-1">{qualityChecks.contentCheck ? 'âœ“' : 'âœ—'}</span>
                  å…§å®¹
                </div>
                <div class={`flex items-center ${qualityChecks.medicalAccuracyCheck ? 'text-green-700' : 'text-red-700'}`}>
                  <span class="mr-1">{qualityChecks.medicalAccuracyCheck ? 'âœ“' : 'âœ—'}</span>
                  é†«ç™‚
                </div>
                <div class={`flex items-center ${qualityChecks.seoCheck ? 'text-green-700' : 'text-red-700'}`}>
                  <span class="mr-1">{qualityChecks.seoCheck ? 'âœ“' : 'âœ—'}</span>
                  SEO
                </div>
                <div class={`flex items-center ${qualityChecks.accessibilityCheck ? 'text-green-700' : 'text-red-700'}`}>
                  <span class="mr-1">{qualityChecks.accessibilityCheck ? 'âœ“' : 'âœ—'}</span>
                  ç„¡éšœç¤™
                </div>
                <div class={`flex items-center ${qualityChecks.referencesCheck ? 'text-green-700' : 'text-red-700'}`}>
                  <span class="mr-1">{qualityChecks.referencesCheck ? 'âœ“' : 'âœ—'}</span>
                  åƒè€ƒ
                </div>
              </div>
              {qualityChecks.lastCheckedDate && (
                <div class="text-xs opacity-70 mt-1">
                  æª¢æŸ¥æ™‚é–“: {formatDate(qualityChecks.lastCheckedDate, locale, 'short')}
                </div>
              )}
            </div>
          )}
        </div>
      </details>
    )}
  </div>
</div>

<style>
  .line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
  
  details[open] summary {
    margin-bottom: 0.5rem;
  }
  
  details summary::-webkit-details-marker {
    display: none;
  }
</style>