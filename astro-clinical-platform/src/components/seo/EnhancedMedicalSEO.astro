---
/**
 * Enhanced Medical SEO Component
 * 增強的醫療 SEO 組件 - 整合 Schema.org 醫療標記和完整的 SEO 優化
 */

import type { MedicalContentSEO } from '../../utils/medical-seo';
import { 
  generateMedicalWebPageSchema,
  generateCalculatorSchema,
  generateMedicalArticleSchema,
  generateMedicalMetaTags,
  generateCanonicalUrl,
  generateHreflangTags,
  generateMedicalOrganizationSchema,
  generateMedicalBreadcrumbSchema,
  type CalculatorSEO
} from '../../utils/medical-seo';

export interface Props {
  // 基本 SEO 屬性
  title: string;
  description: string;
  canonical?: string;
  noindex?: boolean;
  nofollow?: boolean;
  
  // 醫療內容特定屬性
  medicalContent?: MedicalContentSEO;
  calculatorSEO?: CalculatorSEO;
  
  // 文章特定屬性
  article?: {
    author: string;
    datePublished: string;
    dateModified?: string;
    category: string;
    tags: string[];
    medicalConditions?: string[];
    treatments?: string[];
  };
  
  // 麵包屑導航
  breadcrumbs?: Array<{
    name: string;
    url: string;
  }>;
  
  // FAQ 數據
  faqs?: Array<{
    question: string;
    answer: string;
  }>;
  
  // Open Graph 圖片
  ogImage?: {
    url: string;
    width?: number;
    height?: number;
    alt?: string;
  };
  
  // Twitter Card 設定
  twitterCard?: {
    card?: 'summary' | 'summary_large_image' | 'app' | 'player';
    site?: string;
    creator?: string;
  };
  
  // 多語言支援
  locale?: string;
  alternateLocales?: string[];
  
  // 額外的 meta tags
  additionalMetaTags?: Record<string, string>;
  
  // 結構化數據選項
  includeOrganization?: boolean;
  includeBreadcrumbs?: boolean;
  includeFAQ?: boolean;
}

const {
  title,
  description,
  canonical,
  noindex = false,
  nofollow = false,
  medicalContent,
  calculatorSEO,
  article,
  breadcrumbs,
  faqs,
  ogImage,
  twitterCard,
  locale = 'en',
  alternateLocales = ['en', 'zh-TW', 'ja'],
  additionalMetaTags = {},
  includeOrganization = true,
  includeBreadcrumbs = true,
  includeFAQ = true
} = Astro.props;

// 獲取當前 URL 和站點配置
const currentUrl = new URL(Astro.request.url);
const siteUrl = import.meta.env.PUBLIC_SITE_URL || currentUrl.origin;
const canonicalUrl = canonical || currentUrl.href;

// 生成基本 meta tags
const baseMeta = medicalContent 
  ? generateMedicalMetaTags(medicalContent)
  : {
      'title': title,
      'description': description,
      'robots': `${noindex ? 'noindex' : 'index'}, ${nofollow ? 'nofollow' : 'follow'}`,
      'viewport': 'width=device-width, initial-scale=1.0',
      'charset': 'UTF-8'
    };

// 生成 hreflang tags
const hreflangTags = generateHreflangTags(siteUrl, currentUrl.pathname, alternateLocales);

// 準備結構化數據
const structuredData: object[] = [];

// 添加醫療內容 schema
if (medicalContent) {
  structuredData.push(generateMedicalWebPageSchema(medicalContent));
}

// 添加計算器 schema
if (calculatorSEO) {
  structuredData.push(generateCalculatorSchema(calculatorSEO));
}

// 添加文章 schema
if (article) {
  structuredData.push(generateMedicalArticleSchema({
    ...article,
    title,
    description,
    url: canonicalUrl
  }));
}

// 添加組織 schema
if (includeOrganization) {
  structuredData.push(generateMedicalOrganizationSchema());
}

// 添加麵包屑 schema
if (includeBreadcrumbs && breadcrumbs && breadcrumbs.length > 0) {
  structuredData.push(generateMedicalBreadcrumbSchema(breadcrumbs));
}

// 添加 FAQ schema
if (includeFAQ && faqs && faqs.length > 0) {
  const { generateMedicalFAQSchema } = await import('../../utils/medical-seo');
  structuredData.push(generateMedicalFAQSchema(faqs));
}

// 合併所有 meta tags
const allMetaTags = {
  ...baseMeta,
  ...additionalMetaTags
};

// Open Graph 設定
const ogData = {
  type: 'website',
  title: title,
  description: description,
  url: canonicalUrl,
  site_name: 'Astro Clinical Platform',
  locale: locale.replace('-', '_'),
  image: ogImage?.url || '/og-medical-default.jpg',
  image_width: ogImage?.width || 1200,
  image_height: ogImage?.height || 630,
  image_alt: ogImage?.alt || `${title} - Medical Information`
};

// Twitter Card 設定
const twitterData = {
  card: twitterCard?.card || 'summary_large_image',
  site: twitterCard?.site || '@astroclinical',
  creator: twitterCard?.creator || '@astroclinical',
  title: title,
  description: description,
  image: ogImage?.url || '/twitter-medical-default.jpg',
  image_alt: ogData.image_alt
};
---

<!-- 基本 Meta Tags -->
<title>{title}</title>
<meta name="description" content={description} />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<meta charset="UTF-8" />

<!-- Robots Meta -->
<meta name="robots" content={`${noindex ? 'noindex' : 'index'}, ${nofollow ? 'nofollow' : 'follow'}, max-snippet:-1, max-image-preview:large, max-video-preview:-1`} />

<!-- Canonical URL -->
<link rel="canonical" href={canonicalUrl} />

<!-- Hreflang Tags -->
{hreflangTags.map(({ hreflang, href }) => (
  <link rel="alternate" hreflang={hreflang} href={href} />
))}

<!-- 醫療特定 Meta Tags -->
{medicalContent && (
  <>
    <meta name="medical:audience" content={medicalContent.medicalAudience || 'Clinician'} />
    <meta name="medical:specialty" content={medicalContent.medicalSpecialty?.join(', ') || 'General Medicine'} />
    <meta name="medical:last-reviewed" content={medicalContent.lastReviewed || new Date().toISOString().split('T')[0]} />
    <meta name="medical:content-type" content={medicalContent.type} />
    {medicalContent.evidenceLevel && (
      <meta name="medical:evidence-level" content={medicalContent.evidenceLevel} />
    )}
    {medicalContent.reviewedBy && (
      <meta name="medical:reviewed-by" content={medicalContent.reviewedBy.name} />
    )}
  </>
)}

<!-- 額外的 Meta Tags -->
{Object.entries(allMetaTags).map(([name, content]) => (
  name !== 'title' && name !== 'description' && (
    <meta name={name} content={content} />
  )
))}

<!-- Open Graph Tags -->
<meta property="og:type" content={ogData.type} />
<meta property="og:title" content={ogData.title} />
<meta property="og:description" content={ogData.description} />
<meta property="og:url" content={ogData.url} />
<meta property="og:site_name" content={ogData.site_name} />
<meta property="og:locale" content={ogData.locale} />
<meta property="og:image" content={ogData.image} />
<meta property="og:image:width" content={ogData.image_width.toString()} />
<meta property="og:image:height" content={ogData.image_height.toString()} />
<meta property="og:image:alt" content={ogData.image_alt} />

<!-- Twitter Card Tags -->
<meta name="twitter:card" content={twitterData.card} />
<meta name="twitter:site" content={twitterData.site} />
<meta name="twitter:creator" content={twitterData.creator} />
<meta name="twitter:title" content={twitterData.title} />
<meta name="twitter:description" content={twitterData.description} />
<meta name="twitter:image" content={twitterData.image} />
<meta name="twitter:image:alt" content={twitterData.image_alt} />

<!-- 醫療文章特定 Open Graph -->
{article && (
  <>
    <meta property="article:author" content={article.author} />
    <meta property="article:published_time" content={article.datePublished} />
    {article.dateModified && (
      <meta property="article:modified_time" content={article.dateModified} />
    )}
    <meta property="article:section" content={article.category} />
    {article.tags.map(tag => (
      <meta property="article:tag" content={tag} />
    ))}
  </>
)}

<!-- Favicon and App Icons -->
<link rel="icon" type="image/svg+xml" href="/favicon.svg" />
<link rel="icon" type="image/png" href="/favicon.png" />
<link rel="apple-touch-icon" href="/apple-touch-icon.png" />
<link rel="manifest" href="/manifest.json" />

<!-- DNS Prefetch for Performance -->
<link rel="dns-prefetch" href="//fonts.googleapis.com" />
<link rel="dns-prefetch" href="//www.google-analytics.com" />
<link rel="dns-prefetch" href="//plausible.io" />

<!-- Preconnect for Critical Resources -->
<link rel="preconnect" href="https://fonts.googleapis.com" />
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />

<!-- 結構化數據 (JSON-LD) -->
{structuredData.length > 0 && (
  <script type="application/ld+json" set:html={JSON.stringify(structuredData)} />
)}

<!-- 醫療免責聲明 -->
<meta name="medical:disclaimer" content="This information is for educational purposes only and should not replace professional medical advice. Always consult with a qualified healthcare provider." />

<!-- 內容安全政策 -->
<meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://plausible.io https://www.google-analytics.com; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src 'self' https://fonts.gstatic.com; img-src 'self' data: https:; connect-src 'self' https://plausible.io https://www.google-analytics.com;" />

<!-- 權限政策 -->
<meta http-equiv="Permissions-Policy" content="camera=(), microphone=(), geolocation=(), interest-cohort=()" />

<!-- 推薦的安全標頭 -->
<meta http-equiv="X-Content-Type-Options" content="nosniff" />
<meta http-equiv="X-Frame-Options" content="DENY" />
<meta http-equiv="X-XSS-Protection" content="1; mode=block" />
<meta http-equiv="Referrer-Policy" content="strict-origin-when-cross-origin" />

<!-- 主題顏色 -->
<meta name="theme-color" content="#3B82F6" />
<meta name="msapplication-TileColor" content="#3B82F6" />

<!-- 搜尋引擎驗證 (如果需要) -->
<!-- <meta name="google-site-verification" content="your-verification-code" /> -->
<!-- <meta name="bing-site-verification" content="your-verification-code" /> -->

<style>
  /* 確保 SEO 相關的樣式不會影響頁面渲染 */
  [data-seo-hidden] {
    display: none !important;
  }
</style>

<script>
  // 客戶端 SEO 增強功能
  document.addEventListener('DOMContentLoaded', function() {
    // 添加結構化數據驗證 (開發環境)
    if (import.meta.env.DEV) {
      const structuredDataScripts = document.querySelectorAll('script[type="application/ld+json"]');
      structuredDataScripts.forEach((script, index) => {
        try {
          const data = JSON.parse(script.textContent || '');
          console.log(`Structured Data ${index + 1}:`, data);
        } catch (error) {
          console.error(`Invalid JSON-LD in script ${index + 1}:`, error);
        }
      });
    }

    // 添加醫療內容的可訪問性增強
    const medicalContent = document.querySelector('[data-medical-content]');
    if (medicalContent) {
      // 添加醫療內容的 ARIA 標籤
      medicalContent.setAttribute('role', 'main');
      medicalContent.setAttribute('aria-label', 'Medical information content');
      
      // 為醫療術語添加定義
      const medicalTerms = medicalContent.querySelectorAll('[data-medical-term]');
      medicalTerms.forEach(term => {
        const definition = term.getAttribute('data-definition');
        if (definition) {
          term.setAttribute('title', definition);
          term.setAttribute('aria-describedby', `definition-${term.textContent?.replace(/\s+/g, '-').toLowerCase()}`);
        }
      });
    }

    // 添加醫療計算器的可訪問性
    const calculators = document.querySelectorAll('[data-calculator]');
    calculators.forEach(calculator => {
      calculator.setAttribute('role', 'application');
      calculator.setAttribute('aria-label', 'Medical calculator tool');
      
      // 為計算器結果添加 live region
      const results = calculator.querySelector('[data-calculator-result]');
      if (results) {
        results.setAttribute('aria-live', 'polite');
        results.setAttribute('aria-atomic', 'true');
      }
    });
  });
</script>