name: ðŸ·ï¸ PR è‡ªå‹•æ¨™ç±¤

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  label:
    runs-on: ubuntu-latest
    name: ðŸ·ï¸ è‡ªå‹•æ·»åŠ æ¨™ç±¤
    
    steps:
    - name: æ‡‰ç”¨æ¨™ç±¤
      uses: actions/labeler@v4
      with:
        repo-token: "${{ secrets.GITHUB_TOKEN }}"
        configuration-path: .github/labeler.yml

    - name: åˆ†æž PR å…§å®¹ä¸¦æ·»åŠ ç‰¹æ®Šæ¨™ç±¤
      uses: actions/github-script@v6
      with:
        script: |
          const { data: pr } = await github.rest.pulls.get({
            owner: context.repo.owner,
            repo: context.repo.repo,
            pull_number: context.issue.number
          });
          
          const title = pr.title.toLowerCase();
          const body = pr.body ? pr.body.toLowerCase() : '';
          const labels = [];
          
          // æ ¹æ“š PR æ¨™é¡Œå’Œå…§å®¹åˆ†æžæ·»åŠ æ¨™ç±¤
          
          // PR é¡žåž‹æ¨™ç±¤
          if (title.includes('æ–°å¢ž') || title.includes('new') || title.includes('add')) {
            labels.push('type: new-content');
          }
          
          if (title.includes('æ›´æ–°') || title.includes('update') || title.includes('ä¿®æ”¹')) {
            labels.push('type: content-update');
          }
          
          if (title.includes('ä¿®æ­£') || title.includes('fix') || title.includes('éŒ¯èª¤')) {
            labels.push('type: bug-fix');
          }
          
          if (title.includes('ç¿»è­¯') || title.includes('translation') || title.includes('å¤šèªžè¨€')) {
            labels.push('type: translation');
          }
          
          // å„ªå…ˆç´šæ¨™ç±¤
          if (title.includes('ç·Šæ€¥') || title.includes('urgent') || title.includes('critical')) {
            labels.push('priority: high');
          }
          
          if (title.includes('é‡è¦') || title.includes('important')) {
            labels.push('priority: medium');
          }
          
          // ç‰¹æ®Šé—œæ³¨æ¨™ç±¤
          if (body.includes('è—¥ç‰©') || body.includes('medication') || body.includes('drug')) {
            labels.push('needs-pharmacist-review');
          }
          
          if (body.includes('æ‰‹è¡“') || body.includes('surgery') || body.includes('operation')) {
            labels.push('needs-surgeon-review');
          }
          
          if (body.includes('å…’ç«¥') || body.includes('child') || body.includes('pediatric')) {
            labels.push('needs-pediatrician-review');
          }
          
          if (body.includes('å¿ƒç†') || body.includes('mental') || body.includes('psychiatric')) {
            labels.push('needs-psychiatrist-review');
          }
          
          if (body.includes('ç‡Ÿé¤Š') || body.includes('nutrition') || body.includes('diet')) {
            labels.push('needs-nutritionist-review');
          }
          
          if (body.includes('å¾©å¥') || body.includes('rehabilitation') || body.includes('physical therapy')) {
            labels.push('needs-physiotherapist-review');
          }
          
          if (body.includes('è­·ç†') || body.includes('nursing') || body.includes('care')) {
            labels.push('needs-nurse-review');
          }
          
          // å“è³ªç›¸é—œæ¨™ç±¤
          if (body.includes('å“è³ªæª¢æŸ¥') || body.includes('quality check')) {
            labels.push('quality-related');
          }
          
          if (body.includes('ç„¡éšœç¤™') || body.includes('accessibility')) {
            labels.push('accessibility-related');
          }
          
          if (body.includes('åƒè€ƒæ–‡ç»') || body.includes('references')) {
            labels.push('references-related');
          }
          
          // æ‡‰ç”¨æ¨™ç±¤
          if (labels.length > 0) {
            await github.rest.issues.addLabels({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: labels
            });
          }

    - name: æª¢æŸ¥æ˜¯å¦éœ€è¦ç‰¹æ®Šå¯©æ ¸
      uses: actions/github-script@v6
      with:
        script: |
          const { data: files } = await github.rest.pulls.listFiles({
            owner: context.repo.owner,
            repo: context.repo.repo,
            pull_number: context.issue.number
          });
          
          const reviewers = new Set();
          const labels = [];
          
          // åˆ†æžè®Šæ›´çš„æª”æ¡ˆ
          files.forEach(file => {
            const filename = file.filename.toLowerCase();
            const patch = file.patch ? file.patch.toLowerCase() : '';
            
            // æª¢æŸ¥æ˜¯å¦æ¶‰åŠæ•æ„Ÿé†«ç™‚å…§å®¹
            const sensitiveKeywords = [
              'medication', 'drug', 'prescription', 'dosage',
              'surgery', 'operation', 'procedure',
              'emergency', 'critical', 'urgent',
              'diagnosis', 'treatment', 'therapy'
            ];
            
            const hasSensitiveContent = sensitiveKeywords.some(keyword => 
              filename.includes(keyword) || patch.includes(keyword)
            );
            
            if (hasSensitiveContent) {
              labels.push('needs-medical-review');
              reviewers.add('medical-advisors');
            }
            
            // æª¢æŸ¥å°ˆç§‘ç‰¹å®šå…§å®¹
            if (filename.includes('cardiology') || patch.includes('heart') || patch.includes('cardiac')) {
              reviewers.add('cardiology-reviewer');
            }
            
            if (filename.includes('neurology') || patch.includes('brain') || patch.includes('neurological')) {
              reviewers.add('neurology-reviewer');
            }
            
            if (filename.includes('pediatrics') || patch.includes('child') || patch.includes('infant')) {
              reviewers.add('pediatrics-reviewer');
            }
            
            if (filename.includes('emergency') || patch.includes('emergency') || patch.includes('urgent')) {
              reviewers.add('emergency-reviewer');
            }
            
            if (filename.includes('orthopedics') || patch.includes('bone') || patch.includes('joint')) {
              reviewers.add('orthopedics-reviewer');
            }
          });
          
          // æ‡‰ç”¨æ¨™ç±¤
          if (labels.length > 0) {
            await github.rest.issues.addLabels({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: labels
            });
          }
          
          // è«‹æ±‚å¯©æ ¸è€…
          if (reviewers.size > 0) {
            try {
              await github.rest.pulls.requestReviewers({
                pull_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                reviewers: Array.from(reviewers)
              });
            } catch (error) {
              console.log('ç„¡æ³•è‡ªå‹•æŒ‡æ´¾å¯©æ ¸è€…:', error.message);
            }
          }