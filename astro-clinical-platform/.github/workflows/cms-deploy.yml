name: CMS éƒ¨ç½²å·¥ä½œæµç¨‹

on:
  push:
    branches: [ main, master ]
    paths:
      - 'src/content/**'
      - 'public/admin/**'
      - 'astro.config.mjs'
      - 'package.json'
  pull_request:
    branches: [ main, master ]
    paths:
      - 'src/content/**'
      - 'public/admin/**'
      - 'astro.config.mjs'
      - 'package.json'

jobs:
  # å…§å®¹é©—è­‰å·¥ä½œ - èˆ‡å…§å®¹å“è³ªæª¢æŸ¥å·¥ä½œæµç¨‹æ•´åˆ
  validate-content:
    runs-on: ubuntu-latest
    name: é©—è­‰å…§å®¹æ ¼å¼
    
    steps:
    - name: æª¢å‡ºç¨‹å¼ç¢¼
      uses: actions/checkout@v4
      
    - name: è¨­å®š Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: å®‰è£ä¾è³´
      run: npm ci
      
    - name: é©—è­‰ Content Collections
      run: npm run astro check
      
    - name: æª¢æŸ¥ Markdown æ ¼å¼
      run: |
        echo "æª¢æŸ¥ Markdown æª”æ¡ˆæ ¼å¼..."
        find src/content -name "*.md" -type f | while read file; do
          echo "æª¢æŸ¥: $file"
          # åŸºæœ¬æ ¼å¼æª¢æŸ¥
          if ! head -n 10 "$file" | grep -q "^---$"; then
            echo "âš ï¸ $file: å¯èƒ½ç¼ºå°‘ frontmatter"
          fi
        done
        
    - name: é©—è­‰ CMS é…ç½®
      run: |
        # æª¢æŸ¥ CMS é…ç½®æª”æ¡ˆ
        if [ -f "public/admin/config.yml" ]; then
          echo "âœ… CMS é…ç½®æª”æ¡ˆå­˜åœ¨"
        else
          echo "âŒ CMS é…ç½®æª”æ¡ˆä¸å­˜åœ¨"
          exit 1
        fi
        
        # æª¢æŸ¥æ¨¡æ¿æª”æ¡ˆ
        if [ -d "src/content/templates" ]; then
          echo "âœ… å…§å®¹æ¨¡æ¿ç›®éŒ„å­˜åœ¨"
        else
          echo "âš ï¸ å…§å®¹æ¨¡æ¿ç›®éŒ„ä¸å­˜åœ¨"
        fi

  # å»ºç½®å’Œéƒ¨ç½²å·¥ä½œ
  build-and-deploy:
    runs-on: ubuntu-latest
    needs: validate-content
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    name: å»ºç½®å’Œéƒ¨ç½²
    
    steps:
    - name: æª¢å‡ºç¨‹å¼ç¢¼
      uses: actions/checkout@v4
      
    - name: è¨­å®š Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: å®‰è£ä¾è³´
      run: npm ci
      
    - name: å»ºç½®å°ˆæ¡ˆ
      run: npm run build
      env:
        SITE_URL: ${{ secrets.SITE_URL }}
        
    - name: éƒ¨ç½²åˆ° Cloudflare Pages
      uses: cloudflare/pages-action@v1
      with:
        apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
        accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        projectName: astro-clinical-platform
        directory: dist
        gitHubToken: ${{ secrets.GITHUB_TOKEN }}

  # é€šçŸ¥å·¥ä½œ
  notify:
    runs-on: ubuntu-latest
    needs: [validate-content, build-and-deploy]
    if: always()
    name: ç™¼é€é€šçŸ¥
    
    steps:
    - name: é€šçŸ¥éƒ¨ç½²çµæœ
      if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
      run: |
        echo "## CMS éƒ¨ç½²çµæœæ‘˜è¦"
        echo "- å…§å®¹é©—è­‰: ${{ needs.validate-content.result }}"
        if [ "${{ needs.build-and-deploy.result }}" = "success" ]; then
          echo "- å»ºç½®éƒ¨ç½²: âœ… æˆåŠŸ"
          echo ""
          echo "ğŸ‰ è¡›æ•™å…§å®¹å·²æˆåŠŸéƒ¨ç½²åˆ°ç”Ÿç”¢ç’°å¢ƒ"
          echo "ğŸ“ è«‹æª¢æŸ¥ç¶²ç«™å…§å®¹æ˜¯å¦æ­£ç¢ºé¡¯ç¤º"
        else
          echo "- å»ºç½®éƒ¨ç½²: âŒ å¤±æ•—"
          echo ""
          echo "âš ï¸ éƒ¨ç½²å¤±æ•—ï¼Œè«‹æª¢æŸ¥å»ºç½®æ—¥èªŒ"
          echo "ğŸ”§ å¯èƒ½éœ€è¦æª¢æŸ¥ Astro é…ç½®æˆ–å…§å®¹æ ¼å¼"
        fi
        
    - name: PR éƒ¨ç½²é è¦½é€šçŸ¥
      if: github.event_name == 'pull_request'
      run: |
        echo "## PR é è¦½éƒ¨ç½²"
        echo "- å…§å®¹é©—è­‰: ${{ needs.validate-content.result }}"
        echo ""
        if [ "${{ needs.validate-content.result }}" = "success" ]; then
          echo "âœ… å…§å®¹é©—è­‰é€šéï¼Œå¯ä»¥é€²è¡Œå¯©æ ¸"
          echo "ğŸ“‹ è«‹å¯©æ ¸è€…æª¢æŸ¥ PR ä¸­çš„å…§å®¹è®Šæ›´"
        else
          echo "âŒ å…§å®¹é©—è­‰å¤±æ•—ï¼Œè«‹ä¿®æ­£å¾Œé‡æ–°æäº¤"
        fi