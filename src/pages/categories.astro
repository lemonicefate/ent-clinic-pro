---
/**
 * å…§å®¹åˆ†é¡ç¸½è¦½é é¢
 * é¡¯ç¤ºæ‰€æœ‰é†«ç™‚å…§å®¹åˆ†é¡å’Œçµ±è¨ˆ
 */

import BaseLayout from '../layouts/BaseLayout.astro';
import { contentCategorizer } from '../utils/content-categorization';
import { t } from '../utils/i18n';
import type { SupportedLocale } from '../env.d';

const locale: SupportedLocale = 'zh-TW'; // é€™è£¡æ‡‰è©²å¾è·¯ç”±ä¸­ç²å–

const mainCategories = contentCategorizer.getMainCategories(locale);
const categoryStats = await contentCategorizer.getCategoryStats();

const breadcrumbs = [
  { label: t('nav.home', locale), href: '/' },
  { label: 'å…§å®¹åˆ†é¡' }
];

// åˆ†é¡åœ–ç¤ºå°æ‡‰
const categoryIcons: Record<string, string> = {
  'cardiology': 'â¤ï¸',
  'neurology': 'ğŸ§ ',
  'emergency': 'ğŸš¨',
  'internal-medicine': 'ğŸ©º',
  'surgery': 'ğŸ”ª',
  'pediatrics': 'ğŸ‘¶',
  'default': 'ğŸ“‹'
};

// åˆ†é¡é¡è‰²å°æ‡‰
const categoryColors: Record<string, string> = {
  'cardiology': 'bg-red-100 text-red-800 border-red-200',
  'neurology': 'bg-purple-100 text-purple-800 border-purple-200',
  'emergency': 'bg-orange-100 text-orange-800 border-orange-200',
  'internal-medicine': 'bg-blue-100 text-blue-800 border-blue-200',
  'surgery': 'bg-green-100 text-green-800 border-green-200',
  'pediatrics': 'bg-pink-100 text-pink-800 border-pink-200',
  'default': 'bg-gray-100 text-gray-800 border-gray-200'
};
---

<BaseLayout 
  title="é†«ç™‚å…§å®¹åˆ†é¡"
  description="ç€è¦½æ‰€æœ‰é†«ç™‚å°ˆç§‘åˆ†é¡ï¼ŒåŒ…å«è¨ˆç®—æ©Ÿã€è¡›æ•™è³‡æºå’Œè¨ºç™‚æµç¨‹"
  locale={locale}
  breadcrumbs={breadcrumbs}
>
  <main class="container mx-auto px-4 py-8">
    <!-- é é¢æ¨™é¡Œ -->
    <div class="mb-8">
      <h1 class="text-3xl font-bold text-medical-neutral-900 mb-4">
        é†«ç™‚å…§å®¹åˆ†é¡
      </h1>
      <p class="text-lg text-medical-neutral-600">
        æŒ‰é†«ç™‚å°ˆç§‘ç€è¦½æ‰€æœ‰è¨ˆç®—æ©Ÿã€è¡›æ•™è³‡æºå’Œè¨ºç™‚æµç¨‹
      </p>
    </div>

    <!-- åˆ†é¡çµ±è¨ˆç¸½è¦½ -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-12">
      <div class="bg-white rounded-lg border border-medical-neutral-200 p-6">
        <div class="flex items-center">
          <div class="flex-shrink-0">
            <div class="w-8 h-8 bg-medical-primary-100 rounded-lg flex items-center justify-center">
              ğŸ§®
            </div>
          </div>
          <div class="ml-4">
            <p class="text-sm font-medium text-medical-neutral-600">é†«ç™‚è¨ˆç®—æ©Ÿ</p>
            <p class="text-2xl font-bold text-medical-neutral-900">
              {Object.values(categoryStats).reduce((sum, stat) => sum + stat.calculators, 0)}
            </p>
          </div>
        </div>
      </div>
      
      <div class="bg-white rounded-lg border border-medical-neutral-200 p-6">
        <div class="flex items-center">
          <div class="flex-shrink-0">
            <div class="w-8 h-8 bg-medical-success-100 rounded-lg flex items-center justify-center">
              ğŸ“š
            </div>
          </div>
          <div class="ml-4">
            <p class="text-sm font-medium text-medical-neutral-600">è¡›æ•™è³‡æº</p>
            <p class="text-2xl font-bold text-medical-neutral-900">
              {Object.values(categoryStats).reduce((sum, stat) => sum + stat.education, 0)}
            </p>
          </div>
        </div>
      </div>
      
      <div class="bg-white rounded-lg border border-medical-neutral-200 p-6">
        <div class="flex items-center">
          <div class="flex-shrink-0">
            <div class="w-8 h-8 bg-medical-warning-100 rounded-lg flex items-center justify-center">
              ğŸ”„
            </div>
          </div>
          <div class="ml-4">
            <p class="text-sm font-medium text-medical-neutral-600">è¨ºç™‚æµç¨‹</p>
            <p class="text-2xl font-bold text-medical-neutral-900">
              {Object.values(categoryStats).reduce((sum, stat) => sum + stat.flowcharts, 0)}
            </p>
          </div>
        </div>
      </div>
    </div>

    <!-- ä¸»è¦åˆ†é¡åˆ—è¡¨ -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
      {mainCategories.map(category => {
        const stats = categoryStats[category.id] || { calculators: 0, education: 0, flowcharts: 0, total: 0 };
        const icon = categoryIcons[category.id] || categoryIcons.default;
        const colorClass = categoryColors[category.id] || categoryColors.default;
        const subCategories = contentCategorizer.getSubCategories(category.id, locale);
        
        return (
          <div class="bg-white rounded-lg border border-medical-neutral-200 hover:shadow-md transition-shadow">
            <div class="p-6">
              <!-- åˆ†é¡æ¨™é¡Œ -->
              <div class="flex items-center mb-4">
                <div class="text-2xl mr-3">{icon}</div>
                <div>
                  <h3 class="text-lg font-semibold text-medical-neutral-900">
                    {category.name[locale]}
                  </h3>
                  <p class="text-sm text-medical-neutral-600">
                    {category.description[locale]}
                  </p>
                </div>
              </div>

              <!-- å…§å®¹çµ±è¨ˆ -->
              <div class="grid grid-cols-3 gap-4 mb-4">
                <div class="text-center">
                  <div class="text-lg font-bold text-medical-primary-600">
                    {stats.calculators}
                  </div>
                  <div class="text-xs text-medical-neutral-500">è¨ˆç®—æ©Ÿ</div>
                </div>
                <div class="text-center">
                  <div class="text-lg font-bold text-medical-success-600">
                    {stats.education}
                  </div>
                  <div class="text-xs text-medical-neutral-500">è¡›æ•™</div>
                </div>
                <div class="text-center">
                  <div class="text-lg font-bold text-medical-warning-600">
                    {stats.flowcharts}
                  </div>
                  <div class="text-xs text-medical-neutral-500">æµç¨‹</div>
                </div>
              </div>

              <!-- å­åˆ†é¡ -->
              {subCategories.length > 0 && (
                <div class="mb-4">
                  <h4 class="text-sm font-medium text-medical-neutral-700 mb-2">å­åˆ†é¡</h4>
                  <div class="flex flex-wrap gap-2">
                    {subCategories.slice(0, 3).map(subCat => (
                      <span class={`inline-flex items-center px-2 py-1 rounded-full text-xs font-medium border ${colorClass}`}>
                        {subCat.name[locale]}
                      </span>
                    ))}
                    {subCategories.length > 3 && (
                      <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-medical-neutral-100 text-medical-neutral-600 border border-medical-neutral-200">
                        +{subCategories.length - 3} æ›´å¤š
                      </span>
                    )}
                  </div>
                </div>
              )}

              <!-- ç€è¦½æŒ‰éˆ• -->
              <div class="flex space-x-2">
                <a 
                  href={`/categories/${category.id}`}
                  class="flex-1 inline-flex items-center justify-center px-3 py-2 border border-medical-primary-300 text-sm font-medium rounded-md text-medical-primary-700 bg-medical-primary-50 hover:bg-medical-primary-100 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-medical-primary-500 transition-colors"
                >
                  ç€è¦½å…§å®¹
                </a>
                {stats.total > 0 && (
                  <a 
                    href={`/search?category=${category.id}`}
                    class="inline-flex items-center px-3 py-2 border border-medical-neutral-300 text-sm font-medium rounded-md text-medical-neutral-700 bg-white hover:bg-medical-neutral-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-medical-primary-500 transition-colors"
                    title="æœå°‹æ­¤åˆ†é¡"
                  >
                    <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                    </svg>
                  </a>
                )}
              </div>
            </div>
          </div>
        );
      })}
    </div>

    <!-- ç†±é–€æ¨™ç±¤ -->
    <div class="mt-12">
      <h2 class="text-2xl font-bold text-medical-neutral-900 mb-6">
        ç†±é–€é†«ç™‚æ¨™ç±¤
      </h2>
      
      <div class="bg-white rounded-lg border border-medical-neutral-200 p-6">
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
          <!-- ç–¾ç—…æ¨™ç±¤ -->
          <div>
            <h3 class="font-medium text-medical-neutral-800 mb-3">å¸¸è¦‹ç–¾ç—…</h3>
            <div class="flex flex-wrap gap-2">
              <span class="inline-flex items-center px-3 py-1 rounded-full text-sm bg-red-100 text-red-800">
                å¿ƒæˆ¿é¡«å‹•
              </span>
              <span class="inline-flex items-center px-3 py-1 rounded-full text-sm bg-red-100 text-red-800">
                é«˜è¡€å£“
              </span>
              <span class="inline-flex items-center px-3 py-1 rounded-full text-sm bg-red-100 text-red-800">
                ç³–å°¿ç—…
              </span>
              <span class="inline-flex items-center px-3 py-1 rounded-full text-sm bg-red-100 text-red-800">
                å¿ƒè‡Ÿè¡°ç«­
              </span>
            </div>
          </div>
          
          <!-- é¢¨éšªè©•ä¼° -->
          <div>
            <h3 class="font-medium text-medical-neutral-800 mb-3">é¢¨éšªè©•ä¼°</h3>
            <div class="flex flex-wrap gap-2">
              <span class="inline-flex items-center px-3 py-1 rounded-full text-sm bg-orange-100 text-orange-800">
                ä¸­é¢¨é¢¨éšª
              </span>
              <span class="inline-flex items-center px-3 py-1 rounded-full text-sm bg-orange-100 text-orange-800">
                å‡ºè¡€é¢¨éšª
              </span>
              <span class="inline-flex items-center px-3 py-1 rounded-full text-sm bg-orange-100 text-orange-800">
                å¿ƒè¡€ç®¡é¢¨éšª
              </span>
            </div>
          </div>
          
          <!-- æ²»ç™‚æ–¹å¼ -->
          <div>
            <h3 class="font-medium text-medical-neutral-800 mb-3">æ²»ç™‚æ–¹å¼</h3>
            <div class="flex flex-wrap gap-2">
              <span class="inline-flex items-center px-3 py-1 rounded-full text-sm bg-green-100 text-green-800">
                æŠ—å‡è¡€æ²»ç™‚
              </span>
              <span class="inline-flex items-center px-3 py-1 rounded-full text-sm bg-green-100 text-green-800">
                è—¥ç‰©æ²»ç™‚
              </span>
              <span class="inline-flex items-center px-3 py-1 rounded-full text-sm bg-green-100 text-green-800">
                æ‰‹è¡“æ²»ç™‚
              </span>
            </div>
          </div>
        </div>
        
        <div class="mt-6 text-center">
          <a 
            href="/tags"
            class="inline-flex items-center px-4 py-2 border border-medical-primary-300 text-sm font-medium rounded-md text-medical-primary-700 bg-medical-primary-50 hover:bg-medical-primary-100 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-medical-primary-500 transition-colors"
          >
            æŸ¥çœ‹æ‰€æœ‰æ¨™ç±¤
            <svg class="ml-2 h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
            </svg>
          </a>
        </div>
      </div>
    </div>
  </main>
</BaseLayout>

<style>
  /* ç¢ºä¿å¡ç‰‡é«˜åº¦ä¸€è‡´ */
  .grid > div {
    display: flex;
    flex-direction: column;
  }
  
  .grid > div > div {
    flex: 1;
    display: flex;
    flex-direction: column;
  }
  
  .grid > div > div > div:last-child {
    margin-top: auto;
  }
</style>