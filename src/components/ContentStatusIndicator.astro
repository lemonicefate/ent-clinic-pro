---
/**
 * 內容狀態指示器組件
 * 在開發環境顯示文章狀態、審核進度等資訊
 * 
 * 更新日期：2025-01-30
 * 更新內容：新增 SOP 工作流程狀態顯示
 * 
 * 需求對應：
 * - 需求 6.1: 版本控制和追蹤系統 ✓
 * - 需求 6.2: 版本歷史展示介面 ✓
 */

import { formatDate } from '../utils/i18n';
import type { SupportedLocale, ArticleStatus, ReviewDecision } from '../env.d';

interface Props {
  status: ArticleStatus;
  version?: string;
  lastUpdated?: string;
  reviewHistory?: Array<{
    reviewer: string;
    reviewDate: string;
    decision: ReviewDecision;
    comments?: string;
  }>;
  qualityChecks?: {
    structureCheck: boolean;
    contentCheck: boolean;
    medicalAccuracyCheck: boolean;
    seoCheck: boolean;
    accessibilityCheck: boolean;
    referencesCheck: boolean;
    lastCheckedDate?: string;
    checkedBy?: string;
  };
  workflowTimestamps?: {
    createdAt?: string;
    submittedForReview?: string;
    reviewStarted?: string;
    reviewCompleted?: string;
    qualityCheckStarted?: string;
    qualityCheckCompleted?: string;
    publishedAt?: string;
    lastModified?: string;
  };
  locale?: SupportedLocale;
  showDetails?: boolean;
}

const {
  status,
  version,
  lastUpdated,
  reviewHistory = [],
  qualityChecks,
  workflowTimestamps,
  locale = 'zh-TW',
  showDetails = false
} = Astro.props;

const isDevelopment = import.meta.env.DEV;

// 如果不是開發環境，不顯示任何內容
if (!isDevelopment) {
  return null;
}

// 狀態配置
const statusConfig = {
  'draft': { 
    label: '草稿', 
    color: 'bg-gray-100 text-gray-800 border-gray-300',
    icon: '📝',
    description: '內容正在編輯中'
  },
  'in-review': { 
    label: '審核中', 
    color: 'bg-blue-100 text-blue-800 border-blue-300',
    icon: '👀',
    description: '等待審核者檢視'
  },
  'needs-revision': { 
    label: '需修改', 
    color: 'bg-yellow-100 text-yellow-800 border-yellow-300',
    icon: '✏️',
    description: '需要根據審核意見修改'
  },
  'quality-check': { 
    label: '品質檢查', 
    color: 'bg-purple-100 text-purple-800 border-purple-300',
    icon: '🔍',
    description: '正在進行品質檢查'
  },
  'ready-to-publish': { 
    label: '準備發布', 
    color: 'bg-orange-100 text-orange-800 border-orange-300',
    icon: '🚀',
    description: '已通過所有檢查，準備發布'
  },
  'published': { 
    label: '已發布', 
    color: 'bg-green-100 text-green-800 border-green-300',
    icon: '✅',
    description: '內容已公開發布'
  }
};

const currentStatus = statusConfig[status] || statusConfig['draft'];

// 計算品質檢查完成度
const qualityScore = qualityChecks ? 
  Object.values(qualityChecks).filter((check, index) => 
    index < 6 && check === true // 只計算前6個檢查項目
  ).length : 0;

const totalQualityChecks = 6;
const qualityPercentage = qualityChecks ? Math.round((qualityScore / totalQualityChecks) * 100) : 0;

// 審核進度
const approvedReviews = reviewHistory.filter(r => r.decision === 'approved').length;
const totalReviews = reviewHistory.length;
---

<!-- 開發環境狀態指示器 -->
<div class="fixed top-4 right-4 z-50 max-w-sm">
  <div class={`border-2 rounded-lg p-4 bg-white shadow-lg ${currentStatus.color}`}>
    <!-- 狀態標頭 -->
    <div class="flex items-center justify-between mb-3">
      <div class="flex items-center space-x-2">
        <span class="text-lg">{currentStatus.icon}</span>
        <span class="font-semibold text-sm">{currentStatus.label}</span>
      </div>
      {version && (
        <span class="text-xs bg-white bg-opacity-50 px-2 py-1 rounded">
          v{version}
        </span>
      )}
    </div>
    
    <!-- 狀態描述 -->
    <p class="text-xs mb-3 opacity-80">
      {currentStatus.description}
    </p>
    
    <!-- 進度指標 -->
    {(status === 'in-review' || status === 'quality-check') && (
      <div class="space-y-2 mb-3">
        {/* 審核進度 */}
        {status === 'in-review' && totalReviews > 0 && (
          <div>
            <div class="flex justify-between text-xs mb-1">
              <span>審核進度</span>
              <span>{approvedReviews}/{totalReviews}</span>
            </div>
            <div class="w-full bg-white bg-opacity-30 rounded-full h-2">
              <div 
                class="bg-current h-2 rounded-full transition-all duration-300"
                style={`width: ${totalReviews > 0 ? (approvedReviews / totalReviews) * 100 : 0}%`}
              ></div>
            </div>
          </div>
        )}
        
        {/* 品質檢查進度 */}
        {status === 'quality-check' && qualityChecks && (
          <div>
            <div class="flex justify-between text-xs mb-1">
              <span>品質檢查</span>
              <span>{qualityScore}/{totalQualityChecks}</span>
            </div>
            <div class="w-full bg-white bg-opacity-30 rounded-full h-2">
              <div 
                class="bg-current h-2 rounded-full transition-all duration-300"
                style={`width: ${qualityPercentage}%`}
              ></div>
            </div>
          </div>
        )}
      </div>
    )}
    
    <!-- 時間資訊 -->
    <div class="text-xs space-y-1">
      {lastUpdated && (
        <div class="flex justify-between">
          <span class="opacity-70">最後更新:</span>
          <span>{formatDate(lastUpdated, locale, 'short')}</span>
        </div>
      )}
      
      {workflowTimestamps?.publishedAt && (
        <div class="flex justify-between">
          <span class="opacity-70">發布時間:</span>
          <span>{formatDate(workflowTimestamps.publishedAt, locale, 'short')}</span>
        </div>
      )}
      
      {workflowTimestamps?.submittedForReview && status !== 'published' && (
        <div class="flex justify-between">
          <span class="opacity-70">提交審核:</span>
          <span>{formatDate(workflowTimestamps.submittedForReview, locale, 'short')}</span>
        </div>
      )}
    </div>
    
    <!-- 詳細資訊切換 -->
    {showDetails && (reviewHistory.length > 0 || qualityChecks) && (
      <details class="mt-3">
        <summary class="text-xs cursor-pointer hover:opacity-80 select-none">
          詳細資訊 ▼
        </summary>
        
        <div class="mt-2 space-y-2 text-xs">
          {/* 最近審核 */}
          {reviewHistory.length > 0 && (
            <div>
              <div class="font-medium mb-1">最近審核:</div>
              {reviewHistory.slice(0, 2).map((review, index) => (
                <div key={index} class="bg-white bg-opacity-30 rounded p-2 mb-1">
                  <div class="flex justify-between items-center mb-1">
                    <span class="font-medium">{review.reviewer}</span>
                    <span class={`px-1 py-0.5 rounded text-xs ${
                      review.decision === 'approved' ? 'bg-green-200 text-green-800' :
                      review.decision === 'rejected' ? 'bg-red-200 text-red-800' :
                      'bg-yellow-200 text-yellow-800'
                    }`}>
                      {review.decision === 'approved' ? '通過' :
                       review.decision === 'rejected' ? '拒絕' : '需修改'}
                    </span>
                  </div>
                  <div class="text-xs opacity-70">
                    {formatDate(review.reviewDate, locale, 'short')}
                  </div>
                  {review.comments && (
                    <div class="text-xs mt-1 opacity-80 line-clamp-2">
                      {review.comments}
                    </div>
                  )}
                </div>
              ))}
            </div>
          )}
          
          {/* 品質檢查詳情 */}
          {qualityChecks && (
            <div>
              <div class="font-medium mb-1">品質檢查:</div>
              <div class="grid grid-cols-2 gap-1 text-xs">
                <div class={`flex items-center ${qualityChecks.structureCheck ? 'text-green-700' : 'text-red-700'}`}>
                  <span class="mr-1">{qualityChecks.structureCheck ? '✓' : '✗'}</span>
                  結構
                </div>
                <div class={`flex items-center ${qualityChecks.contentCheck ? 'text-green-700' : 'text-red-700'}`}>
                  <span class="mr-1">{qualityChecks.contentCheck ? '✓' : '✗'}</span>
                  內容
                </div>
                <div class={`flex items-center ${qualityChecks.medicalAccuracyCheck ? 'text-green-700' : 'text-red-700'}`}>
                  <span class="mr-1">{qualityChecks.medicalAccuracyCheck ? '✓' : '✗'}</span>
                  醫療
                </div>
                <div class={`flex items-center ${qualityChecks.seoCheck ? 'text-green-700' : 'text-red-700'}`}>
                  <span class="mr-1">{qualityChecks.seoCheck ? '✓' : '✗'}</span>
                  SEO
                </div>
                <div class={`flex items-center ${qualityChecks.accessibilityCheck ? 'text-green-700' : 'text-red-700'}`}>
                  <span class="mr-1">{qualityChecks.accessibilityCheck ? '✓' : '✗'}</span>
                  無障礙
                </div>
                <div class={`flex items-center ${qualityChecks.referencesCheck ? 'text-green-700' : 'text-red-700'}`}>
                  <span class="mr-1">{qualityChecks.referencesCheck ? '✓' : '✗'}</span>
                  參考
                </div>
              </div>
              {qualityChecks.lastCheckedDate && (
                <div class="text-xs opacity-70 mt-1">
                  檢查時間: {formatDate(qualityChecks.lastCheckedDate, locale, 'short')}
                </div>
              )}
            </div>
          )}
        </div>
      </details>
    )}
  </div>
</div>

<style>
  .line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
  
  details[open] summary {
    margin-bottom: 0.5rem;
  }
  
  details summary::-webkit-details-marker {
    display: none;
  }
</style>