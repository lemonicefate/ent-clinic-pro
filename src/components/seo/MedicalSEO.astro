---
/**
 * 醫療內容 SEO 組件
 * 提供醫療內容的結構化資料標記和 SEO 優化
 */

import type { SupportedLocale } from '../../env.d';

export interface MedicalSEOProps {
  title: string;
  description: string;
  keywords?: string[];
  canonicalUrl?: string;
  locale?: SupportedLocale;
  
  // 醫療內容特定屬性
  contentType: 'calculator' | 'education' | 'flowchart' | 'general';
  medicalSpecialty?: string[];
  evidenceLevel?: string;
  lastReviewed?: string;
  nextReviewDate?: string;
  author?: string;
  reviewedBy?: string;
  
  // 計算機特定屬性
  calculatorCategory?: string;
  clinicalGuidelines?: string;
  
  // 教育內容特定屬性
  readingTime?: number;
  difficulty?: 'basic' | 'intermediate' | 'advanced';
  patientFriendly?: boolean;
  
  // 流程圖特定屬性
  flowchartComplexity?: 'simple' | 'medium' | 'complex';
  
  // Open Graph 和 Twitter Card
  ogImage?: string;
  ogImageAlt?: string;
  twitterCard?: 'summary' | 'summary_large_image';
  
  // 醫療免責聲明
  medicalDisclaimer?: boolean;
}

const {
  title,
  description,
  keywords = [],
  canonicalUrl,
  locale = 'zh-TW',
  contentType,
  medicalSpecialty = [],
  evidenceLevel,
  lastReviewed,
  nextReviewDate,
  author,
  reviewedBy,
  calculatorCategory,
  clinicalGuidelines,
  readingTime,
  difficulty,
  patientFriendly,
  flowchartComplexity,
  ogImage,
  ogImageAlt,
  twitterCard = 'summary_large_image',
  medicalDisclaimer = true
} = Astro.props as MedicalSEOProps;

// 生成結構化資料
const generateStructuredData = () => {
  const baseStructuredData = {
    "@context": "https://schema.org",
    "@type": "MedicalWebPage",
    "name": title,
    "description": description,
    "url": canonicalUrl || Astro.url.href,
    "inLanguage": locale,
    "dateModified": new Date().toISOString(),
    "medicalAudience": {
      "@type": "MedicalAudience",
      "audienceType": patientFriendly ? "Patient" : "MedicalProfessional"
    }
  };

  // 添加醫療專科
  if (medicalSpecialty.length > 0) {
    baseStructuredData["specialty"] = medicalSpecialty.map(specialty => ({
      "@type": "MedicalSpecialty",
      "name": specialty
    }));
  }

  // 添加作者資訊
  if (author) {
    baseStructuredData["author"] = {
      "@type": "Person",
      "name": author
    };
  }

  // 添加審核資訊
  if (reviewedBy) {
    baseStructuredData["reviewedBy"] = {
      "@type": "Person",
      "name": reviewedBy
    };
  }

  // 添加最後審核日期
  if (lastReviewed) {
    baseStructuredData["dateReviewed"] = lastReviewed;
  }

  // 根據內容類型添加特定結構化資料
  switch (contentType) {
    case 'calculator':
      return {
        ...baseStructuredData,
        "@type": ["MedicalWebPage", "SoftwareApplication"],
        "applicationCategory": "HealthApplication",
        "applicationSubCategory": "MedicalCalculator",
        "operatingSystem": "Web Browser",
        "category": calculatorCategory,
        "medicalCode": clinicalGuidelines ? {
          "@type": "MedicalCode",
          "code": clinicalGuidelines
        } : undefined
      };

    case 'education':
      return {
        ...baseStructuredData,
        "@type": ["MedicalWebPage", "Article"],
        "articleSection": "Medical Education",
        "wordCount": readingTime ? readingTime * 200 : undefined, // 估算字數
        "timeRequired": readingTime ? `PT${readingTime}M` : undefined,
        "educationalLevel": difficulty,
        "learningResourceType": "Article"
      };

    case 'flowchart':
      return {
        ...baseStructuredData,
        "@type": ["MedicalWebPage", "CreativeWork"],
        "creativeWorkStatus": "Published",
        "workExample": {
          "@type": "VisualArtwork",
          "artform": "Flowchart",
          "complexity": flowchartComplexity
        }
      };

    default:
      return baseStructuredData;
  }
};

const structuredData = generateStructuredData();

// 生成關鍵字字串
const keywordsString = keywords.length > 0 ? keywords.join(', ') : '';

// 生成醫療免責聲明
const generateMedicalDisclaimer = () => {
  const disclaimers = {
    'zh-TW': '本內容僅供教育和資訊目的，不應作為專業醫療建議、診斷或治療的替代品。請務必諮詢合格的醫療專業人員。',
    'en': 'This content is for educational and informational purposes only and should not be used as a substitute for professional medical advice, diagnosis, or treatment. Always consult with qualified healthcare professionals.',
    'ja': 'この内容は教育および情報提供のみを目的としており、専門的な医療アドバイス、診断、または治療の代替として使用すべきではありません。必ず資格のある医療専門家にご相談ください。'
  };
  
  return disclaimers[locale] || disclaimers['zh-TW'];
};
---

<!-- 基本 Meta Tags -->
<title>{title}</title>
<meta name="description" content={description} />
{keywordsString && <meta name="keywords" content={keywordsString} />}
{canonicalUrl && <link rel="canonical" href={canonicalUrl} />}

<!-- 語言和地區 -->
<meta name="language" content={locale} />
<meta property="og:locale" content={locale} />

<!-- Open Graph Meta Tags -->
<meta property="og:type" content="website" />
<meta property="og:title" content={title} />
<meta property="og:description" content={description} />
<meta property="og:url" content={canonicalUrl || Astro.url.href} />
{ogImage && <meta property="og:image" content={ogImage} />}
{ogImageAlt && <meta property="og:image:alt" content={ogImageAlt} />}

<!-- Twitter Card Meta Tags -->
<meta name="twitter:card" content={twitterCard} />
<meta name="twitter:title" content={title} />
<meta name="twitter:description" content={description} />
{ogImage && <meta name="twitter:image" content={ogImage} />}
{ogImageAlt && <meta name="twitter:image:alt" content={ogImageAlt} />}

<!-- 醫療內容特定 Meta Tags -->
<meta name="medical-content-type" content={contentType} />
{medicalSpecialty.length > 0 && <meta name="medical-specialty" content={medicalSpecialty.join(', ')} />}
{evidenceLevel && <meta name="evidence-level" content={evidenceLevel} />}
{lastReviewed && <meta name="last-reviewed" content={lastReviewed} />}
{nextReviewDate && <meta name="next-review-date" content={nextReviewDate} />}
{difficulty && <meta name="content-difficulty" content={difficulty} />}
{patientFriendly !== undefined && <meta name="patient-friendly" content={patientFriendly.toString()} />}

<!-- 醫療免責聲明 -->
{medicalDisclaimer && <meta name="medical-disclaimer" content={generateMedicalDisclaimer()} />}

<!-- 結構化資料 (JSON-LD) -->
<script type="application/ld+json" set:html={JSON.stringify(structuredData)} />

<!-- 醫療內容安全性 -->
<meta name="referrer" content="strict-origin-when-cross-origin" />
<meta name="robots" content="index, follow, max-snippet:150, max-image-preview:large" />

<!-- 內容安全政策提示 -->
<meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests" />

<!-- 醫療內容驗證標記 -->
{evidenceLevel && (
  <meta name="citation-needed" content={evidenceLevel === 'low' ? 'true' : 'false'} />
)}

<!-- 可訪問性增強 -->
<meta name="theme-color" content="#2563eb" />
<meta name="color-scheme" content="light dark" />

<!-- 預載入關鍵資源 -->
<link rel="preconnect" href="https://fonts.googleapis.com" />
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />

<!-- DNS 預取 -->
<link rel="dns-prefetch" href="//fonts.googleapis.com" />
<link rel="dns-prefetch" href="//fonts.gstatic.com" />

<!-- 醫療內容特定的結構化資料增強 -->
{contentType === 'calculator' && (
  <script type="application/ld+json" set:html={JSON.stringify({
    "@context": "https://schema.org",
    "@type": "MedicalRiskCalculator",
    "name": title,
    "description": description,
    "url": canonicalUrl || Astro.url.href,
    "medicalSpecialty": medicalSpecialty,
    "riskFactor": calculatorCategory,
    "guideline": clinicalGuidelines
  })} />
)}

{contentType === 'education' && readingTime && (
  <script type="application/ld+json" set:html={JSON.stringify({
    "@context": "https://schema.org",
    "@type": "MedicalScholarlyArticle",
    "headline": title,
    "description": description,
    "url": canonicalUrl || Astro.url.href,
    "timeRequired": `PT${readingTime}M`,
    "educationalLevel": difficulty,
    "audience": {
      "@type": "MedicalAudience",
      "audienceType": patientFriendly ? "Patient" : "MedicalProfessional"
    }
  })} />
)}

<!-- 醫療內容品質指標 -->
<meta name="content-quality-score" content={evidenceLevel === 'high' ? '9' : evidenceLevel === 'medium' ? '7' : '5'} />
<meta name="medical-accuracy-verified" content={reviewedBy ? 'true' : 'false'} />

<!-- 行動裝置優化 -->
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
<meta name="mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="default" />

<!-- 效能提示 -->
<meta name="resource-type" content="document" />
<meta name="distribution" content="global" />
<meta name="rating" content="general" />

<!-- 醫療內容分類 -->
{medicalSpecialty.length > 0 && (
  <script type="application/ld+json" set:html={JSON.stringify({
    "@context": "https://schema.org",
    "@type": "MedicalEntity",
    "name": title,
    "medicalSpecialty": medicalSpecialty.map(specialty => ({
      "@type": "MedicalSpecialty",
      "name": specialty
    }))
  })} />
)}