---
/**
 * å…§å®¹ç®¡ç†å„€è¡¨æ¿çµ„ä»¶
 * åœ¨é–‹ç™¼ç’°å¢ƒé¡¯ç¤ºå…§å®¹çµ±è¨ˆã€ç‹€æ…‹åˆ†å¸ƒå’Œç®¡ç†å·¥å…·
 * 
 * æ›´æ–°æ—¥æœŸï¼š2025-01-30
 * æ›´æ–°å…§å®¹ï¼šæ–°å¢å…§å®¹ç®¡ç†å„€è¡¨æ¿åŠŸèƒ½
 * 
 * éœ€æ±‚å°æ‡‰ï¼š
 * - éœ€æ±‚ 6.1: ç‰ˆæœ¬æ§åˆ¶å’Œè¿½è¹¤ç³»çµ± âœ“
 * - éœ€æ±‚ 6.2: å…§å®¹ç‹€æ…‹æŒ‡ç¤ºå™¨ âœ“
 * - éœ€æ±‚ 8.1: å…§å®¹çµ±è¨ˆå’Œåˆ†æ âœ“
 */

import { getCollection } from 'astro:content';
import { formatDate } from '../utils/i18n';
import type { SupportedLocale } from '../env.d';

interface Props {
  locale?: SupportedLocale;
  showOnlyInDev?: boolean;
}

const {
  locale = 'zh-TW',
  showOnlyInDev = true
} = Astro.props;

const isDevelopment = import.meta.env.DEV;

// å¦‚æœè¨­å®šç‚ºåƒ…é–‹ç™¼ç’°å¢ƒé¡¯ç¤ºä¸”ç•¶å‰ä¸æ˜¯é–‹ç™¼ç’°å¢ƒï¼Œå‰‡ä¸é¡¯ç¤º
if (showOnlyInDev && !isDevelopment) {
  return null;
}

// ç²å–æ‰€æœ‰æ•™è‚²å…§å®¹
const allEducation = await getCollection('education');

// è¨ˆç®—å„ç¨®çµ±è¨ˆè³‡æ–™
const stats = {
  total: allEducation.length,
  published: allEducation.filter(e => e.data.status === 'published').length,
  inReview: allEducation.filter(e => e.data.status === 'in-review').length,
  draft: allEducation.filter(e => e.data.status === 'draft').length,
  needsRevision: allEducation.filter(e => e.data.status === 'needs-revision').length,
  qualityCheck: allEducation.filter(e => e.data.status === 'quality-check').length,
  readyToPublish: allEducation.filter(e => e.data.status === 'ready-to-publish').length
};

// æŒ‰å°ˆç§‘åˆ†çµ„çµ±è¨ˆ
const specialtyStats = allEducation.reduce((acc, entry) => {
  entry.data.medicalSpecialties.forEach(specialty => {
    if (!acc[specialty]) {
      acc[specialty] = {
        total: 0,
        published: 0,
        inReview: 0,
        draft: 0,
        needsRevision: 0,
        qualityCheck: 0,
        readyToPublish: 0
      };
    }
    acc[specialty].total++;
    acc[specialty][entry.data.status]++;
  });
  return acc;
}, {} as Record<string, typeof stats>);

// æŒ‰åˆ†é¡çµ±è¨ˆ
const categoryStats = allEducation.reduce((acc, entry) => {
  const category = entry.data.category;
  if (!acc[category]) {
    acc[category] = {
      total: 0,
      published: 0,
      inReview: 0,
      draft: 0,
      needsRevision: 0,
      qualityCheck: 0,
      readyToPublish: 0
    };
  }
  acc[category].total++;
  acc[category][entry.data.status]++;
  return acc;
}, {} as Record<string, typeof stats>);

// è¨ˆç®—å…§å®¹æ–°é®®åº¦çµ±è¨ˆ
const now = new Date();
const freshnessStats = {
  fresh: 0,
  aging: 0,
  stale: 0,
  critical: 0
};

allEducation.forEach(entry => {
  const lastUpdated = new Date(entry.data.lastUpdated);
  const daysSinceUpdate = Math.floor((now.getTime() - lastUpdated.getTime()) / (1000 * 60 * 60 * 24));
  
  if (daysSinceUpdate <= 90) freshnessStats.fresh++;
  else if (daysSinceUpdate <= 180) freshnessStats.aging++;
  else if (daysSinceUpdate <= 365) freshnessStats.stale++;
  else freshnessStats.critical++;
});

// æ‰¾å‡ºéœ€è¦é—œæ³¨çš„å…§å®¹
const needsAttention = allEducation.filter(entry => {
  const lastUpdated = new Date(entry.data.lastUpdated);
  const daysSinceUpdate = Math.floor((now.getTime() - lastUpdated.getTime()) / (1000 * 60 * 60 * 24));
  
  return (
    entry.data.status === 'needs-revision' ||
    (entry.data.status === 'in-review' && entry.data.workflowTimestamps?.submittedForReview && 
     Math.floor((now.getTime() - new Date(entry.data.workflowTimestamps.submittedForReview).getTime()) / (1000 * 60 * 60 * 24)) > 7) ||
    daysSinceUpdate > 365
  );
});

// ç‹€æ…‹é…ç½®
const statusConfig = {
  published: { label: 'å·²ç™¼å¸ƒ', color: 'text-green-600', bgColor: 'bg-green-100' },
  inReview: { label: 'å¯©æ ¸ä¸­', color: 'text-blue-600', bgColor: 'bg-blue-100' },
  draft: { label: 'è‰ç¨¿', color: 'text-gray-600', bgColor: 'bg-gray-100' },
  needsRevision: { label: 'éœ€ä¿®æ”¹', color: 'text-yellow-600', bgColor: 'bg-yellow-100' },
  qualityCheck: { label: 'å“è³ªæª¢æŸ¥', color: 'text-purple-600', bgColor: 'bg-purple-100' },
  readyToPublish: { label: 'æº–å‚™ç™¼å¸ƒ', color: 'text-orange-600', bgColor: 'bg-orange-100' }
};

// å°ˆç§‘åç¨±æ˜ å°„
const specialtyNames = {
  cardiology: 'å¿ƒè‡Ÿç§‘',
  neurology: 'ç¥ç¶“ç§‘',
  orthopedics: 'éª¨ç§‘',
  emergency: 'æ€¥è¨ºé†«å­¸',
  pediatrics: 'å°å…’ç§‘',
  general: 'ä¸€èˆ¬é†«å­¸',
  endocrinology: 'å…§åˆ†æ³Œç§‘',
  nephrology: 'è…è‡Ÿç§‘',
  pulmonology: 'èƒ¸è…”ç§‘',
  surgery: 'å¤–ç§‘'
};

// åˆ†é¡åç¨±æ˜ å°„
const categoryNames = {
  disease: 'ç–¾ç—…è³‡è¨Š',
  medication: 'è—¥ç‰©è³‡è¨Š',
  procedure: 'æª¢æŸ¥ç¨‹åº',
  prevention: 'é é˜²ä¿å¥',
  lifestyle: 'ç”Ÿæ´»æ–¹å¼',
  symptoms: 'ç—‡ç‹€è­˜åˆ¥',
  diagnosis: 'è¨ºæ–·æ–¹æ³•',
  treatment: 'æ²»ç™‚æŒ‡å¼•'
};
---

<div class="bg-white rounded-lg border border-gray-200 shadow-sm">
  <!-- å„€è¡¨æ¿æ¨™é ­ -->
  <div class="px-6 py-4 border-b border-gray-200">
    <div class="flex items-center justify-between">
      <div class="flex items-center space-x-3">
        <svg class="h-6 w-6 text-blue-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
        </svg>
        <h2 class="text-xl font-semibold text-gray-900">å…§å®¹ç®¡ç†å„€è¡¨æ¿</h2>
        {isDevelopment && (
          <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800">
            é–‹ç™¼ç’°å¢ƒ
          </span>
        )}
      </div>
      <div class="text-sm text-gray-500">
        æœ€å¾Œæ›´æ–°: {formatDate(new Date().toISOString(), locale, 'short')}
      </div>
    </div>
  </div>

  <div class="p-6">
    <!-- ç¸½é«”çµ±è¨ˆ -->
    <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-7 gap-4 mb-8">
      <div class="text-center">
        <div class="text-2xl font-bold text-gray-900 mb-1">{stats.total}</div>
        <div class="text-sm text-gray-600">ç¸½æ–‡ç« æ•¸</div>
      </div>
      {Object.entries(statusConfig).map(([status, config]) => (
        <div key={status} class="text-center">
          <div class={`text-2xl font-bold mb-1 ${config.color}`}>
            {stats[status]}
          </div>
          <div class="text-sm text-gray-600">{config.label}</div>
        </div>
      ))}
    </div>

    <!-- å·¥ä½œæµç¨‹å¥åº·åº¦ -->
    <div class="mb-8 p-4 bg-gray-50 rounded-lg">
      <h3 class="text-lg font-semibold text-gray-900 mb-4">å·¥ä½œæµç¨‹å¥åº·åº¦</h3>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <div class="text-center">
          <div class={`text-3xl font-bold mb-2 ${
            stats.published / stats.total >= 0.8 ? 'text-green-600' :
            stats.published / stats.total >= 0.6 ? 'text-yellow-600' : 'text-red-600'
          }`}>
            {Math.round((stats.published / stats.total) * 100)}%
          </div>
          <div class="text-sm text-gray-600">ç™¼å¸ƒç‡</div>
          <div class="text-xs text-gray-500 mt-1">
            {stats.published / stats.total >= 0.8 ? 'å„ªç§€' :
             stats.published / stats.total >= 0.6 ? 'è‰¯å¥½' : 'éœ€æ”¹å–„'}
          </div>
        </div>
        
        <div class="text-center">
          <div class={`text-3xl font-bold mb-2 ${
            stats.needsRevision <= 5 ? 'text-green-600' :
            stats.needsRevision <= 10 ? 'text-yellow-600' : 'text-red-600'
          }`}>
            {stats.needsRevision}
          </div>
          <div class="text-sm text-gray-600">å¾…ä¿®æ”¹</div>
          <div class="text-xs text-gray-500 mt-1">
            {stats.needsRevision <= 5 ? 'æµæš¢' :
             stats.needsRevision <= 10 ? 'æ­£å¸¸' : 'ç©å£“'}
          </div>
        </div>
        
        <div class="text-center">
          <div class={`text-3xl font-bold mb-2 ${
            stats.inReview <= 10 ? 'text-green-600' :
            stats.inReview <= 20 ? 'text-yellow-600' : 'text-red-600'
          }`}>
            {stats.inReview}
          </div>
          <div class="text-sm text-gray-600">å¯©æ ¸ä¸­</div>
          <div class="text-xs text-gray-500 mt-1">
            {stats.inReview <= 10 ? 'æ­£å¸¸' :
             stats.inReview <= 20 ? 'ç¹å¿™' : 'å£…å¡'}
          </div>
        </div>
      </div>
    </div>

    <!-- å…§å®¹æ–°é®®åº¦çµ±è¨ˆ -->
    <div class="mb-8">
      <h3 class="text-lg font-semibold text-gray-900 mb-4">å…§å®¹æ–°é®®åº¦åˆ†å¸ƒ</h3>
      <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
        <div class="text-center p-4 bg-green-50 rounded-lg">
          <div class="text-2xl font-bold text-green-600 mb-1">{freshnessStats.fresh}</div>
          <div class="text-sm text-gray-600">ğŸŸ¢ æ–°é®®å…§å®¹</div>
          <div class="text-xs text-gray-500 mt-1">â‰¤ 90 å¤©</div>
        </div>
        <div class="text-center p-4 bg-yellow-50 rounded-lg">
          <div class="text-2xl font-bold text-yellow-600 mb-1">{freshnessStats.aging}</div>
          <div class="text-sm text-gray-600">ğŸŸ¡ è€åŒ–å…§å®¹</div>
          <div class="text-xs text-gray-500 mt-1">91-180 å¤©</div>
        </div>
        <div class="text-center p-4 bg-orange-50 rounded-lg">
          <div class="text-2xl font-bold text-orange-600 mb-1">{freshnessStats.stale}</div>
          <div class="text-sm text-gray-600">ğŸŸ  éæ™‚å…§å®¹</div>
          <div class="text-xs text-gray-500 mt-1">181-365 å¤©</div>
        </div>
        <div class="text-center p-4 bg-red-50 rounded-lg">
          <div class="text-2xl font-bold text-red-600 mb-1">{freshnessStats.critical}</div>
          <div class="text-sm text-gray-600">ğŸ”´ æ€¥éœ€æ›´æ–°</div>
          <div class="text-xs text-gray-500 mt-1">> 365 å¤©</div>
        </div>
      </div>
    </div>

    <!-- éœ€è¦é—œæ³¨çš„å…§å®¹ -->
    {needsAttention.length > 0 && (
      <div class="mb-8">
        <h3 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
          <svg class="h-5 w-5 text-red-500 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L4.082 16.5c-.77.833.192 2.5 1.732 2.5z" />
          </svg>
          éœ€è¦é—œæ³¨çš„å…§å®¹ ({needsAttention.length})
        </h3>
        <div class="space-y-2 max-h-64 overflow-y-auto">
          {needsAttention.slice(0, 10).map(entry => {
            const lastUpdated = new Date(entry.data.lastUpdated);
            const daysSinceUpdate = Math.floor((now.getTime() - lastUpdated.getTime()) / (1000 * 60 * 60 * 24));
            
            return (
              <div key={entry.slug} class="flex items-center justify-between p-3 bg-red-50 border border-red-200 rounded">
                <div class="flex-1 min-w-0">
                  <div class="flex items-center space-x-2">
                    <span class={`inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium ${
                      statusConfig[entry.data.status]?.bgColor || 'bg-gray-100'
                    } ${statusConfig[entry.data.status]?.color || 'text-gray-600'}`}>
                      {statusConfig[entry.data.status]?.label || entry.data.status}
                    </span>
                    <span class="text-sm font-medium text-gray-900 truncate">
                      {entry.data.title['zh-TW'] || entry.data.title}
                    </span>
                  </div>
                  <div class="text-xs text-gray-500 mt-1">
                    {daysSinceUpdate > 365 ? `${daysSinceUpdate} å¤©æœªæ›´æ–°` : 
                     entry.data.status === 'needs-revision' ? 'éœ€è¦ä¿®æ”¹' :
                     'å¯©æ ¸é€¾æœŸ'}
                  </div>
                </div>
                <a 
                  href={`/education/${entry.slug}`}
                  class="text-sm text-blue-600 hover:text-blue-700 font-medium ml-4"
                >
                  æŸ¥çœ‹ â†’
                </a>
              </div>
            );
          })}
        </div>
      </div>
    )}

    <!-- å°ˆç§‘çµ±è¨ˆ -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
      <!-- æŒ‰å°ˆç§‘çµ±è¨ˆ -->
      <div>
        <h3 class="text-lg font-semibold text-gray-900 mb-4">å°ˆç§‘åˆ†å¸ƒ</h3>
        <div class="space-y-3">
          {Object.entries(specialtyStats).slice(0, 6).map(([specialty, stats]) => (
            <div key={specialty} class="flex items-center justify-between p-3 bg-gray-50 rounded">
              <div class="flex items-center space-x-3">
                <span class="font-medium text-gray-900">
                  {specialtyNames[specialty] || specialty}
                </span>
                <span class="text-sm text-gray-500">
                  {stats.total} ç¯‡
                </span>
              </div>
              <div class="flex items-center space-x-2">
                <div class="flex space-x-1">
                  <div class="w-3 h-3 bg-green-500 rounded" title={`å·²ç™¼å¸ƒ: ${stats.published}`}></div>
                  <div class="w-3 h-3 bg-blue-500 rounded" title={`å¯©æ ¸ä¸­: ${stats.inReview}`}></div>
                  <div class="w-3 h-3 bg-gray-400 rounded" title={`è‰ç¨¿: ${stats.draft}`}></div>
                </div>
                <span class="text-sm text-gray-500">
                  {Math.round((stats.published / stats.total) * 100)}%
                </span>
              </div>
            </div>
          ))}
        </div>
      </div>

      <!-- æŒ‰åˆ†é¡çµ±è¨ˆ -->
      <div>
        <h3 class="text-lg font-semibold text-gray-900 mb-4">å…§å®¹åˆ†é¡</h3>
        <div class="space-y-3">
          {Object.entries(categoryStats).slice(0, 6).map(([category, stats]) => (
            <div key={category} class="flex items-center justify-between p-3 bg-gray-50 rounded">
              <div class="flex items-center space-x-3">
                <span class="font-medium text-gray-900">
                  {categoryNames[category] || category}
                </span>
                <span class="text-sm text-gray-500">
                  {stats.total} ç¯‡
                </span>
              </div>
              <div class="flex items-center space-x-2">
                <div class="flex space-x-1">
                  <div class="w-3 h-3 bg-green-500 rounded" title={`å·²ç™¼å¸ƒ: ${stats.published}`}></div>
                  <div class="w-3 h-3 bg-blue-500 rounded" title={`å¯©æ ¸ä¸­: ${stats.inReview}`}></div>
                  <div class="w-3 h-3 bg-gray-400 rounded" title={`è‰ç¨¿: ${stats.draft}`}></div>
                </div>
                <span class="text-sm text-gray-500">
                  {Math.round((stats.published / stats.total) * 100)}%
                </span>
              </div>
            </div>
          ))}
        </div>
      </div>
    </div>
  </div>
</div>