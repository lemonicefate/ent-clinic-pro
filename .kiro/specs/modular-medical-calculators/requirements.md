# 需求文件

## 介紹

本功能旨在為 Astro Clinical Platform 開發一套模組化的醫療計算機系統，堅守「前端優先」的 Jamstack 架構理念，以獲得極致的網站效能、頂級的安全性、極低的維護與託管成本，以及最簡單的部署流程。系統採用「資料驅動」的模組化設計，每個計算機模組都能獨立開發、測試和維護，同時透過清晰的抽象層保留未來轉換為後端運行的彈性。系統將採用混合資料模式：Git 管理核心計算邏輯，Headless CMS 管理視覺化內容，確保開發者友好的工作流程。

## 需求

### 需求 1：徹底的模組化架構

**使用者故事：** 作為開發者，我希望能夠創建完全獨立、自給自足的醫療計算機模組，以便每個計算機都是一個獨立的「微應用」，易於開發、測試和維護。

#### 驗收標準

1. WHEN 開發者創建新的醫療計算機時 THEN 應提供標準化的 `src/calculators/[calculator-name]/` 目錄結構，包含 config.json（定義WHAT）、visualization.json（定義HOW TO SHOW）、calculator.ts（定義HOW TO CALCULATE）、calculator.test.ts（定義HOW TO VERIFY）
2. WHEN 某個計算機模組被修改時 THEN 其他計算機模組完全不受影響，實現真正的模組隔離
3. WHEN 計算機的 UI 元件發生錯誤時 THEN 錯誤應透過 React Error Boundary 隔離，不影響頁面其他部分的運作
4. WHEN 一個計算機模組被移除或禁用時 THEN 系統應在建置時自動探索可用模組，動態調整計算機列表，無需手動配置

### 需求 2：使用者體驗

**使用者故事：** 作為醫療專業人員，我希望能夠使用各種醫療計算機，以便進行不同類型的臨床計算和風險評估。

#### 驗收標準

1. WHEN 使用者訪問計算機列表時 THEN 系統應顯示所有已發布的計算機，並支援按分類篩選
2. WHEN 使用者選擇特定計算機時 THEN 系統應根據其設定檔動態渲染出對應的介面與功能
3. WHEN 使用者輸入計算參數時 THEN 應提供即時的客戶端驗證和回饋
4. WHEN 計算完成時 THEN 應在客戶端以視覺化方式顯示結果，包括圖卡 (Cards)、儀表板 (Dashboard) 或圖表等形式呈現計算結果、風險等級、解釋和臨床建議
5. WHEN 使用者需要參考資料時 THEN 應在介面上提供相關的醫學文獻和指引連結
6. WHEN 計算結果包含數值範圍或風險分級時 THEN 應使用顏色編碼、進度條、圓餅圖或其他視覺元素來直觀呈現

### 需求 3：計算機管理 (基於 Git & CMS)

**使用者故事：** 作為系統管理員，我希望能夠透過 Git 工作流和 CMS 輕鬆管理醫療計算機的生命週期。

#### 驗收標準

1. WHEN 管理員需要查看計算機清單時 THEN 平台的設定檔或 CMS 內容應作為唯一的真實來源 (Single Source of Truth)
2. WHEN 管理員需要啟用或停用計算機時 THEN 可以透過修改設定檔中的 status: 'published' | 'draft' 欄位來控制，並在下次網站部署後生效
3. WHEN 管理員更新計算機時 THEN 應透過提交程式碼 (Git) 或更新 CMS 內容，並觸發新的網站部署來完成更新
4. WHEN 需要監控使用情況時 THEN 應透過整合第三方分析工具（如 Plausible）來追蹤每個計算機頁面的使用數據

### 需求 4：品質保證與準確性

**使用者故事：** 作為品質保證人員，我希望每個醫療計算機都有完整的測試覆蓋，以確保計算結果的準確性。

#### 驗收標準

1. WHEN 計算機模組被開發時 THEN 模板必須包含單元測試檔案，用於驗證計算邏輯的準確性
2. WHEN 計算函式執行時 THEN 它應為一個純函式 (Pure Function)，接收輸入並回傳結果，不應有副作用，以利於測試
3. WHEN 計算結果產生時 THEN 應能清晰地追溯其所依賴的輸入值和計算函式
4. WHEN 執行自動化測試時 THEN 每個計算機模組的單元測試應能獨立運行

### 需求 5：資料驅動的 UI 引擎與清晰抽象層

**使用者故事：** 作為平台架構師，我希望建立一個通用的、資料驅動的 UI 引擎，並透過清晰的抽象層保留未來擴充性，在不增加當前複雜度的前提下為未來鋪路。

#### 驗收標準

1. WHEN 平台在建置時期 THEN 系統應透過 Astro.glob() 自動探索所有 `src/calculators/*/config.json` 並動態註冊
2. WHEN 計算機被渲染時 THEN Calculator.tsx 應作為通用引擎，不包含任何特定計算機的寫死邏輯，完全根據傳入的 config 和 visualization 物件動態渲染
3. WHEN 計算機需要執行計算時 THEN UI 引擎應根據 config.calculation.functionName 呼叫對應的純函式，實現完全解耦
4. WHEN 未來需要對接後端時 THEN 只需修改 services/calculatorService.ts 的資料獲取邏輯（從 Astro.glob() 改為 fetch() API），所有 UI 元件保持不變

### 需求 6：混合資料模式 (Git + Headless CMS)

**使用者故事：** 作為內容管理者，我希望透過最適合的工具管理不同類型的內容，核心邏輯由開發者在 Git 中管理，視覺化內容由 CMS 管理。

#### 驗收標準

1. WHEN 管理計算機核心邏輯時 THEN 欄位定義、計算公式、驗證規則應儲存在 Git 的 config.json 和 calculator.ts 中，享受版本控制、程式碼審查等開發者友好的流程
2. WHEN 管理視覺化內容時 THEN 衛教文章、多語言翻譯、說明文字應透過 Headless CMS (Strapi) 管理，提供視覺化編輯介面
3. WHEN CMS 內容更新時 THEN 應透過 webhook 觸發 Astro 網站的重新建置和部署
4. WHEN 系統讀取資料時 THEN 應在建置時期將 Git 資料和 CMS 資料合併，生成完整的靜態網站

### 需求 7：使用者介面一致性與視覺化

**使用者故事：** 作為使用者體驗設計師，我希望所有醫療計算機都有一致的 UI 和互動模式，並能以視覺化方式呈現計算結果。

#### 驗收標準

1. WHEN 使用者使用任何計算機時 THEN 其介面（輸入框、按鈕、顏色）應遵循平台統一的設計系統 (Design System)
2. WHEN 計算機顯示結果時 THEN 應使用標準化的視覺化結果展示元件，包括結果卡片、風險指示器、圖表和儀表板等
3. WHEN 使用者需要幫助時 THEN 每個計算機應提供位置和風格一致的幫助和說明入口
4. WHEN 計算機在不同裝置上使用時 THEN 應提供完整響應式設計和無障礙支援
5. WHEN 計算結果需要視覺化呈現時 THEN 系統應提供可重複使用的視覺化元件庫，包括風險等級指示器、數值儀表、趨勢圖表和比較圖表等
6. WHEN 多個相關數值需要同時顯示時 THEN 應使用儀表板佈局，將相關資訊組織在視覺上連貫的區塊中

### 需求 8：可重複使用的視覺化組件庫

**使用者故事：** 作為醫療專業人員，我希望計算結果能透過標準化、可重複使用的視覺化組件以直觀方式呈現，確保一致的使用者體驗。

#### 驗收標準

1. WHEN 開發視覺化組件時 THEN 應在 Storybook 環境中優先開發所有通用的、可重複使用的組件（如 ResultCard, RiskIndicator, GaugeChart 等）
2. WHEN 計算結果需要顯示時 THEN 應根據 visualization.json 配置動態選擇和組合視覺化組件，而非寫死的 UI 邏輯
3. WHEN 風險評分需要呈現時 THEN 應使用標準化的 RiskIndicator 組件，支援 badge、progress、gauge 等多種樣式
4. WHEN 多個指標需要展示時 THEN 應使用 Dashboard 佈局組件，根據配置自動排列 ResultCard 組件
5. WHEN 圖表需要渲染時 THEN 應使用整合 Chart.js 的 CalculatorChart 組件，支援 line、bar、pie、doughnut、radar 等圖表類型
6. WHEN 新的視覺化需求出現時 THEN 應能透過擴展組件庫和更新 visualization.json 來實現，無需修改核心 UI 引擎

### 需求 9：貢獻與審核流程 (基於 Git)

**使用者故事：** 作為醫學專家，我希望能夠透過標準化流程貢獻新的醫療計算機或改進現有計算機。

#### 驗收標準

1. WHEN 專家提交新計算機時 THEN 應透過在 GitHub (或類似平台) 上建立一個合併請求 (Pull Request) 來進行
2. WHEN 計算機需要醫學驗證時 THEN 審核流程應包含程式碼審查 (Code Review) 和臨床邏輯審查 (Clinical Review)
3. WHEN 計算公式更新時 THEN 應在合併請求中清晰地展示版本變更，並附上相關的醫學文獻證據
4. WHEN 合併請求被批准並合併後 THEN CI/CD 流程應自動觸發新版本的網站部署