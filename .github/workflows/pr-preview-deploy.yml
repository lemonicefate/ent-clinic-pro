name: ğŸ” PR é è¦½éƒ¨ç½²

on:
  pull_request:
    branches: [ main, master ]
    types: [opened, synchronize, reopened, closed]
    paths:
      - 'src/content/**'
      - 'src/pages/**'
      - 'src/components/**'
      - 'public/admin/**'
      - 'astro.config.mjs'
      - 'package.json'

# å…è¨±æ‰‹å‹•è§¸ç™¼é è¦½éƒ¨ç½²
  workflow_dispatch:
    inputs:
      pr_number:
        description: 'PR ç·¨è™Ÿ'
        required: true
        type: string

jobs:
  # å»ºç½®é è¦½ç‰ˆæœ¬
  build-preview:
    runs-on: ubuntu-latest
    if: github.event.action != 'closed'
    name: ğŸ—ï¸ å»ºç½®é è¦½ç‰ˆæœ¬
    outputs:
      preview-url: ${{ steps.deploy.outputs.url }}
      has-content-changes: ${{ steps.changes.outputs.content }}
      changed-files: ${{ steps.changes.outputs.content_files }}
    
    steps:
    - name: æª¢å‡ºç¨‹å¼ç¢¼
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: æª¢æ¸¬è®Šæ›´æª”æ¡ˆ
      uses: dorny/paths-filter@v2
      id: changes
      with:
        filters: |
          content:
            - 'src/content/**/*.md'
          pages:
            - 'src/pages/**'
          components:
            - 'src/components/**'
          admin:
            - 'public/admin/**'
        list-files: json

    - name: è¨­å®š Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: å®‰è£ä¾è³´
      run: npm ci

    - name: å»ºç«‹é è¦½ç’°å¢ƒé…ç½®
      run: |
        echo "å»ºç«‹é è¦½ç’°å¢ƒé…ç½®..."
        
        # å»ºç«‹é è¦½ç’°å¢ƒè®Šæ•¸
        cat > .env.preview << EOF
        PUBLIC_SITE_URL=https://pr-${{ github.event.number }}.astro-clinical-platform.pages.dev
        PUBLIC_PREVIEW_MODE=true
        PUBLIC_PR_NUMBER=${{ github.event.number }}
        PUBLIC_BRANCH_NAME=${{ github.head_ref }}
        PUBLIC_COMMIT_SHA=${{ github.event.pull_request.head.sha }}
        EOF
        
        echo "âœ… é è¦½ç’°å¢ƒé…ç½®å®Œæˆ"

    - name: å»ºç½®é è¦½ç‰ˆæœ¬
      run: |
        echo "ğŸ—ï¸ é–‹å§‹å»ºç½®é è¦½ç‰ˆæœ¬..."
        
        # è¼‰å…¥é è¦½ç’°å¢ƒè®Šæ•¸
        export $(cat .env.preview | xargs)
        
        # å»ºç½®å°ˆæ¡ˆ
        npm run build
        
        echo "âœ… é è¦½ç‰ˆæœ¬å»ºç½®å®Œæˆ"
      env:
        NODE_ENV: preview

    - name: ç”Ÿæˆé è¦½è³‡è¨Šæª”æ¡ˆ
      run: |
        mkdir -p dist/preview-info
        
        # å»ºç«‹é è¦½è³‡è¨Š JSON
        cat > dist/preview-info/info.json << EOF
        {
          "pr_number": ${{ github.event.number }},
          "branch": "${{ github.head_ref }}",
          "commit_sha": "${{ github.event.pull_request.head.sha }}",
          "commit_message": "${{ github.event.pull_request.title }}",
          "author": "${{ github.event.pull_request.user.login }}",
          "created_at": "${{ github.event.pull_request.created_at }}",
          "updated_at": "${{ github.event.pull_request.updated_at }}",
          "build_time": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
          "changed_files": ${{ steps.changes.outputs.content_files || '[]' }},
          "has_content_changes": ${{ steps.changes.outputs.content == 'true' }}
        }
        EOF
        
        # å»ºç«‹é è¦½è³‡è¨Š HTML é é¢
        cat > dist/preview-info/index.html << 'EOF'
        <!DOCTYPE html>
        <html lang="zh-TW">
        <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>PR é è¦½è³‡è¨Š</title>
            <style>
                body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; margin: 40px; background: #f5f5f5; }
                .container { max-width: 800px; margin: 0 auto; background: white; padding: 30px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
                .header { text-align: center; margin-bottom: 30px; }
                .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin: 20px 0; }
                .info-item { padding: 15px; background: #f8f9fa; border-radius: 6px; }
                .info-label { font-weight: bold; color: #495057; margin-bottom: 5px; }
                .info-value { color: #212529; }
                .changes-list { background: #e3f2fd; padding: 15px; border-radius: 6px; margin: 20px 0; }
                .btn { display: inline-block; padding: 10px 20px; background: #007bff; color: white; text-decoration: none; border-radius: 5px; margin: 5px; }
                .btn:hover { background: #0056b3; }
                .status { padding: 5px 10px; border-radius: 15px; font-size: 12px; font-weight: bold; }
                .status.preview { background: #fff3cd; color: #856404; }
            </style>
        </head>
        <body>
            <div class="container">
                <div class="header">
                    <h1>ğŸ” PR é è¦½ç’°å¢ƒ</h1>
                    <span class="status preview">é è¦½æ¨¡å¼</span>
                </div>
                
                <div class="info-grid">
                    <div class="info-item">
                        <div class="info-label">PR ç·¨è™Ÿ</div>
                        <div class="info-value" id="pr-number">è¼‰å…¥ä¸­...</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">åˆ†æ”¯åç¨±</div>
                        <div class="info-value" id="branch">è¼‰å…¥ä¸­...</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">ä½œè€…</div>
                        <div class="info-value" id="author">è¼‰å…¥ä¸­...</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">å»ºç½®æ™‚é–“</div>
                        <div class="info-value" id="build-time">è¼‰å…¥ä¸­...</div>
                    </div>
                </div>
                
                <div class="info-item">
                    <div class="info-label">PR æ¨™é¡Œ</div>
                    <div class="info-value" id="commit-message">è¼‰å…¥ä¸­...</div>
                </div>
                
                <div class="changes-list">
                    <div class="info-label">è®Šæ›´æª”æ¡ˆ</div>
                    <div id="changed-files">è¼‰å…¥ä¸­...</div>
                </div>
                
                <div style="text-align: center; margin-top: 30px;">
                    <a href="/" class="btn">ğŸ  å›åˆ°é¦–é </a>
                    <a href="/admin" class="btn">âš™ï¸ CMS ç®¡ç†</a>
                    <a href="/education" class="btn">ğŸ“š è¡›æ•™å…§å®¹</a>
                </div>
            </div>
            
            <script>
                fetch('./info.json')
                    .then(response => response.json())
                    .then(data => {
                        document.getElementById('pr-number').textContent = `#${data.pr_number}`;
                        document.getElementById('branch').textContent = data.branch;
                        document.getElementById('author').textContent = data.author;
                        document.getElementById('build-time').textContent = new Date(data.build_time).toLocaleString('zh-TW');
                        document.getElementById('commit-message').textContent = data.commit_message;
                        
                        const changedFiles = data.changed_files || [];
                        const changedFilesHtml = changedFiles.length > 0 
                            ? changedFiles.map(file => `<div>ğŸ“„ ${file}</div>`).join('')
                            : '<div>ç„¡å…§å®¹æª”æ¡ˆè®Šæ›´</div>';
                        document.getElementById('changed-files').innerHTML = changedFilesHtml;
                    })
                    .catch(error => {
                        console.error('è¼‰å…¥é è¦½è³‡è¨Šå¤±æ•—:', error);
                    });
            </script>
        </body>
        </html>
        EOF

    - name: éƒ¨ç½²åˆ° Cloudflare Pages (é è¦½)
      id: deploy
      uses: cloudflare/pages-action@v1
      with:
        apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
        accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        projectName: astro-clinical-platform
        directory: dist
        gitHubToken: ${{ secrets.GITHUB_TOKEN }}
        wranglerVersion: '3'

    - name: å„²å­˜é è¦½ URL
      run: |
        echo "PREVIEW_URL=${{ steps.deploy.outputs.url }}" >> $GITHUB_ENV
        echo "é è¦½ URL: ${{ steps.deploy.outputs.url }}"

  # å»ºç«‹å¯©æ ¸è€…å°ˆç”¨é è¦½ä»‹é¢
  create-reviewer-interface:
    runs-on: ubuntu-latest
    needs: build-preview
    if: needs.build-preview.outputs.has-content-changes == 'true'
    name: ğŸ‘¥ å»ºç«‹å¯©æ ¸è€…ä»‹é¢
    
    steps:
    - name: æª¢å‡ºç¨‹å¼ç¢¼
      uses: actions/checkout@v4

    - name: è¨­å®š Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: å®‰è£ä¾è³´
      run: npm ci

    - name: ç”Ÿæˆå…§å®¹è®Šæ›´æ¯”è¼ƒå ±å‘Š
      run: |
        echo "ğŸ“Š ç”Ÿæˆå…§å®¹è®Šæ›´æ¯”è¼ƒå ±å‘Š..."
        
        # å»ºç«‹æ¯”è¼ƒå ±å‘Šç›®éŒ„
        mkdir -p reviewer-interface
        
        # å–å¾—è®Šæ›´çš„æª”æ¡ˆåˆ—è¡¨
        CHANGED_FILES='${{ needs.build-preview.outputs.changed-files }}'
        
        # ç”Ÿæˆå¯©æ ¸è€…ä»‹é¢ HTML
        cat > reviewer-interface/index.html << 'EOF'
        <!DOCTYPE html>
        <html lang="zh-TW">
        <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>å¯©æ ¸è€…é è¦½ä»‹é¢</title>
            <style>
                body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; margin: 0; background: #f8f9fa; }
                .header { background: #343a40; color: white; padding: 20px; text-align: center; }
                .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
                .section { background: white; margin: 20px 0; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
                .checklist { list-style: none; padding: 0; }
                .checklist li { padding: 10px; margin: 5px 0; background: #f8f9fa; border-radius: 4px; border-left: 4px solid #007bff; }
                .checklist li.completed { border-left-color: #28a745; background: #d4edda; }
                .file-diff { background: #f1f3f4; padding: 15px; border-radius: 6px; margin: 10px 0; font-family: monospace; }
                .btn { display: inline-block; padding: 10px 20px; background: #007bff; color: white; text-decoration: none; border-radius: 5px; margin: 5px; }
                .btn.success { background: #28a745; }
                .btn.warning { background: #ffc107; color: #212529; }
                .btn.danger { background: #dc3545; }
                .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
                .quality-score { text-align: center; padding: 20px; }
                .score { font-size: 3em; font-weight: bold; margin: 10px 0; }
                .score.excellent { color: #28a745; }
                .score.good { color: #17a2b8; }
                .score.fair { color: #ffc107; }
                .score.poor { color: #dc3545; }
            </style>
        </head>
        <body>
            <div class="header">
                <h1>ğŸ‘¥ é†«ç™‚å…§å®¹å¯©æ ¸è€…é è¦½ä»‹é¢</h1>
                <p>PR #<span id="pr-number">--</span> | åˆ†æ”¯: <span id="branch-name">--</span></p>
            </div>
            
            <div class="container">
                <!-- å“è³ªæª¢æŸ¥æ‘˜è¦ -->
                <div class="section">
                    <h2>ğŸ“Š å“è³ªæª¢æŸ¥æ‘˜è¦</h2>
                    <div class="quality-score">
                        <div class="score" id="quality-score">--</div>
                        <div id="quality-level">è¼‰å…¥ä¸­...</div>
                    </div>
                    <div class="grid">
                        <div>
                            <h3>æª¢æŸ¥çµæœ</h3>
                            <ul class="checklist" id="quality-checks">
                                <li>ğŸ¥ é†«ç™‚è¡“èªæª¢æŸ¥: <span id="terminology-status">æª¢æŸ¥ä¸­...</span></li>
                                <li>â™¿ ç„¡éšœç¤™æ€§é©—è­‰: <span id="accessibility-status">æª¢æŸ¥ä¸­...</span></li>
                                <li>ğŸ“– å¯è®€æ€§åˆ†æ: <span id="readability-status">æª¢æŸ¥ä¸­...</span></li>
                                <li>ğŸ“š åƒè€ƒæ–‡ç»æª¢æŸ¥: <span id="references-status">æª¢æŸ¥ä¸­...</span></li>
                            </ul>
                        </div>
                        <div>
                            <h3>å¿«é€Ÿæ“ä½œ</h3>
                            <a href="#" class="btn" id="view-content">ğŸ“„ æŸ¥çœ‹å…§å®¹è®Šæ›´</a>
                            <a href="#" class="btn success" id="approve-btn">âœ… æ‰¹å‡†è®Šæ›´</a>
                            <a href="#" class="btn warning" id="request-changes">ğŸ“ è¦æ±‚ä¿®æ”¹</a>
                            <a href="#" class="btn danger" id="reject-btn">âŒ æ‹’çµ•è®Šæ›´</a>
                        </div>
                    </div>
                </div>
                
                <!-- é†«ç™‚å…§å®¹å¯©æ ¸æ¸…å–® -->
                <div class="section">
                    <h2>ğŸ¥ é†«ç™‚å…§å®¹å¯©æ ¸æ¸…å–®</h2>
                    <ul class="checklist">
                        <li>
                            <input type="checkbox" id="medical-accuracy"> 
                            <label for="medical-accuracy">é†«ç™‚è³‡è¨Šæº–ç¢ºæ€§ç¢ºèª</label>
                        </li>
                        <li>
                            <input type="checkbox" id="clinical-guidelines"> 
                            <label for="clinical-guidelines">ç¬¦åˆæœ€æ–°è‡¨åºŠæŒ‡å¼•</label>
                        </li>
                        <li>
                            <input type="checkbox" id="drug-safety"> 
                            <label for="drug-safety">è—¥ç‰©è³‡è¨Šå®‰å…¨æ€§æª¢æŸ¥</label>
                        </li>
                        <li>
                            <input type="checkbox" id="contraindications"> 
                            <label for="contraindications">ç¦å¿Œç—‡å’Œæ³¨æ„äº‹é …å®Œæ•´</label>
                        </li>
                        <li>
                            <input type="checkbox" id="medical-disclaimer"> 
                            <label for="medical-disclaimer">é†«ç™‚å…è²¬è²æ˜é©ç•¶</label>
                        </li>
                        <li>
                            <input type="checkbox" id="professional-review"> 
                            <label for="professional-review">å°ˆç§‘é†«å¸«å¯©æ ¸å®Œæˆ</label>
                        </li>
                    </ul>
                </div>
                
                <!-- å…§å®¹è®Šæ›´è©³æƒ… -->
                <div class="section">
                    <h2>ğŸ“ å…§å®¹è®Šæ›´è©³æƒ…</h2>
                    <div id="content-changes">
                        <p>è¼‰å…¥è®Šæ›´è©³æƒ…ä¸­...</p>
                    </div>
                </div>
                
                <!-- å¯©æ ¸æ„è¦‹ -->
                <div class="section">
                    <h2>ğŸ’¬ å¯©æ ¸æ„è¦‹</h2>
                    <textarea id="review-comments" placeholder="è«‹è¼¸å…¥æ‚¨çš„å¯©æ ¸æ„è¦‹..." style="width: 100%; height: 120px; padding: 10px; border: 1px solid #ddd; border-radius: 4px;"></textarea>
                    <div style="margin-top: 10px;">
                        <button class="btn success" onclick="submitReview('approve')">âœ… æ‰¹å‡†ä¸¦æäº¤æ„è¦‹</button>
                        <button class="btn warning" onclick="submitReview('request_changes')">ğŸ“ è¦æ±‚ä¿®æ”¹</button>
                        <button class="btn" onclick="saveComments()">ğŸ’¾ å„²å­˜æ„è¦‹</button>
                    </div>
                </div>
            </div>
            
            <script>
                // è¼‰å…¥ PR è³‡è¨Š
                async function loadPRInfo() {
                    try {
                        const response = await fetch('/preview-info/info.json');
                        const data = await response.json();
                        
                        document.getElementById('pr-number').textContent = data.pr_number;
                        document.getElementById('branch-name').textContent = data.branch;
                        
                        // è¼‰å…¥è®Šæ›´æª”æ¡ˆ
                        const changedFiles = data.changed_files || [];
                        const changesHtml = changedFiles.map(file => 
                            `<div class="file-diff">ğŸ“„ ${file}</div>`
                        ).join('');
                        document.getElementById('content-changes').innerHTML = changesHtml || '<p>ç„¡å…§å®¹æª”æ¡ˆè®Šæ›´</p>';
                        
                    } catch (error) {
                        console.error('è¼‰å…¥ PR è³‡è¨Šå¤±æ•—:', error);
                    }
                }
                
                // è¼‰å…¥å“è³ªæª¢æŸ¥çµæœ
                async function loadQualityResults() {
                    try {
                        // é€™è£¡æœƒå¾ GitHub Actions çš„çµæœè¼‰å…¥å“è³ªæª¢æŸ¥è³‡æ–™
                        // å¯¦éš›å¯¦ä½œæ™‚éœ€è¦æ•´åˆ GitHub API
                        const mockQuality = {
                            score: 85,
                            level: 'è‰¯å¥½',
                            checks: {
                                terminology: 'passed',
                                accessibility: 'passed',
                                readability: 'warning',
                                references: 'passed'
                            }
                        };
                        
                        document.getElementById('quality-score').textContent = mockQuality.score;
                        document.getElementById('quality-score').className = 'score good';
                        document.getElementById('quality-level').textContent = `å“è³ªç­‰ç´š: ${mockQuality.level}`;
                        
                    } catch (error) {
                        console.error('è¼‰å…¥å“è³ªæª¢æŸ¥çµæœå¤±æ•—:', error);
                    }
                }
                
                // æäº¤å¯©æ ¸æ„è¦‹
                function submitReview(action) {
                    const comments = document.getElementById('review-comments').value;
                    const checkedItems = Array.from(document.querySelectorAll('input[type="checkbox"]:checked')).map(cb => cb.id);
                    
                    // é€™è£¡æœƒæ•´åˆ GitHub API æäº¤å¯©æ ¸
                    alert(`å¯©æ ¸æ„è¦‹å·²æº–å‚™æäº¤:\nå‹•ä½œ: ${action}\næ„è¦‹: ${comments}\næª¢æŸ¥é …ç›®: ${checkedItems.join(', ')}`);
                }
                
                // å„²å­˜æ„è¦‹
                function saveComments() {
                    const comments = document.getElementById('review-comments').value;
                    localStorage.setItem(`review-comments-pr-${window.location.pathname}`, comments);
                    alert('æ„è¦‹å·²å„²å­˜åˆ°æœ¬åœ°');
                }
                
                // è¼‰å…¥å„²å­˜çš„æ„è¦‹
                function loadSavedComments() {
                    const saved = localStorage.getItem(`review-comments-pr-${window.location.pathname}`);
                    if (saved) {
                        document.getElementById('review-comments').value = saved;
                    }
                }
                
                // åˆå§‹åŒ–
                document.addEventListener('DOMContentLoaded', function() {
                    loadPRInfo();
                    loadQualityResults();
                    loadSavedComments();
                });
            </script>
        </body>
        </html>
        EOF
        
        echo "âœ… å¯©æ ¸è€…ä»‹é¢ç”Ÿæˆå®Œæˆ"

    - name: ä¸Šå‚³å¯©æ ¸è€…ä»‹é¢åˆ°é è¦½ç’°å¢ƒ
      run: |
        echo "ğŸ“¤ ä¸Šå‚³å¯©æ ¸è€…ä»‹é¢..."
        # é€™è£¡æœƒå°‡å¯©æ ¸è€…ä»‹é¢ä¸Šå‚³åˆ°é è¦½ç’°å¢ƒ
        # å¯¦éš›å¯¦ä½œæ™‚éœ€è¦æ•´åˆ Cloudflare Pages API
        echo "âœ… å¯©æ ¸è€…ä»‹é¢å·²ä¸Šå‚³"

  # ç”Ÿæˆå…§å®¹è®Šæ›´æ¯”è¼ƒ
  generate-content-diff:
    runs-on: ubuntu-latest
    needs: build-preview
    if: needs.build-preview.outputs.has-content-changes == 'true'
    name: ğŸ“Š ç”Ÿæˆå…§å®¹è®Šæ›´æ¯”è¼ƒ
    
    steps:
    - name: æª¢å‡ºç¨‹å¼ç¢¼
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: ç”Ÿæˆå…§å®¹è®Šæ›´å ±å‘Š
      run: |
        echo "ğŸ“Š ç”Ÿæˆå…§å®¹è®Šæ›´æ¯”è¼ƒå ±å‘Š..."
        
        # å»ºç«‹è®Šæ›´å ±å‘Šç›®éŒ„
        mkdir -p content-diff
        
        # å–å¾—è®Šæ›´çš„æª”æ¡ˆ
        git diff --name-only origin/main...HEAD -- 'src/content/**/*.md' > changed-files.txt
        
        # ç‚ºæ¯å€‹è®Šæ›´çš„æª”æ¡ˆç”Ÿæˆå·®ç•°å ±å‘Š
        while IFS= read -r file; do
          if [ -f "$file" ]; then
            echo "è™•ç†æª”æ¡ˆ: $file"
            
            # ç”Ÿæˆæª”æ¡ˆå·®ç•°
            filename=$(basename "$file" .md)
            git diff origin/main...HEAD -- "$file" > "content-diff/${filename}.diff"
            
            # ç”Ÿæˆ HTML æ ¼å¼çš„å·®ç•°å ±å‘Š
            cat > "content-diff/${filename}.html" << EOF
        <!DOCTYPE html>
        <html lang="zh-TW">
        <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>å…§å®¹è®Šæ›´: ${filename}</title>
            <style>
                body { font-family: monospace; margin: 20px; background: #f8f9fa; }
                .diff-container { background: white; padding: 20px; border-radius: 8px; }
                .diff-line { padding: 2px 5px; }
                .diff-add { background: #d4edda; color: #155724; }
                .diff-remove { background: #f8d7da; color: #721c24; }
                .diff-context { background: #f8f9fa; }
                .file-header { background: #343a40; color: white; padding: 10px; margin-bottom: 20px; }
            </style>
        </head>
        <body>
            <div class="file-header">
                <h1>ğŸ“„ ${file}</h1>
                <p>å…§å®¹è®Šæ›´æ¯”è¼ƒ</p>
            </div>
            <div class="diff-container">
                <pre id="diff-content">è¼‰å…¥ä¸­...</pre>
            </div>
            <script>
                fetch('./${filename}.diff')
                    .then(response => response.text())
                    .then(diff => {
                        const lines = diff.split('\\n');
                        const html = lines.map(line => {
                            if (line.startsWith('+')) {
                                return '<div class="diff-line diff-add">' + line + '</div>';
                            } else if (line.startsWith('-')) {
                                return '<div class="diff-line diff-remove">' + line + '</div>';
                            } else {
                                return '<div class="diff-line diff-context">' + line + '</div>';
                            }
                        }).join('');
                        document.getElementById('diff-content').innerHTML = html;
                    });
            </script>
        </body>
        </html>
        EOF
          fi
        done < changed-files.txt
        
        echo "âœ… å…§å®¹è®Šæ›´æ¯”è¼ƒå ±å‘Šç”Ÿæˆå®Œæˆ"

    - name: ä¸Šå‚³è®Šæ›´æ¯”è¼ƒå ±å‘Š
      uses: actions/upload-artifact@v3
      with:
        name: content-diff-report
        path: content-diff/
        retention-days: 30

  # è¨­å®šæ¸¬è©¦è³‡æ–™
  setup-test-data:
    runs-on: ubuntu-latest
    needs: build-preview
    name: ğŸ§ª è¨­å®šæ¸¬è©¦è³‡æ–™
    
    steps:
    - name: æª¢å‡ºç¨‹å¼ç¢¼
      uses: actions/checkout@v4

    - name: ç”Ÿæˆæ¸¬è©¦è³‡æ–™
      run: |
        echo "ğŸ§ª ç”Ÿæˆæ¸¬è©¦è³‡æ–™..."
        
        # å»ºç«‹æ¸¬è©¦è³‡æ–™ç›®éŒ„
        mkdir -p test-data
        
        # ç”Ÿæˆç¯„ä¾‹é†«ç™‚å…§å®¹
        cat > test-data/sample-cardiology.md << 'EOF'
        ---
        title: "æ¸¬è©¦ç”¨å¿ƒè‡Ÿç§‘æ–‡ç« "
        specialty: "cardiology"
        status: "draft"
        author: "æ¸¬è©¦ä½œè€…"
        reviewers: ["cardiology-reviewer"]
        version: "1.0"
        lastUpdated: "2024-01-30"
        tags: ["å¿ƒè‡Ÿç—…", "é é˜²", "æ¸¬è©¦"]
        ---
        
        # æ¸¬è©¦ç”¨å¿ƒè‡Ÿç§‘æ–‡ç« 
        
        é€™æ˜¯ä¸€ç¯‡ç”¨æ–¼æ¸¬è©¦é è¦½ç’°å¢ƒçš„å¿ƒè‡Ÿç§‘æ–‡ç« ã€‚
        
        ## ç—‡ç‹€
        
        å¸¸è¦‹ç—‡ç‹€åŒ…æ‹¬ï¼š
        - èƒ¸ç—›
        - å‘¼å¸å›°é›£
        - å¿ƒæ‚¸
        
        ## æ²»ç™‚
        
        è«‹éµé†«å›‘é€²è¡Œæ²»ç™‚ã€‚
        
        ## åƒè€ƒæ–‡ç»
        
        1. æ¸¬è©¦åƒè€ƒæ–‡ç». å¿ƒè‡Ÿç§‘æœŸåˆŠ. 2024;1(1):1-10.
        EOF
        
        # ç”Ÿæˆæ¸¬è©¦ç”¨çš„å°ˆç§‘é…ç½®
        cat > test-data/test-specialty.json << 'EOF'
        {
          "name": "æ¸¬è©¦å°ˆç§‘",
          "code": "test",
          "description": "ç”¨æ–¼æ¸¬è©¦çš„å°ˆç§‘åˆ†é¡",
          "reviewers": ["test-reviewer"],
          "requiredFields": ["title", "content"],
          "templates": ["test-template"],
          "qualityChecks": {
            "terminology": true,
            "accessibility": true,
            "readability": true,
            "references": true
          }
        }
        EOF
        
        echo "âœ… æ¸¬è©¦è³‡æ–™ç”Ÿæˆå®Œæˆ"

    - name: ä¸Šå‚³æ¸¬è©¦è³‡æ–™
      uses: actions/upload-artifact@v3
      with:
        name: test-data
        path: test-data/
        retention-days: 7

  # é€šçŸ¥å’Œè©•è«–
  notify-preview-ready:
    runs-on: ubuntu-latest
    needs: [build-preview, create-reviewer-interface, generate-content-diff]
    if: always() && needs.build-preview.result == 'success'
    name: ğŸ“¢ é€šçŸ¥é è¦½å°±ç·’
    
    steps:
    - name: å»ºç«‹ PR è©•è«–
      uses: actions/github-script@v6
      with:
        script: |
          const previewUrl = '${{ needs.build-preview.outputs.preview-url }}';
          const hasContentChanges = '${{ needs.build-preview.outputs.has-content-changes }}' === 'true';
          
          let comment = `## ğŸ” PR é è¦½ç’°å¢ƒå·²å°±ç·’
          
          **é è¦½ URL**: ${previewUrl}
          
          ### ğŸ“‹ é è¦½åŠŸèƒ½
          
          - ğŸ  [ä¸»è¦ç¶²ç«™é è¦½](${previewUrl})
          - âš™ï¸ [CMS ç®¡ç†ä»‹é¢](${previewUrl}/admin)
          - ğŸ“Š [é è¦½è³‡è¨Šé é¢](${previewUrl}/preview-info)`;
          
          if (hasContentChanges) {
            comment += `
          - ğŸ‘¥ [å¯©æ ¸è€…å°ˆç”¨ä»‹é¢](${previewUrl}/reviewer-interface)
          - ğŸ“„ [å…§å®¹è®Šæ›´æ¯”è¼ƒ](${previewUrl}/content-diff)
          
          ### ğŸ¥ é†«ç™‚å…§å®¹å¯©æ ¸
          
          æ­¤ PR åŒ…å«é†«ç™‚å…§å®¹è®Šæ›´ï¼Œè«‹ç›¸é—œå¯©æ ¸è€…ï¼š
          
          1. **é†«ç™‚å°ˆæ¥­å¯©æ ¸**: è«‹æª¢æŸ¥é†«ç™‚è³‡è¨Šæº–ç¢ºæ€§
          2. **å…§å®¹å“è³ªå¯©æ ¸**: è«‹æª¢æŸ¥èªè¨€è¡¨é”å’Œæ ¼å¼
          3. **æŠ€è¡“å¯©æ ¸**: è«‹ç¢ºèªæ‰€æœ‰è‡ªå‹•åŒ–æª¢æŸ¥é€šé
          
          ### ğŸ“Š å“è³ªæª¢æŸ¥ç‹€æ…‹
          
          å“è³ªæª¢æŸ¥æ­£åœ¨é€²è¡Œä¸­ï¼Œçµæœå°‡åœ¨å®Œæˆå¾Œæ›´æ–°åˆ°æ­¤è©•è«–ã€‚`;
          } else {
            comment += `
          
          ### â„¹ï¸ è®Šæ›´èªªæ˜
          
          æ­¤ PR ä¸åŒ…å«é†«ç™‚å…§å®¹è®Šæ›´ï¼Œä¸»è¦ç‚ºç³»çµ±é…ç½®æˆ–ä»‹é¢èª¿æ•´ã€‚`;
          }
          
          comment += `
          
          ### ğŸ”§ æ¸¬è©¦æŒ‡å—
          
          1. **åŠŸèƒ½æ¸¬è©¦**: è«‹æ¸¬è©¦ç›¸é—œåŠŸèƒ½æ˜¯å¦æ­£å¸¸é‹ä½œ
          2. **å…§å®¹æª¢æŸ¥**: è«‹ç¢ºèªå…§å®¹é¡¯ç¤ºæ­£ç¢º
          3. **éŸ¿æ‡‰å¼æ¸¬è©¦**: è«‹åœ¨ä¸åŒè£ç½®ä¸Šæ¸¬è©¦
          4. **ç„¡éšœç¤™æ€§æ¸¬è©¦**: è«‹ä½¿ç”¨è¢å¹•é–±è®€å™¨ç­‰å·¥å…·æ¸¬è©¦
          
          ---
          
          *é è¦½ç’°å¢ƒå°‡åœ¨ PR åˆä½µæˆ–é—œé–‰å¾Œè‡ªå‹•æ¸…ç† ğŸ¤–*`;
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: comment
          });

    - name: æ·»åŠ é è¦½æ¨™ç±¤
      uses: actions/github-script@v6
      with:
        script: |
          const labels = ['preview-ready'];
          
          if ('${{ needs.build-preview.outputs.has-content-changes }}' === 'true') {
            labels.push('needs-medical-review');
            labels.push('has-content-changes');
          }
          
          github.rest.issues.addLabels({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            labels: labels
          });

  # æ¸…ç†é è¦½ç’°å¢ƒ
  cleanup-preview:
    runs-on: ubuntu-latest
    if: github.event.action == 'closed'
    name: ğŸ§¹ æ¸…ç†é è¦½ç’°å¢ƒ
    
    steps:
    - name: æ¸…ç† Cloudflare Pages é è¦½
      run: |
        echo "ğŸ§¹ æ¸…ç†é è¦½ç’°å¢ƒ..."
        echo "PR #${{ github.event.number }} å·²é—œé–‰ï¼Œé è¦½ç’°å¢ƒå°‡è¢«æ¸…ç†"
        
        # å¯¦éš›å¯¦ä½œæ™‚æœƒå‘¼å« Cloudflare API æ¸…ç†é è¦½éƒ¨ç½²
        # curl -X DELETE "https://api.cloudflare.com/client/v4/accounts/$ACCOUNT_ID/pages/projects/$PROJECT_NAME/deployments/$DEPLOYMENT_ID"
        
        echo "âœ… é è¦½ç’°å¢ƒæ¸…ç†å®Œæˆ"

    - name: æ›´æ–° PR è©•è«–
      uses: actions/github-script@v6
      with:
        script: |
          const comment = `## ğŸ§¹ é è¦½ç’°å¢ƒå·²æ¸…ç†
          
          PR #${{ github.event.number }} å·²é—œé–‰ï¼Œç›¸é—œçš„é è¦½ç’°å¢ƒå·²è¢«æ¸…ç†ã€‚
          
          æ„Ÿè¬æ‚¨çš„è²¢ç»ï¼ ğŸ‰`;
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: comment
          });